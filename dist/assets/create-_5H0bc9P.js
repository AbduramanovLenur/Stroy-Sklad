import{_ as pe,u as me,a as be,r as v,c,B as ve,m as p,o as d,d as g,e as F,t as m,F as T,C,A as w,D as h,f as I,k as _,K as Ne,q as Ue,b as ze,y as De,z as $,h as u,w as He,i as ce,l as xe,s as ue,H as Ge,J as x,E as Qe}from"./index-zkjpq5my.js";import{u as Re,r as M}from"./i18n-validators-UGKONhRL.js";import{a as Je,u as We}from"./generic.services-wx_DtCHh.js";import{u as B}from"./useQuery-copJlXh0.js";import{c as Xe}from"./crud.services-8TgOaY3n.js";import{f as Ye,g as Ze,h as ea,i as aa,j as oa}from"./manual.services-LRvKoYix.js";import{v as la}from"./v4-yQnnJER4.js";const ta={class:"application-form"},sa={class:"application-form__title"},ra={class:"application-form__overlay form-manage"},na={__name:"ApplicationForm",props:["selects","buildingBlockId","isSubmit"],emits:["onAddTable"],setup(E,{emit:t}){const i=me(),{t:O}=be(),P=E,q=t,s=v({floorId:[],costId:[],constructionMaterialId:[],count:""}),L=c(()=>P.buildingBlockId);ve(L,()=>{s.value.floorId=[]});const f=v([{id:1,model:"count",label:"countAppLabel",placeholder:"countAppPlaceholder",icon:"list"}]),K=()=>{if(!Ne(s.value)){i.error(O("isEmptyModal"));return}s.value={floorId:s.value.floorId[0],costId:s.value.costId[0],constructionMaterialId:s.value.constructionMaterialId[0],count:s.value.count,price:s.value.price},q("onAddTable",s.value),s.value=Ue(s.value)};return(o,G)=>{const n=p("FormSelect"),j=p("FormInput"),N=p("CustomButton");return d(),g("div",ta,[F("h4",sa,m(o.$t("appInfo")),1),F("div",ra,[(d(!0),g(T,null,C(E.selects,l=>(d(),w(n,{key:l.id,modelValue:s.value[l.model],"onUpdate:modelValue":b=>s.value[l.model]=b,width:500,options:l.options,placeholder:l==null?void 0:l.placeholder,success:l.success,loading:l.loading,isMultiSelect:l==null?void 0:l.multiple},{default:h(()=>[I(m(o.$t(l.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","options","placeholder","success","loading","isMultiSelect"]))),128)),(d(!0),g(T,null,C(f.value,l=>(d(),w(j,{key:l.id,modelValue:s.value[l.model],"onUpdate:modelValue":b=>s.value[l.model]=b,width:500,placeholder:o.$t(l.placeholder),name:l.icon,type:l==null?void 0:l.type},{default:h(()=>[I(m(o.$t(l.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","name","type"]))),128)),_(N,{className:"form__submit",type:"button",onClick:K},{default:h(()=>[I(m(o.$t("addButtonForm")),1)]),_:1})])])}}},ia=pe(na,[["__scopeId","data-v-f2cfa771"]]),da={key:0,class:"manage section-height shadowed"},ca={class:"manage__inner section-padding"},ua={class:"manage__overlay"},pa={key:0,class:"error"},ma={__name:"create",async setup(E){let t,i;const O=Je(),P=xe();me(),be();const q=ze(),{user:s}=De(q),L=c(()=>{var e,r;return!!((r=(e=s==null?void 0:s.value.user)==null?void 0:e.modules)!=null&&r.includes(Ge.APPLICATION.CREATE))}),f=v(!1),K=v([{id:1,label:"appFloor",width:15},{id:2,label:"appMaterial",width:30},{id:3,label:"appCount",width:15},{id:4,label:"appPrice",width:20}]),o=v({deadline:"",buildingObjectId:[],buildingBlockId:[],createApplicationTables:[],details:""}),G=c(()=>({deadline:{required:M},buildingObjectId:{required:M},buildingBlockId:{required:M},createApplicationTables:{required:M},details:{required:M}})),n=Re(G,o),{data:j,isSuccess:N,isLoading:l}=([t,i]=$(()=>B({queryKey:["objectsList",{organizationId:s.value.user.organizationId}],queryFn:()=>Ye(),enabled:L})),t=await t,i(),t),b=c(()=>o.value.buildingObjectId),ge=c(()=>!!b.value.length);ve(b,()=>{f.value||(o.value.buildingBlockId=[])},{immediate:!0});const{data:he,isSuccess:Ie,isLoading:_e}=([t,i]=$(()=>B({queryKey:["blocksList",{blockId:b}],queryFn:()=>aa(b.value),enabled:ge})),t=await t,i(),t),U=c(()=>o.value.buildingBlockId),z=c(()=>!!U.value.length),{data:Q,isSuccess:fe,isLoading:ye}=([t,i]=$(()=>B({queryKey:["floorsList",{floorId:U}],queryFn:()=>oa(U.value),enabled:z})),t=await t,i(),t),{data:R,isSuccess:Ae,isLoading:ke}=([t,i]=$(()=>B({queryKey:["costsList",{organizationId:s.value.user.organizationId}],queryFn:()=>Ze(),enabled:z})),t=await t,i(),t),{data:J,isSuccess:Ve,isLoading:Se}=([t,i]=$(()=>B({queryKey:["materialsList",{organizationId:s.value.user.organizationId}],queryFn:()=>ea(),enabled:z})),t=await t,i(),t),$e=v([{id:1,model:"deadline",label:"dateAppLabel",placeholder:"dateAppPlaceholder",icon:"date",errorKey:"deadline",type:"date"}]),Me=v([{id:1,model:"buildingObjectId",label:"objectAppLabel",placeholder:"objectAppPlaceholder",errorKey:"buildingObjectId",options:j,success:N,loading:l},{id:2,model:"buildingBlockId",label:"blockAppLabel",placeholder:"blockAppPlaceholder",errorKey:"buildingBlockId",options:he,success:Ie,loading:_e}]),Be=v([{id:1,model:"floorId",label:"floorsAppLabel",placeholder:"floorsAppPlaceholder",options:Q,success:fe,loading:ye},{id:2,model:"costId",label:"costAppLabel",placeholder:"costAppPlaceholder",options:R,success:Ae,loading:ke},{id:3,model:"constructionMaterialId",label:"materialsAppLabel",placeholder:"materialsAppPlaceholder",options:J,success:Ve,loading:Se}]),Fe=c(()=>x(Q.value)),Le=c(()=>x(R.value)),Te=c(()=>x(J.value)),Ce=e=>{var r;return(r=Fe.value[e.floorId])==null?void 0:r.name},we=e=>{var r;return(r=Le.value[e.costId])==null?void 0:r.name},Ee=e=>{var r;return(r=Te.value[e==null?void 0:e.constructionMaterialId])==null?void 0:r.name},Oe=e=>{o.value.createApplicationTables.push({...e,delId:la(),floorValue:Ce(e),costValue:we(e),constructionMaterialValue:Ee(e)})},Pe=e=>{o.value.createApplicationTables=o.value.createApplicationTables.filter(r=>r.delId!==e)},{mutate:qe}=We({onMutate:e=>{f.value=!0,e.buildingObjectId=e.buildingObjectId[0],e.buildingBlockId=e.buildingBlockId[0],e.createApplicationTables=e.createApplicationTables.map(r=>{const{delId:W,floorValue:X,costValue:Y,constructionMaterialValue:Z,...D}=r;return D})},mutationFn:e=>Xe("application",e),onSuccess:e=>{o.value=Qe(o.value),O.invalidateQueries({queryKey:["applications"]}),P.push(ue.APPLICATION.path)}}),Ke=()=>{if(n.value.$validate(),n.value.$errors.length)return;const e={...o.value};qe(e),n.value.$reset()};return(e,r)=>{var ee,ae,oe,le,te,se,re,ne,ie,de;const W=p("ManageHead"),X=p("FormInput"),Y=p("FormSelect"),Z=p("SubTable"),D=p("FormTextarea"),je=p("CustomButton");return L.value?(d(),g("section",da,[F("div",ca,[_(W,{title:"addNewApplicationTitle",to:u(ue).APPLICATION.path},null,8,["to"]),F("form",{class:"manage__form",onSubmit:He(Ke,["prevent"])},[F("div",ua,[(d(!0),g(T,null,C($e.value,a=>{var y,A,k,V,S;return d(),w(X,{key:a.id,modelValue:o.value[a.model],"onUpdate:modelValue":H=>o.value[a.model]=H,modelModifiers:{trim:!0},width:500,placeholder:e.$t(a.placeholder),name:a.icon,error:(A=(y=u(n))==null?void 0:y[a.errorKey])==null?void 0:A.$error,textError:(S=(V=(k=u(n))==null?void 0:k[a.errorKey])==null?void 0:V.$errors[0])==null?void 0:S.$message,type:a==null?void 0:a.type},{default:h(()=>[I(m(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","name","error","textError","type"])}),128)),(d(!0),g(T,null,C(Me.value,a=>{var y,A,k,V,S;return d(),w(Y,{key:a.id,modelValue:o.value[a.model],"onUpdate:modelValue":H=>o.value[a.model]=H,modelModifiers:{trim:!0},width:500,options:a.options,error:(A=(y=u(n))==null?void 0:y[a==null?void 0:a.errorKey])==null?void 0:A.$error,placeholder:a==null?void 0:a.placeholder,textError:(S=(V=(k=u(n))==null?void 0:k[a==null?void 0:a.errorKey])==null?void 0:V.$errors[0])==null?void 0:S.$message,success:a.success,loading:a.loading,isMultiSelect:a==null?void 0:a.multiple},{default:h(()=>[I(m(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","options","error","placeholder","textError","success","loading","isMultiSelect"])}),128))]),_(ia,{selects:Be.value,buildingBlockId:o.value.buildingBlockId,isSubmit:f.value,onOnAddTable:Oe},null,8,["selects","buildingBlockId","isSubmit"]),(ae=(ee=u(n))==null?void 0:ee.createApplicationTables)!=null&&ae.$error?(d(),g("span",pa,m((te=(le=(oe=u(n))==null?void 0:oe.createApplicationTables)==null?void 0:le.$errors[0])==null?void 0:te.$message),1)):ce("",!0),_(Z,{headers:K.value,table:o.value.createApplicationTables,onOnActionDelete:Pe,isShowDelete:!0},null,8,["headers","table"]),_(D,{modelValue:o.value.details,"onUpdate:modelValue":r[0]||(r[0]=a=>o.value.details=a),modelModifiers:{trim:!0},width:500,placeholder:e.$t("appCommentPlaceholder"),error:(re=(se=u(n))==null?void 0:se.details)==null?void 0:re.$error,textError:(de=(ie=(ne=u(n))==null?void 0:ne.details)==null?void 0:ie.$errors[0])==null?void 0:de.$message},{default:h(()=>[I(m(e.$t("appCommentLabel")),1)]),_:1},8,["modelValue","placeholder","error","textError"]),_(je,{className:"manage__submit"},{default:h(()=>[I(m(e.$t("appButton")),1)]),_:1})],32)])])):ce("",!0)}}},ya=pe(ma,[["__scopeId","data-v-023e0dd9"]]);export{ya as default};
