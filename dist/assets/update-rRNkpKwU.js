import{_ as ma,u as ba,a as ga,b as va,x as pa,c as d,r as n,y as _,B as H,d as m,e as K,k as N,h as o,w as ha,F as j,C as x,D as L,t as b,i as g,z as k,l as Ia,E as ya,m as E,o as r,A as G,f as w,H as fa,G as _a,I as P}from"./index-JvbhfmnW.js";import{E as ka}from"./EstimateForm-K-Qv4RV9.js";import{u as Ea,r as S}from"./i18n-validators-pdrHvBMx.js";import{a as Sa,u as Va}from"./generic.services-nPQjChLr.js";import{u as V}from"./useQuery-83Oo_vnt.js";import{a as $a,u as Ta}from"./crud.services-ysnFdDpK.js";import{f as Ma,g as La,h as wa,i as Ca,j as Ba,b as Fa}from"./manual.services-jHvvpFhH.js";import{v as R}from"./v4-yQnnJER4.js";const Oa={key:0,class:"manage section-height shadowed"},qa={class:"manage__inner section-padding"},Ka={class:"manage__overlay"},ja={key:0,class:"manage__title"},xa={key:1,class:"manage__blocks"},Pa=["onClick"],Ua={key:4,class:"error"},Aa={__name:"update",async setup(za){let l,i;const Q=Sa(),W=Ia(),Be=ya(),Fe=ba(),{t:Oe}=ga(),qe=va(),{user:$}=pa(qe),F=d(()=>{var e,t;return!!((t=(e=$==null?void 0:$.value.user)==null?void 0:e.modules)!=null&&t.includes(_a.ESTIMATE.CREATE))}),U=n(Be.params.id),Ke=n([{id:1,label:"estimateBlock",width:200},{id:2,label:"estimateFloor",width:200},{id:3,label:"estimateMaterial",width:260},{id:4,label:"estimateBudget",width:200},{id:5,label:"estimateCost"}]),s=n({id:"",fullname:"",buildingObjectId:[],price:"",budgetTables:[],details:"",stateId:[]}),J=n(!1),A=n(!1),c=n(""),T=n([]),je=d(()=>T.value.filter(e=>+e.blockId==+c.value)),xe=d(()=>({id:{required:S},fullname:{required:S},buildingObjectId:{required:S},price:{required:S},budgetTables:{required:S},details:{required:S},stateId:{required:S}})),u=Ea(xe,s),{data:Pe,isSuccess:Ue,isLoading:Ae}=([l,i]=_(()=>V({queryKey:["objectsList",{organizationId:$.value.user.organizationId}],queryFn:()=>Ma(),enabled:F})),l=await l,i(),l),O=d(()=>s.value.buildingObjectId),ze=d(()=>!!O.value.length);H(O,()=>{!A.value&&!J.value&&(s.value.budgetTables=[],T.value=[],c.value=""),A.value=!1},{immediate:!0});const{data:v,isSuccess:X,isLoading:De}=([l,i]=_(()=>V({queryKey:["blocksList",{blockId:O}],queryFn:()=>Ca(O.value[0]),enabled:ze})),l=await l,i(),l),z=d(()=>c.value),D=d(()=>!!z.value),{data:Y,isSuccess:He,isLoading:Ne}=([l,i]=_(()=>V({queryKey:["floorsList",{floorId:z}],queryFn:()=>Ba(z.value),enabled:D})),l=await l,i(),l),{data:Z,isSuccess:Ge,isLoading:Re}=([l,i]=_(()=>V({queryKey:["costsList",{organizationId:$.value.user.organizationId}],queryFn:()=>La(),enabled:D})),l=await l,i(),l),{data:ee,isSuccess:Qe,isLoading:We}=([l,i]=_(()=>V({queryKey:["materialsList",{organizationId:$.value.user.organizationId}],queryFn:()=>wa(),enabled:D})),l=await l,i(),l),{data:Je,isSuccess:Xe,isLoading:Ye}=([l,i]=_(()=>V({queryKey:["states"],queryFn:()=>Fa(),enabled:F})),l=await l,i(),l),Ze=n([{id:1,model:"fullname",label:"nameEstimateLabel",placeholder:"nameEstimatePlaceholder",icon:"input-company",errorKey:"fullname"}]),ea=n([{id:1,model:"buildingObjectId",label:"objectEstimateLabel",placeholder:"objectEstimatePlaceholder",errorKey:"buildingObjectId",options:Pe,success:Ue,loading:Ae}]),aa=n([{id:1,model:"floorId",label:"floorsEstimateLabel",placeholder:"floorsEstimatePlaceholder",options:Y,success:He,loading:Ne},{id:2,model:"costId",label:"costEstimateLabel",placeholder:"costEstimatePlaceholder",options:Z,success:Ge,loading:Re},{id:3,model:"constructionMaterailIds",label:"materialsEstimateLabel",placeholder:"materialsEstimatePlaceholder",options:ee,success:Qe,loading:We,multiple:!0}]),ta=n([{id:1,model:"details",label:"estimateCommentLabel",placeholder:"estimateCommentPlaceholder",errorKey:"details"}]),ae=d(()=>P(v.value||[])),te=d(()=>P(Y.value||[])),le=d(()=>P(Z.value||[])),se=d(()=>P(ee.value||[])),oe=e=>{var t;return(t=ae.value[e.buildingBlockId])==null?void 0:t.name},re=e=>{var t;return(t=te.value[e.floorId])==null?void 0:t.name},ue=e=>{var t;return(t=le.value[e.costId])==null?void 0:t.name},ie=e=>{var t;return(t=e.constructionMaterailIds)==null?void 0:t.map((M,q)=>{var C;return{id:q+1,name:((C=se.value[M])==null?void 0:C.name)||"Unknown Material"}})},de=d(()=>s.value.budgetTables.length&&Object.keys(ae.value).length&&Object.keys(te.value).length&&Object.keys(le.value).length&&Object.keys(se.value).length),la=e=>{if(de){T.value.push({delId:R(),blockValue:oe(e),blockId:e.buildingBlockId,floorValue:re(e),costValue:ue(e),constructionMaterialIdsValue:ie(e),price:e.price}),s.value.budgetTables.push({delId:R(),...e}),s.value.price=+s.value.price+ +e.price;return}Fe.error(Oe("estimateEmptyData"))},ne=n(!0);H(de,e=>{e&&ne.value&&(s.value.budgetTables.forEach(t=>{T.value.push({delId:R(),blockValue:oe(t),blockId:t.buildingBlockId,floorValue:re(t),costValue:ue(t),constructionMaterialIdsValue:ie(t),price:t.price})}),ne.value=!1)},{immediate:!0});const sa=e=>{s.value.budgetTables=s.value.budgetTables.filter(t=>t.delId!==e),T.value=T.value.filter(t=>t.delId!==e)},{isError:oa}=([l,i]=_(()=>V({queryKey:["budgetsById",U],queryFn:()=>$a("budget",U.value),select:e=>{s.value.id=e.id,s.value.fullname=e.fullname,s.value.buildingObjectId=[e.buildingObjectId],s.value.price=e.price,s.value.budgetTables=[...e.budgetTables],s.value.details=e.details,s.value.stateId=[e.stateId],A.value=!0},enabled:F})),l=await l,i(),l);H(oa,e=>{e&&W.push(G.HOME.path)});const{mutate:ra}=Va({onMutate:e=>{J.value=!0,e.budgetTables=e.budgetTables.map(t=>{let M={...t};return delete M.delId,M}),e.buildingObjectId=e.buildingObjectId[0],e.stateId=e.stateId[0]},mutationFn:e=>Ta("budget",e),onSuccess:()=>{Q.invalidateQueries({queryKey:["budgets"]}),Q.invalidateQueries({queryKey:["budgetsById",U]}),W.push(G.ESTIMATE.path)}}),ua=()=>{u.value.$validate(),!u.value.$errors.length&&(ra(s.value),u.value.$reset())};return(e,t)=>{var ce,me,be,ge,ve,pe,he,Ie,ye,fe,_e,ke,Ee,Se,Ve,$e,Te,Me,Le,we,Ce;const M=E("ManageHead"),q=E("FormInput"),C=E("FormSelect"),ia=E("Spinner"),da=E("SubTable"),na=E("FormTextarea"),ca=E("CustomButton");return F.value?(r(),m("section",Oa,[K("div",qa,[N(M,{title:"addNewEstimateTitle",to:o(G).ESTIMATE.path},null,8,["to"]),K("form",{class:"manage__form",onSubmit:ha(ua,["prevent"])},[K("div",Ka,[(r(!0),m(j,null,x(Ze.value,a=>{var p,h,I,y,f;return r(),k(q,{key:a.id,modelValue:s.value[a.model],"onUpdate:modelValue":B=>s.value[a.model]=B,width:500,placeholder:e.$t(a.placeholder),name:a.icon,error:(h=(p=o(u))==null?void 0:p[a.errorKey])==null?void 0:h.$error,textError:(f=(y=(I=o(u))==null?void 0:I[a.errorKey])==null?void 0:y.$errors[0])==null?void 0:f.$message},{default:L(()=>[w(b(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","name","error","textError"])}),128)),(r(!0),m(j,null,x(ea.value,a=>{var p,h,I,y,f;return r(),k(C,{key:a.id,modelValue:s.value[a.model],"onUpdate:modelValue":B=>s.value[a.model]=B,modelModifiers:{trim:!0},width:500,options:a.options,error:(h=(p=o(u))==null?void 0:p[a==null?void 0:a.errorKey])==null?void 0:h.$error,placeholder:a==null?void 0:a.placeholder,textError:(f=(y=(I=o(u))==null?void 0:I[a==null?void 0:a.errorKey])==null?void 0:y.$errors[0])==null?void 0:f.$message,success:a.success,loading:a.loading},{default:L(()=>[w(b(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","options","error","placeholder","textError","success","loading"])}),128)),N(q,{modelValue:s.value.price,"onUpdate:modelValue":t[0]||(t[0]=a=>s.value.price=a),width:500,placeholder:e.$t("estimatePricePlaceholder"),name:"money",error:(me=(ce=o(u))==null?void 0:ce.price)==null?void 0:me.$error,textError:(ve=(ge=(be=o(u))==null?void 0:be.price)==null?void 0:ge.$errors[0])==null?void 0:ve.$message,isDisabled:!0},{default:L(()=>[w(b(e.$t("estimatePriceLabel")),1)]),_:1},8,["modelValue","placeholder","error","textError"]),N(C,{modelValue:s.value.stateId,"onUpdate:modelValue":t[1]||(t[1]=a=>s.value.stateId=a),modelModifiers:{trim:!0},width:500,options:o(Je),error:(he=(pe=o(u))==null?void 0:pe.stateId)==null?void 0:he.$error,placeholder:"estimateStatePlaceholder",textError:(fe=(ye=(Ie=o(u))==null?void 0:Ie.stateId)==null?void 0:ye.$errors[0])==null?void 0:fe.$message,success:o(Xe),loading:o(Ye)},{default:L(()=>[w(b(e.$t("estimateStateLabel")),1)]),_:1},8,["modelValue","options","error","textError","success","loading"])]),o(X)&&((_e=o(v))!=null&&_e.length)?(r(),m("h3",ja,b(e.$t("blockEstimateLabel")),1)):g("",!0),o(X)&&((ke=o(v))!=null&&ke.length)?(r(),m("ul",xa,[(r(!0),m(j,null,x(o(v),a=>(r(),m("li",{key:a.id,class:"manage__block",onClick:()=>c.value=a.id},[K("div",{class:fa(`manage__block-box ${c.value===a.id?"is-active":""}`)},b(a.name),3)],8,Pa))),128))])):g("",!0),o(De)?(r(),k(ia,{key:2})):g("",!0),c.value&&((Ee=o(v))!=null&&Ee.length)?(r(),k(ka,{key:3,selects:aa.value,blockId:c.value,onOnAddTable:la,onOnChangeBlock:t[2]||(t[2]=a=>c.value=a)},null,8,["selects","blockId"])):g("",!0),(Ve=(Se=o(u))==null?void 0:Se.budgetTables)!=null&&Ve.$error?(r(),m("span",Ua,b((Me=(Te=($e=o(u))==null?void 0:$e.budgetTables)==null?void 0:Te.$errors[0])==null?void 0:Me.$message),1)):g("",!0),c.value&&((Le=o(v))!=null&&Le.length)?(r(),k(da,{key:5,headers:Ke.value,table:je.value,onOnActionDelete:sa,isShowDelete:!0},null,8,["headers","table"])):g("",!0),c.value&&((we=o(v))!=null&&we.length)?(r(!0),m(j,{key:6},x(ta.value,a=>{var p,h,I,y,f;return r(),k(na,{key:a.id,modelValue:s.value[a.model],"onUpdate:modelValue":B=>s.value[a.model]=B,modelModifiers:{trim:!0},width:500,placeholder:e.$t(a.placeholder),error:(h=(p=o(u))==null?void 0:p[a.errorKey])==null?void 0:h.$error,textError:(f=(y=(I=o(u))==null?void 0:I[a.errorKey])==null?void 0:y.$errors[0])==null?void 0:f.$message},{default:L(()=>[w(b(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","error","textError"])}),128)):g("",!0),c.value&&((Ce=o(v))!=null&&Ce.length)?(r(),k(ca,{key:7,className:"manage__submit"},{default:L(()=>[w(b(e.$t("formButton")),1)]),_:1})):g("",!0)],32)])])):g("",!0)}}},Xa=ma(Aa,[["__scopeId","data-v-85e2362d"]]);export{Xa as default};
//# sourceMappingURL=update-rRNkpKwU.js.map
