import{_ as ca,u as ma,a as ba,b as ga,y as va,c as n,r as c,z as I,B as U,d as p,e as O,k as D,h as o,w as pa,F as H,C as N,D as E,t as m,i as b,A as h,l as Ia,G as ha,m as f,o as u,s as G,f as V,I as fa,H as ya,J as j,E as _a}from"./index-8l2LyLh8.js";import{E as ka}from"./EstimateForm-y0Esqkcq.js";import{u as Ea,r as y}from"./i18n-validators-Wkg5KBML.js";import{a as Va,u as Sa}from"./generic.services-yETqkf3T.js";import{u as _}from"./useQuery-tdqJaMO0.js";import{a as Ta,u as $a}from"./crud.services-BcMjcvoI.js";import{f as Ma,g as wa,h as La,i as Ca,j as Fa,b as Ba}from"./manual.services-Ls971AW1.js";import{v as Be}from"./v4-yQnnJER4.js";const Oa={key:0,class:"manage section-height shadowed"},ja={class:"manage__inner section-padding"},qa={class:"manage__overlay"},Ka={key:0,class:"manage__title"},za={key:1,class:"manage__blocks"},Pa=["onClick"],xa={key:3,class:"error"},Aa={__name:"update",async setup(Ua){let l,i;const R=Va(),Q=Ia(),Oe=ha(),je=ma(),{t:qe}=ba(),Ke=ga(),{user:g}=va(Ke),C=n(()=>{var e,t;return!!((t=(e=g==null?void 0:g.value.user)==null?void 0:e.modules)!=null&&t.includes(ya.ESTIMATE.CREATE))}),q=c(Oe.params.id),ze=c([{id:1,label:"estimateBlock",width:15},{id:2,label:"estimateFloor",width:20},{id:3,label:"estimateMaterial",width:25},{id:4,label:"estimateBudget",width:20},{id:5,label:"estimateCost",width:20}]),s=c({id:"",fullname:"",buildingObjectId:[],price:"",budgetTables:[],details:"",stateId:[]}),J=c(!1),K=c(!1),d=c(""),Pe=n(()=>s.value.budgetTables.filter(e=>+e.buildingBlockId==+d.value)),xe=n(()=>({id:{required:y},fullname:{required:y},buildingObjectId:{required:y},price:{required:y},budgetTables:{required:y},details:{required:y},stateId:{required:y}})),r=Ea(xe,s),{data:Ae,isSuccess:Ue,isLoading:De}=([l,i]=I(()=>_({queryKey:["objectsList",{organizationId:g.value.user.organizationId}],queryFn:()=>Ma(),enabled:C})),l=await l,i(),l),F=n(()=>s.value.buildingObjectId[0]),He=n(()=>!!F.value);U(F,()=>{!K.value&&!J.value&&(s.value.budgetTables=[],d.value=""),K.value=!1},{immediate:!0});const{data:B,isSuccess:W,isLoading:Ne}=([l,i]=I(()=>_({queryKey:["blocksList",{objectId:F,organizationId:g.value.user.organizationId}],queryFn:()=>wa(F.value),enabled:He})),l=await l,i(),l),z=n(()=>d.value),P=n(()=>!!z.value),{data:X,isSuccess:Ge,isLoading:Re}=([l,i]=I(()=>_({queryKey:["floorsList",{blockId:z,organizationId:g.value.user.organizationId}],queryFn:()=>La(z.value),enabled:P})),l=await l,i(),l),{data:Y,isSuccess:Qe,isLoading:Je}=([l,i]=I(()=>_({queryKey:["costsList",{organizationId:g.value.user.organizationId}],queryFn:()=>Ca(),enabled:P})),l=await l,i(),l),{data:Z,isSuccess:We,isLoading:Xe}=([l,i]=I(()=>_({queryKey:["materialsList",{organizationId:g.value.user.organizationId}],queryFn:()=>Fa(),enabled:P})),l=await l,i(),l),{data:Ye,isSuccess:Ze,isLoading:ea}=([l,i]=I(()=>_({queryKey:["states"],queryFn:()=>Ba(),enabled:C})),l=await l,i(),l),aa=c([{id:1,model:"fullname",label:"nameEstimateLabel",placeholder:"nameEstimatePlaceholder",icon:"input-company",errorKey:"fullname"}]),ta=c([{id:1,model:"buildingObjectId",label:"objectEstimateLabel",placeholder:"objectEstimatePlaceholder",errorKey:"buildingObjectId",options:Ae,success:Ue,loading:De}]),sa=c([{id:1,model:"floorId",label:"floorsEstimateLabel",placeholder:"floorsEstimatePlaceholder",options:X,success:Ge,loading:Re},{id:2,model:"costId",label:"costEstimateLabel",placeholder:"costEstimatePlaceholder",options:Y,success:Qe,loading:Je},{id:3,model:"constructionMaterailIds",label:"materialsEstimateLabel",placeholder:"materialsEstimatePlaceholder",options:Z,success:We,loading:Xe,multiple:!0}]),ee=n(()=>j(B.value||[])),ae=n(()=>j(X.value||[])),te=n(()=>j(Y.value||[])),se=n(()=>j(Z.value||[])),le=e=>{var t;return(t=ee.value[e.buildingBlockId])==null?void 0:t.name},oe=e=>{var t;return(t=ae.value[e.floorId])==null?void 0:t.name},re=e=>{var t;return(t=te.value[e.costId])==null?void 0:t.name},ue=e=>{var t;return(t=e.constructionMaterailIds)==null?void 0:t.map((v,S)=>{var k;return{id:S+1,name:((k=se.value[v])==null?void 0:k.name)||"Unknown Material"}})},la=n(()=>!!(s.value.budgetTables.length&&Object.keys(ee.value).length&&Object.keys(ae.value).length&&Object.keys(te.value).length&&Object.keys(se.value).length)),ie=c(!0);U(la,e=>{e&&ie.value&&(s.value.budgetTables=s.value.budgetTables.map(t=>({...t,delId:Be(),blockValue:le(t),floorValue:oe(t),costValue:re(t),constructionMaterialIdsValue:ue(t)})),ie.value=!1)},{immediate:!0});const oa=e=>{s.value.budgetTables.push({...e,delId:Be(),blockValue:le(e),floorValue:oe(e),costValue:re(e),constructionMaterialIdsValue:ue(e)}),s.value.price=+s.value.price+e.price},ra=e=>{s.value.budgetTables=s.value.budgetTables.filter(t=>{const v=t.delId!==e;return v||(s.value.price-=t.price),v})},{isError:ua}=([l,i]=I(()=>_({queryKey:["budgetById",q],queryFn:()=>Ta("budget",q.value),select:e=>{s.value.id=e.id,s.value.fullname=e.fullname,s.value.buildingObjectId=[e.buildingObjectId],s.value.price=e.price,s.value.budgetTables=[...e.budgetTables],s.value.details=e.details,s.value.stateId=[e.stateId],K.value=!0},enabled:C})),l=await l,i(),l);U(ua,e=>{e&&Q.push(G.HOME.path)});const{mutate:ia}=Sa({onMutate:e=>{J.value=!0,e.budgetTables=e.budgetTables.map(t=>{const{delId:v,blockValue:S,floorValue:k,costValue:ne,constructionMaterialIdsValue:de,...x}=t;return x}),e.buildingObjectId=e.buildingObjectId[0],e.stateId=e.stateId[0]},mutationFn:e=>$a("budget",e),onSuccess:e=>{e!=null&&e.success&&(s.value=_a(s.value),R.invalidateQueries({queryKey:["budgets"]}),R.invalidateQueries({queryKey:["budgetById",q]}),Q.push(G.ESTIMATE.path),setTimeout(()=>je.success(qe("updateToast")),150))}}),na=()=>{if(r.value.$validate(),r.value.$errors.length)return;const e={...s.value};ia(e),r.value.$reset()};return(e,t)=>{var ce,me,be,ge,ve,pe,Ie,he,fe,ye,_e,ke,Ee,Ve,Se,Te,$e,Me,we,Le,Ce,Fe;const v=f("ManageHead"),S=f("FormInput"),k=f("FormSelect"),ne=f("SubTable"),de=f("FormTextarea"),x=f("CustomButton"),da=f("Spinner");return C.value?(u(),p("section",Oa,[O("div",ja,[D(v,{title:"addNewEstimateTitle",to:o(G).ESTIMATE.path},null,8,["to"]),O("form",{class:"manage__form",onSubmit:pa(na,["prevent"])},[O("div",qa,[(u(!0),p(H,null,N(aa.value,a=>{var T,$,M,w,L;return u(),h(S,{key:a.id,modelValue:s.value[a.model],"onUpdate:modelValue":A=>s.value[a.model]=A,width:500,placeholder:e.$t(a.placeholder),name:a.icon,error:($=(T=o(r))==null?void 0:T[a.errorKey])==null?void 0:$.$error,textError:(L=(w=(M=o(r))==null?void 0:M[a.errorKey])==null?void 0:w.$errors[0])==null?void 0:L.$message},{default:E(()=>[V(m(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","name","error","textError"])}),128)),(u(!0),p(H,null,N(ta.value,a=>{var T,$,M,w,L;return u(),h(k,{key:a.id,modelValue:s.value[a.model],"onUpdate:modelValue":A=>s.value[a.model]=A,modelModifiers:{trim:!0},width:500,options:a.options,error:($=(T=o(r))==null?void 0:T[a==null?void 0:a.errorKey])==null?void 0:$.$error,placeholder:a==null?void 0:a.placeholder,textError:(L=(w=(M=o(r))==null?void 0:M[a==null?void 0:a.errorKey])==null?void 0:w.$errors[0])==null?void 0:L.$message,success:a.success,loading:a.loading},{default:E(()=>[V(m(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","options","error","placeholder","textError","success","loading"])}),128)),D(S,{modelValue:s.value.price,"onUpdate:modelValue":t[0]||(t[0]=a=>s.value.price=a),width:500,placeholder:e.$t("estimatePricePlaceholder"),name:"money",error:(me=(ce=o(r))==null?void 0:ce.price)==null?void 0:me.$error,textError:(ve=(ge=(be=o(r))==null?void 0:be.price)==null?void 0:ge.$errors[0])==null?void 0:ve.$message,isDisabled:!0},{default:E(()=>[V(m(e.$t("estimatePriceLabel")),1)]),_:1},8,["modelValue","placeholder","error","textError"]),D(k,{modelValue:s.value.stateId,"onUpdate:modelValue":t[1]||(t[1]=a=>s.value.stateId=a),modelModifiers:{trim:!0},width:500,options:o(Ye),error:(Ie=(pe=o(r))==null?void 0:pe.stateId)==null?void 0:Ie.$error,placeholder:"estimateStatePlaceholder",textError:(ye=(fe=(he=o(r))==null?void 0:he.stateId)==null?void 0:fe.$errors[0])==null?void 0:ye.$message,success:o(Ze),loading:o(ea)},{default:E(()=>[V(m(e.$t("estimateStateLabel")),1)]),_:1},8,["modelValue","options","error","textError","success","loading"])]),o(W)&&((_e=o(B))!=null&&_e.length)?(u(),p("h3",Ka,m(e.$t("blockEstimateLabel")),1)):b("",!0),o(W)&&((ke=o(B))!=null&&ke.length)?(u(),p("ul",za,[(u(!0),p(H,null,N(o(B),a=>(u(),p("li",{key:a.id,class:"manage__block",onClick:()=>d.value=a.id},[O("div",{class:fa(`manage__block-box ${d.value===a.id?"is-active":""}`)},m(a.name),3)],8,Pa))),128))])):b("",!0),d.value?(u(),h(ka,{key:2,selects:sa.value,blockId:d.value,onOnAddTable:oa,onOnChangeBlock:t[2]||(t[2]=a=>d.value=a)},null,8,["selects","blockId"])):b("",!0),(Ve=(Ee=o(r))==null?void 0:Ee.budgetTables)!=null&&Ve.$error?(u(),p("span",xa,m(($e=(Te=(Se=o(r))==null?void 0:Se.budgetTables)==null?void 0:Te.$errors[0])==null?void 0:$e.$message),1)):b("",!0),d.value?(u(),h(ne,{key:4,headers:ze.value,table:Pe.value,onOnActionDelete:ra,isShowDelete:!0},null,8,["headers","table"])):b("",!0),d.value?(u(),h(de,{key:5,modelValue:s.value.details,"onUpdate:modelValue":t[3]||(t[3]=a=>s.value.details=a),modelModifiers:{trim:!0},width:500,placeholder:e.$t("estimateCommentPlaceholder"),error:(we=(Me=o(r))==null?void 0:Me.details)==null?void 0:we.$error,textError:(Fe=(Ce=(Le=o(r))==null?void 0:Le.details)==null?void 0:Ce.$errors[0])==null?void 0:Fe.$message},{default:E(()=>[V(m(e.$t("estimateCommentLabel")),1)]),_:1},8,["modelValue","placeholder","error","textError"])):b("",!0),d.value?(u(),h(x,{key:6,className:"manage__submit"},{default:E(()=>[V(m(e.$t("formButton")),1)]),_:1})):b("",!0)],32),o(Ne)?(u(),h(da,{key:0})):b("",!0)])])):b("",!0)}}},Xa=ca(Aa,[["__scopeId","data-v-0ae16c06"]]);export{Xa as default};
