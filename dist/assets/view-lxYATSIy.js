import{_ as ee,c as u,o as n,d as b,e as c,t as r,F as P,C as $,I as qe,p as Pe,n as $e,u as Ne,a as Ke,r as w,b as De,y as Re,z as g,B as Y,k as He,h,w as ze,A as m,i as v,D as y,ah as Ee,l as Ue,G as Qe,m as f,s as M,f as A,H as j,J as q}from"./index-4OOvqjps.js";import{a as Ge,u as Z}from"./generic.services-cM7RLDwf.js";import{u as k}from"./useQuery-k2tfLaah.js";import{a as We,e as xe,f as Je}from"./crud.services-NECAoUBm.js";import{f as Xe,g as Ye,h as Ze,i as ea,j as aa}from"./manual.services-SGmJYzSL.js";const ta=_=>(Pe("data-v-28fb4607"),_=_(),$e(),_),sa={class:"histories"},la={class:"histories__label"},oa={class:"histories__list"},ia={class:"histories__head"},na={class:"histories__name"},ua=ta(()=>c("div",{class:"histories__divider"}," - ",-1)),ca={class:"histories__status"},da={class:"histories__date"},ra={__name:"Histories",props:["histories"],setup(_){const t=u(()=>i=>{let p=new Date(i),a=p.toISOString().split("T")[0],T=p.toISOString().split("T")[1].split(".")[0];return`${a} ${T}`});return(i,p)=>(n(),b("div",sa,[c("div",la,r(i.$t("historiesLabel")),1),c("ul",oa,[(n(!0),b(P,null,$(_.histories,a=>(n(),b("li",{key:a.id,class:"histories__item"},[c("div",{class:qe(`histories__box ${(a==null?void 0:a.statusId)===1?"created":(a==null?void 0:a.statusId)===7?"accepted":(a==null?void 0:a.statusId)===20?"expected":(a==null?void 0:a.statusId)===15?"refused":""}`)},[c("div",ia,[c("div",na,r(a==null?void 0:a.userName),1),ua,c("div",ca,r(a==null?void 0:a.status),1)]),c("div",da,r(t.value(a==null?void 0:a.createdDate)),1)],2)]))),128))])]))}},pa=ee(ra,[["__scopeId","data-v-28fb4607"]]),ma={key:0,class:"manage section-height shadowed"},va={class:"manage__inner section-padding"},ba={class:"manage__overlay"},_a={key:3,class:"manage__triggers"},Ia={__name:"view",async setup(_){let t,i;const p=Ge(),a=Ue(),T=Qe(),N=Ne(),{t:K}=Ke(),I=w(T.params.id),ae=De(),{user:d}=Re(ae),V=u(()=>{var e,o;return!!((o=(e=d==null?void 0:d.value.user)==null?void 0:e.modules)!=null&&o.includes(j.APPLICATION.READ))}),te=w([{id:1,label:"appFloor",width:20},{id:2,label:"appMaterial",width:30},{id:3,label:"appCount",width:20},{id:4,label:"appPrice",width:30}]),s=w({id:"",deadline:"",buildingObjectId:[],buildingBlockId:[],applicationTables:[],details:"",statusId:"",allowedActionRoleIds:[],histories:[]}),{data:se,isSuccess:le,isLoading:oe}=([t,i]=g(()=>k({queryKey:["objectsList",{organizationId:d.value.user.organizationId}],queryFn:()=>Xe(),enabled:V})),t=await t,i(),t),C=u(()=>s.value.buildingObjectId),ie=u(()=>{var e;return!!((e=C.value)!=null&&e.length)}),{data:ne,isSuccess:ue,isLoading:ce}=([t,i]=g(()=>k({queryKey:["blocksList",{blockId:C}],queryFn:()=>ea(C.value),enabled:ie})),t=await t,i(),t),O=u(()=>s.value.buildingBlockId),B=u(()=>{var e;return!!((e=O.value)!=null&&e.length)}),{data:de,isSuccess:re,isLoading:pe}=([t,i]=g(()=>k({queryKey:["floorsList",{floorId:O}],queryFn:()=>aa(O.value),enabled:B})),t=await t,i(),t),{data:me,isSuccess:ve,isLoading:be}=([t,i]=g(()=>k({queryKey:["costsList",{organizationId:d.value.user.organizationId}],queryFn:()=>Ye(),enabled:B})),t=await t,i(),t),{data:_e,isSuccess:Ie,isLoading:ge}=([t,i]=g(()=>k({queryKey:["materialsList",{organizationId:d.value.user.organizationId}],queryFn:()=>Ze(),enabled:B})),t=await t,i(),t),L=u(()=>!!(ve&&Ie&&re&&s.value.applicationTables.every(e=>e.floorValue&&e.costValue&&e.constructionMaterialValue))),he=u(()=>!!(be.value||ge.value||pe.value||!s.value.applicationTables.every(e=>e.floorValue&&e.costValue&&e.constructionMaterialValue))),fe=w([{id:1,model:"deadline",label:"dateAppLabel",placeholder:"dateAppPlaceholder",icon:"date",errorKey:"deadline",type:"date"}]),ke=w([{id:1,model:"buildingObjectId",label:"objectAppLabel",placeholder:"objectAppPlaceholder",errorKey:"buildingObjectId",options:se,success:le,loading:oe},{id:2,model:"buildingBlockId",label:"blockAppLabel",placeholder:"blockAppPlaceholder",errorKey:"buildingBlockId",options:ne,success:ue,loading:ce}]),{isError:Se}=([t,i]=g(()=>k({queryKey:["applicationsById",I],queryFn:()=>We("application",I.value),select:e=>{s.value.id=e.id,s.value.deadline=e.deadline,s.value.buildingObjectId=[e.buildingObjectId],s.value.buildingBlockId=[e.buildingBlockId],s.value.applicationTables=[...e.applicationTables],s.value.details=e.details,s.value.statusId=e.statusId,s.value.allowedActionRoleIds=e.allowedActionRoleIds,s.value.histories=e.applicationHistories},enabled:V})),t=await t,i(),t),D=u(()=>q(de.value||[])),R=u(()=>q(me.value||[])),H=u(()=>q(_e.value||[])),we=e=>{var o;return(o=D.value[e.floorId])==null?void 0:o.name},ye=e=>{var o;return(o=R.value[e.costId])==null?void 0:o.name},Ae=e=>{var o;return(o=H.value[e==null?void 0:e.constructionMaterialId])==null?void 0:o.name},Le=u(()=>{var e,o,S;return((e=Object.keys(D.value))==null?void 0:e.length)&&((o=Object.keys(R.value))==null?void 0:o.length)&&((S=Object.keys(H.value))==null?void 0:S.length)});Y(Le,e=>{e&&(s.value.applicationTables=s.value.applicationTables.map(o=>({...o,floorValue:we(o),costValue:ye(o),constructionMaterialValue:Ae(o)})))},{immediate:!0}),Y(Se,e=>{e&&a.push(M.HOME.path)});const{mutate:Me}=Z({mutationFn:e=>xe("application",e),onSuccess:e=>{e!=null&&e.success&&(p.invalidateQueries({queryKey:["applications"]}),p.invalidateQueries({queryKey:["applicationsById",I]}),a.push(M.APPLICATION.path),setTimeout(()=>N.success(K("cancelToast")),150))}}),{mutate:Te}=Z({mutationFn:e=>Je("application",e),onSuccess:e=>{e!=null&&e.success&&(p.invalidateQueries({queryKey:["applications"]}),p.invalidateQueries({queryKey:["applicationsById",I]}),a.push(M.APPLICATION.path),setTimeout(()=>N.success(K("acceptToast")),150))}}),Ve=()=>{Me(I.value)},Ce=()=>{Te(I.value)};return(e,o)=>{var E,U,Q,G,W,x,J,X;const S=f("ManageHead"),Oe=f("FormInput"),Be=f("FormSelect"),Fe=f("SubTable"),je=f("Spinner"),z=f("MyButton");return V.value?(n(),b("section",ma,[c("div",va,[He(S,{title:"addNewApplicationTitle",to:h(M).APPLICATION.path},null,8,["to"]),c("form",{class:"manage__form",onSubmit:o[1]||(o[1]=ze(()=>{},["prevent"]))},[c("div",ba,[(n(!0),b(P,null,$(fe.value,l=>(n(),m(Oe,{key:l.id,modelValue:s.value[l.model],"onUpdate:modelValue":F=>s.value[l.model]=F,width:500,placeholder:e.$t(l.placeholder),name:l.icon,type:l==null?void 0:l.type,isDisabled:!0},{default:y(()=>[A(r(e.$t(l.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","name","type"]))),128)),(n(!0),b(P,null,$(ke.value,l=>(n(),m(Be,{key:l.id,modelValue:s.value[l.model],"onUpdate:modelValue":F=>s.value[l.model]=F,modelModifiers:{trim:!0},width:500,options:l.options,placeholder:l==null?void 0:l.placeholder,success:l.success,loading:l.loading,isMultiSelect:l==null?void 0:l.multiple,isDisabled:!0},{default:y(()=>[A(r(e.$t(l.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","options","placeholder","success","loading","isMultiSelect"]))),128))]),L.value?(n(),m(Fe,{key:0,headers:te.value,table:s.value.applicationTables},null,8,["headers","table"])):v("",!0),he.value?(n(),m(je,{key:1})):v("",!0),L.value?(n(),m(Ee,{key:2,modelValue:s.value.details,"onUpdate:modelValue":o[0]||(o[0]=l=>s.value.details=l),modelModifiers:{trim:!0},width:500,placeholder:e.$t("appCommentPlaceholder"),isDisabled:!0},{default:y(()=>[A(r(e.$t("appCommentLabel")),1)]),_:1},8,["modelValue","placeholder"])):v("",!0),L.value&&s.value.statusId!==7&&s.value.statusId!==15&&s.value.allowedActionRoleIds.includes((U=(E=h(d))==null?void 0:E.user)==null?void 0:U.roleId)?(n(),b("div",_a,[(W=(G=(Q=h(d))==null?void 0:Q.user)==null?void 0:G.modules)!=null&&W.includes(h(j).APPLICATION.CONFIRM)?(n(),m(z,{key:0,icon:"approve",type:"submit",color:"green",width:180,onClick:Ce},{default:y(()=>[A(r(e.$t("acceptButton")),1)]),_:1})):v("",!0),(X=(J=(x=h(d))==null?void 0:x.user)==null?void 0:J.modules)!=null&&X.includes(h(j).APPLICATION.REFUSAL)?(n(),m(z,{key:1,icon:"refusal",type:"submit",color:"red",width:180,onClick:Ve},{default:y(()=>[A(r(e.$t("cancelButton")),1)]),_:1})):v("",!0)])):v("",!0)],32),L.value?(n(),m(pa,{key:0,histories:s.value.histories},null,8,["histories"])):v("",!0)])])):v("",!0)}}},wa=ee(Ia,[["__scopeId","data-v-875125bf"]]);export{wa as default};
