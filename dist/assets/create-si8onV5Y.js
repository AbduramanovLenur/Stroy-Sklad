import{_ as Re,u as Je,a as We,b as Xe,y as Ye,c,r as _,z as y,C as Ze,d as b,e as $,k as ea,h as l,w as aa,F as O,D as ce,t as v,i as d,B as g,A as F,l as ta,m as h,o as r,s as de,f as C,I as sa,H as oa,J as w,E as la}from"./index-bESyHmKb.js";import{E as ra}from"./EstimateForm-Wg1MphRi.js";import{c as na}from"./crud.services-z-7dMtvc.js";import{f as ua,g as ia,h as ca,i as da,j as ma}from"./manual.services-XwGTQWk9.js";import{u as ba,r as k}from"./i18n-validators-JP3nhFWN.js";import{u as pa}from"./generic.services-WkEajj6v.js";import{u as E}from"./useQuery-1aHXDk8s.js";import{u as va}from"./useMutation-pOycABst.js";import{v as ga}from"./v4-yQnnJER4.js";const ha={key:0,class:"manage section-height shadowed"},_a={class:"manage__inner section-padding"},Ia={class:"manage__overlay"},ya={key:0,class:"manage__title"},ka={key:1,class:"manage__blocks"},Ea=["onClick"],Sa={key:4,class:"error"},Va={__name:"create",async setup(Ma){let s,m;const me=pa(),be=ta(),pe=Je(),{t:ve}=We(),ge=Xe(),{user:n}=Ye(ge),S=c(()=>{var e,t;return!!((t=(e=n==null?void 0:n.value.user)==null?void 0:e.modules)!=null&&t.includes(oa.ESTIMATE.CREATE))}),he=_([{id:1,label:"estimateBlock",width:15},{id:2,label:"estimateFloor",width:20},{id:3,label:"estimateMaterial",width:25},{id:4,label:"estimateBudget",width:20},{id:5,label:"estimateCost",width:20}]),o=_({fullname:"",buildingObjectId:[],price:"",tables:[],details:""}),K=_(!1),u=_(""),_e=c(()=>o.value.tables.filter(e=>+e.buildingBlockId==+u.value)),Ie=c(()=>({fullname:{required:k},buildingObjectId:{required:k},price:{required:k},tables:{required:k},details:{required:k}})),i=ba(Ie,o),{data:ye,isSuccess:ke,isLoading:Ee}=([s,m]=y(()=>E({queryKey:["objectsList",{organizationId:n.value.user.organizationId,name:n.value.user.fullName}],queryFn:()=>ua(),enabled:S})),s=await s,m(),s),V=c(()=>o.value.buildingObjectId[0]),Se=c(()=>!!V.value);Ze(V,()=>{K.value||(o.value.tables=[],u.value="")},{immediate:!0});const{data:M,isSuccess:f,isLoading:Ve}=([s,m]=y(()=>E({queryKey:["blocksList",{objectId:V,organizationId:n.value.user.organizationId,name:n.value.user.fullName}],queryFn:()=>ia(V.value),enabled:Se})),s=await s,m(),s),B=c(()=>u.value),Me=c(()=>!!B.value),{data:j,isSuccess:Le,isLoading:$e}=([s,m]=y(()=>E({queryKey:["floorsList",{blockId:B,organizationId:n.value.user.organizationId,name:n.value.user.fullName}],queryFn:()=>ca(B.value),enabled:Me})),s=await s,m(),s),{data:z,isSuccess:Fe,isLoading:Ce}=([s,m]=y(()=>E({queryKey:["costsList",{organizationId:n.value.user.organizationId,name:n.value.user.fullName}],queryFn:()=>da(),enabled:S})),s=await s,m(),s),{data:N,isSuccess:we,isLoading:Be}=([s,m]=y(()=>E({queryKey:["materialsList",{organizationId:n.value.user.organizationId,name:n.value.user.fullName}],queryFn:()=>ma(),enabled:S})),s=await s,m(),s),Te=_([{id:1,model:"fullname",label:"nameEstimateLabel",placeholder:"nameEstimatePlaceholder",icon:"input-company",errorKey:"fullname"},{id:2,model:"buildingObjectId",label:"objectEstimateLabel",placeholder:"objectEstimatePlaceholder",errorKey:"buildingObjectId",options:ye,success:ke,loading:Ee,select:!0},{id:3,model:"price",label:"estimatePriceLabel",placeholder:"estimatePricePlaceholder",icon:"money",errorKey:"price",isDisabled:!0}]),qe=_([{id:1,model:"floorId",label:"floorsEstimateLabel",placeholder:"floorsEstimatePlaceholder",options:j,success:Le,loading:$e,select:!0},{id:2,model:"costId",label:"costEstimateLabel",placeholder:"costEstimatePlaceholder",options:z,success:Fe,loading:Ce,select:!0},{id:3,model:"constructionMaterailIds",label:"materialsEstimateLabel",placeholder:"materialsEstimatePlaceholder",options:N,success:we,loading:Be,multiple:!0,select:!0},{id:4,model:"price",label:"priceEstimateLabel",placeholder:"priceEstimatePlaceholder",icon:"money"}]),Oe=c(()=>w(M.value||[])),Ke=c(()=>w(j.value||[])),fe=c(()=>w(z.value||[])),je=c(()=>w(N.value||[])),ze=e=>{var t;return(t=Oe.value[e.buildingBlockId])==null?void 0:t.name},Ne=e=>{var t;return(t=Ke.value[e.floorId])==null?void 0:t.name},Pe=e=>{var t;return(t=fe.value[e.costId])==null?void 0:t.name},De=e=>{var t;return(t=e.constructionMaterailIds)==null?void 0:t.map((p,L)=>{var I;return{id:L+1,name:((I=je.value[p])==null?void 0:I.name)||"Unknown Material"}})},xe=e=>{o.value.tables.push({...e,delId:ga(),blockValue:ze(e),floorValue:Ne(e),costValue:Pe(e),constructionMaterialIdsValue:De(e)}),o.value.price=+o.value.price+e.price},Ae=e=>{o.value.tables=o.value.tables.filter(t=>{const p=t.delId!==e;return p||(o.value.price-=t.price),p})},{mutate:Ue,status:He}=va({onMutate:e=>{K.value=!0,e.tables=e.tables.map(t=>{const{delId:p,blockValue:L,floorValue:I,costValue:P,constructionMaterialIdsValue:D,...T}=t;return T}),e.buildingObjectId=e.buildingObjectId[0]},mutationFn:e=>na("budget",e),onSuccess:e=>{e!=null&&e.success&&(o.value=la(o.value),me.invalidateQueries({queryKey:["budgets"]}),be.push(de.ESTIMATE.path),setTimeout(()=>pe.success(ve("createToast")),150))}}),Ge=()=>{if(i.value.$validate(),i.value.$errors.length)return;const e={...o.value};Ue(e),i.value.$reset()};return(e,t)=>{var x,A,U,H,G,Q,R,J,W,X,Y,Z;const p=h("ManageHead"),L=h("FormInput"),I=h("FormSelect"),P=h("Spinner"),D=h("SubTable"),T=h("FormTextarea"),Qe=h("CustomButton");return S.value?(r(),b("section",ha,[$("div",_a,[ea(p,{title:"addNewEstimateTitle",to:l(de).ESTIMATE.path},null,8,["to"]),$("form",{class:"manage__form",onSubmit:aa(Ge,["prevent"])},[$("div",Ia,[(r(!0),b(O,null,ce(Te.value,a=>{var ee,ae,te,se,oe,le,re,ne,ue,ie;return r(),b(O,{key:a.id},[a!=null&&a.select?d("",!0):(r(),g(L,{key:0,modelValue:o.value[a.model],"onUpdate:modelValue":q=>o.value[a.model]=q,placeholder:e.$t(a.placeholder),name:a.icon,error:(ae=(ee=l(i))==null?void 0:ee[a.errorKey])==null?void 0:ae.$error,textError:(oe=(se=(te=l(i))==null?void 0:te[a.errorKey])==null?void 0:se.$errors[0])==null?void 0:oe.$message,isDisabled:a==null?void 0:a.isDisabled},{default:F(()=>[C(v(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","name","error","textError","isDisabled"])),a!=null&&a.select?(r(),g(I,{key:1,modelValue:o.value[a.model],"onUpdate:modelValue":q=>o.value[a.model]=q,modelModifiers:{trim:!0},options:a.options,error:(re=(le=l(i))==null?void 0:le[a==null?void 0:a.errorKey])==null?void 0:re.$error,placeholder:a==null?void 0:a.placeholder,textError:(ie=(ue=(ne=l(i))==null?void 0:ne[a==null?void 0:a.errorKey])==null?void 0:ue.$errors[0])==null?void 0:ie.$message,success:a.success,loading:a.loading},{default:F(()=>[C(v(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","options","error","placeholder","textError","success","loading"])):d("",!0)],64)}),128))]),l(f)&&((x=l(M))!=null&&x.length)?(r(),b("h3",ya,v(e.$t("blockEstimateLabel")),1)):d("",!0),l(f)&&((A=l(M))!=null&&A.length)?(r(),b("ul",ka,[(r(!0),b(O,null,ce(l(M),a=>(r(),b("li",{key:a.id,class:"manage__block",onClick:()=>u.value=a.id},[$("div",{class:sa(`manage__block-box ${u.value===a.id?"is-active":""}`)},v(a.name),3)],8,Ea))),128))])):d("",!0),l(Ve)?(r(),g(P,{key:2})):d("",!0),u.value?(r(),g(ra,{key:3,subFields:qe.value,blockId:u.value,onOnAddTable:xe,onOnChangeBlock:t[0]||(t[0]=a=>u.value=a)},null,8,["subFields","blockId"])):d("",!0),(H=(U=l(i))==null?void 0:U.tables)!=null&&H.$error?(r(),b("span",Sa,v((R=(Q=(G=l(i))==null?void 0:G.tables)==null?void 0:Q.$errors[0])==null?void 0:R.$message),1)):d("",!0),u.value?(r(),g(D,{key:5,headers:he.value,table:_e.value,onOnActionDelete:Ae,isShowDelete:!0},null,8,["headers","table"])):d("",!0),u.value?(r(),g(T,{key:6,modelValue:o.value.details,"onUpdate:modelValue":t[1]||(t[1]=a=>o.value.details=a),modelModifiers:{trim:!0},width:500,placeholder:e.$t("estimateCommentPlaceholder"),error:(W=(J=l(i))==null?void 0:J.details)==null?void 0:W.$error,textError:(Z=(Y=(X=l(i))==null?void 0:X.details)==null?void 0:Y.$errors[0])==null?void 0:Z.$message},{default:F(()=>[C(v(e.$t("estimateCommentLabel")),1)]),_:1},8,["modelValue","placeholder","error","textError"])):d("",!0),u.value?(r(),g(Qe,{key:7,className:"manage__submit",disabled:l(He)==="pending"},{default:F(()=>[C(v(e.$t("formButton")),1)]),_:1},8,["disabled"])):d("",!0)],32)])])):d("",!0)}}},Ka=Re(Va,[["__scopeId","data-v-68203807"]]);export{Ka as default};
