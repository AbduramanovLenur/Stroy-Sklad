import{_ as U,o as d,d as p,e as i,L as Pe,t as c,w as ne,I as ie,c as r,F as R,D as ue,p as Fe,n as Ne,u as Ve,a as je,r as b,b as qe,y as Ke,z as S,ai as ze,C as De,k as f,h as k,A as _,aj as te,B as w,i as I,l as He,G as Re,m as O,s as A,f as g,H as D,J as H}from"./index-Bee0eIFu.js";import{a as Ue,e as Ee,f as Qe}from"./crud.services-wQgdXoj4.js";import{f as Ge,g as We,h as Je,i as Xe,j as Ye}from"./manual.services-YOtkPLe4.js";import{u as Ze}from"./generic.services-G3ATixRD.js";import{u as L}from"./useQuery-wCvH6pxH.js";import{u as oe}from"./useMutation-uVamgMOE.js";const xe={class:"confirmation-modal__title"},ea={class:"confirmation-modal__triggers"},aa={__name:"ConfirmationModal",props:["isOpen"],setup(m){return(a,n)=>(d(),p("div",{class:ie(`confirmation-modal ${m.isOpen?"is-active":""}`),onClick:n[3]||(n[3]=()=>a.$emit("onNotConfirmed"))},[i("div",{class:"confirmation-modal__overlay",onClick:n[2]||(n[2]=ne(()=>{},["stop"]))},[i("h4",xe,[Pe(a.$slots,"default",{},void 0,!0)]),i("div",ea,[i("button",{type:"button",class:"confirmation-modal__accepted",onClick:n[0]||(n[0]=()=>a.$emit("onConfirmed"))},c(a.$t("yesButton")),1),i("button",{type:"button",class:"confirmation-modal__refused",onClick:n[1]||(n[1]=()=>a.$emit("onNotConfirmed"))},c(a.$t("noButton")),1)])])],2))}},le=U(aa,[["__scopeId","data-v-c25f4d7f"]]),sa=m=>(Fe("data-v-a521117d"),m=m(),Ne(),m),ta={class:"histories"},oa={class:"histories__label"},la={class:"histories__list"},na={class:"histories__head"},ia={class:"histories__name"},ua=sa(()=>i("div",{class:"histories__divider"}," - ",-1)),ca={class:"histories__status"},da={class:"histories__date"},ra={class:"histories__comment"},pa={__name:"Histories",props:["histories"],setup(m){const a=r(()=>n=>{let v=new Date(n),s=v.toISOString().split("T")[0],B=v.toISOString().split("T")[1].split(".")[0];return`${s} ${B}`});return(n,v)=>(d(),p("div",ta,[i("div",oa,c(n.$t("historiesLabel")),1),i("ul",la,[(d(!0),p(R,null,ue(m.histories,s=>(d(),p("li",{key:s.id,class:"histories__item"},[i("div",{class:ie(`histories__box ${(s==null?void 0:s.statusId)===1?"created":(s==null?void 0:s.statusId)===7?"accepted":(s==null?void 0:s.statusId)===20?"expected":(s==null?void 0:s.statusId)===15?"refused":""}`)},[i("div",na,[i("div",ia,c(s==null?void 0:s.userName),1),ua,i("div",ca,c(s==null?void 0:s.status),1)]),i("div",da,c(a.value(s==null?void 0:s.createdDate)),1),i("div",ra,c(s==null?void 0:s.comment),1)],2)]))),128))])]))}},ma=U(pa,[["__scopeId","data-v-a521117d"]]),va={key:0,class:"manage section-height shadowed"},ba={class:"manage__inner section-padding"},_a={class:"manage__overlay"},Ia={class:"manage__textareas"},ga={key:0,class:"manage__triggers"},fa={__name:"view",async setup(m){let a,n;const v=Ze(),s=He(),B=Re(),E=Ve(),{t:Q}=je(),C=b(B.params.id),ce=qe(),{user:u}=Ke(ce),M=r(()=>{var e,l;return(l=(e=u==null?void 0:u.value.user)==null?void 0:e.modules)==null?void 0:l.includes(D.APPLICATION.READ)}),P=b(!1),F=b(!1),de=b([{id:1,label:"appFloor",width:20},{id:2,label:"appMaterial",width:30},{id:3,label:"appCount",width:20},{id:4,label:"appPrice",width:30}]),o=b({id:"",deadline:"",buildingObjectId:[],buildingBlockId:[],applicationTables:[],details:"",comment:"",statusId:"",hasPermission:[],histories:[]}),{data:re,isSuccess:pe,isLoading:me}=([a,n]=S(()=>L({queryKey:["objectsList",{organizationId:u.value.user.organizationId,name:u.value.user.fullName}],queryFn:()=>Ge(),enabled:M})),a=await a,n(),a),N=r(()=>o.value.buildingObjectId[0]),ve=r(()=>!!N.value),{data:be,isSuccess:_e,isLoading:Ie}=([a,n]=S(()=>L({queryKey:["blocksList",{blockId:N,organizationId:u.value.user.organizationId,name:u.value.user.fullName}],queryFn:()=>We(N.value),enabled:ve})),a=await a,n(),a),V=r(()=>o.value.buildingBlockId[0]),ge=r(()=>!!V.value),{data:fe,isSuccess:ka,isLoading:Ca}=([a,n]=S(()=>L({queryKey:["floorsList",{floorId:V,organizationId:u.value.user.organizationId,name:u.value.user.fullName}],queryFn:()=>Je(V.value),enabled:ge})),a=await a,n(),a),{data:ke,isSuccess:ha,isLoading:Sa}=([a,n]=S(()=>L({queryKey:["costsList",{organizationId:u.value.user.organizationId,name:u.value.user.fullName}],queryFn:()=>Xe(),enabled:M})),a=await a,n(),a),{data:Ce,isSuccess:Oa,isLoading:La}=([a,n]=S(()=>L({queryKey:["materialsList",{organizationId:u.value.user.organizationId,name:u.value.user.fullName}],queryFn:()=>Ye(),enabled:M})),a=await a,n(),a),he=b([{id:1,model:"deadline",label:"dateAppLabel",placeholder:"dateAppPlaceholder",icon:"date",errorKey:"deadline",type:"date"},{id:2,model:"buildingObjectId",label:"objectAppLabel",placeholder:"objectAppPlaceholder",errorKey:"buildingObjectId",options:re,success:pe,loading:me,select:!0},{id:3,model:"buildingBlockId",label:"blockAppLabel",placeholder:"blockAppPlaceholder",errorKey:"buildingBlockId",options:be,success:_e,loading:Ie,select:!0}]),{isError:Se}=([a,n]=S(()=>L({queryKey:["applicationsById",C,u.value.user.fullName],queryFn:()=>Ue("application",C.value),select:e=>{o.value.id=e.id,o.value.deadline=e.deadline,o.value.buildingObjectId=[e.buildingObjectId],o.value.buildingBlockId=[e.buildingBlockId],o.value.applicationTables=[...e.applicationTables],o.value.details=e.details,o.value.statusId=e.statusId,o.value.hasPermission=e.hasPermission,o.value.histories=e.applicationHistories},enabled:M})),a=await a,n(),a),G=r(()=>H(fe.value||[])),W=r(()=>H(ke.value||[])),J=r(()=>H(Ce.value||[])),Oe=e=>{var l;return(l=G.value[e.floorId])==null?void 0:l.name},Le=e=>{var l;return(l=W.value[e.costId])==null?void 0:l.name},Me=e=>{var l;return(l=J.value[e==null?void 0:e.constructionMaterialId])==null?void 0:l.name},X=b(!1),Y=b(!0);ze(()=>{var y,T,$;const e=(y=Object.keys(G.value))==null?void 0:y.length,l=(T=Object.keys(W.value))==null?void 0:T.length,j=($=Object.keys(J.value))==null?void 0:$.length,q=o.value.applicationTables.length;e&&l&&j&&q&&(o.value.applicationTables=o.value.applicationTables.map(h=>({...h,floorValue:Oe(h),costValue:Le(h),constructionMaterialValue:Me(h)})),X.value=!0,Y.value=!1)}),De(Se,e=>{e&&s.push(A.APPLICATION.path)});const{mutate:$e,status:we}=oe({mutationFn:e=>Ee("application",e,{comment:o.value.comment}),onSuccess:e=>{e!=null&&e.success&&(v.invalidateQueries({queryKey:["applications"]}),v.invalidateQueries({queryKey:["applicationsById",C]}),s.push(A.APPLICATION.path),setTimeout(()=>E.success(Q("cancelToast")),150))}}),{mutate:ye,status:Te}=oe({mutationFn:e=>Qe("application",e,{comment:o.value.comment}),onSuccess:e=>{e!=null&&e.success&&(v.invalidateQueries({queryKey:["applications"]}),v.invalidateQueries({queryKey:["applicationsById",C]}),s.push(A.APPLICATION.path),setTimeout(()=>E.success(Q("acceptToast")),150))}}),Ae=()=>{$e(C.value)},Be=()=>{ye(C.value)};return(e,l)=>{var K,Z,x,ee,ae,se;const j=O("ManageHead"),q=O("FormInput"),y=O("FormSelect"),T=O("SubTable"),$=O("MyButton"),h=O("Spinner");return M.value?(d(),p("section",va,[i("div",ba,[f(j,{title:"addNewApplicationTitle",to:k(A).APPLICATION.path},null,8,["to"]),X.value?(d(),p("form",{key:0,class:"manage__form",onSubmit:l[4]||(l[4]=ne(()=>{},["prevent"]))},[i("div",_a,[(d(!0),p(R,null,ue(he.value,t=>(d(),p(R,{key:t.id},[t!=null&&t.select?I("",!0):(d(),w(q,{key:0,modelValue:o.value[t.model],"onUpdate:modelValue":z=>o.value[t.model]=z,width:500,placeholder:e.$t(t.placeholder),name:t.icon,type:t==null?void 0:t.type,isDisabled:!0},{default:_(()=>[g(c(e.$t(t.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","name","type"])),t!=null&&t.select?(d(),w(y,{key:1,modelValue:o.value[t.model],"onUpdate:modelValue":z=>o.value[t.model]=z,modelModifiers:{trim:!0},width:500,options:t.options,placeholder:t==null?void 0:t.placeholder,success:t.success,loading:t.loading,isMultiSelect:t==null?void 0:t.multiple,isDisabled:!0},{default:_(()=>[g(c(e.$t(t.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","options","placeholder","success","loading","isMultiSelect"])):I("",!0)],64))),128))]),f(T,{headers:de.value,table:o.value.applicationTables},null,8,["headers","table"]),i("div",Ia,[f(te,{modelValue:o.value.details,"onUpdate:modelValue":l[0]||(l[0]=t=>o.value.details=t),modelModifiers:{trim:!0},width:500,placeholder:e.$t("appDetailsPlaceholder"),isDisabled:!0},{default:_(()=>[g(c(e.$t("appDetailsLabel")),1)]),_:1},8,["modelValue","placeholder"]),f(te,{modelValue:o.value.comment,"onUpdate:modelValue":l[1]||(l[1]=t=>o.value.comment=t),modelModifiers:{trim:!0},width:500,placeholder:e.$t("appCommentPlaceholder"),isDisabled:!o.value.hasPermission},{default:_(()=>[g(c(e.$t("appCommentLabel")),1)]),_:1},8,["modelValue","placeholder","isDisabled"])]),o.value.hasPermission?(d(),p("div",ga,[(x=(Z=(K=k(u))==null?void 0:K.user)==null?void 0:Z.modules)!=null&&x.includes(k(D).APPLICATION.CONFIRM)?(d(),w($,{key:0,icon:"approve",type:"submit",color:"green",width:180,onClick:l[2]||(l[2]=()=>P.value=!0),disabled:k(Te)==="pending"},{default:_(()=>[g(c(e.$t("acceptButton")),1)]),_:1},8,["disabled"])):I("",!0),(se=(ae=(ee=k(u))==null?void 0:ee.user)==null?void 0:ae.modules)!=null&&se.includes(k(D).APPLICATION.REFUSAL)?(d(),w($,{key:1,icon:"refusal",type:"submit",color:"red",width:180,onClick:l[3]||(l[3]=()=>F.value=!0),disabled:k(we)==="pending"},{default:_(()=>[g(c(e.$t("cancelButton")),1)]),_:1},8,["disabled"])):I("",!0)])):I("",!0),f(ma,{histories:o.value.histories},null,8,["histories"])],32)):I("",!0),Y.value?(d(),w(h,{key:1})):I("",!0)]),f(le,{isOpen:P.value,onOnConfirmed:Be,onOnNotConfirmed:l[5]||(l[5]=()=>P.value=!1)},{default:_(()=>[g(c(e.$t("sureConfirm")),1)]),_:1},8,["isOpen"]),f(le,{isOpen:F.value,onOnConfirmed:Ae,onOnNotConfirmed:l[6]||(l[6]=()=>F.value=!1)},{default:_(()=>[g(c(e.$t("sureRefused")),1)]),_:1},8,["isOpen"])])):I("",!0)}}},Ba=U(fa,[["__scopeId","data-v-f431b2b2"]]);export{Ba as default};
