{"version":3,"file":"update-_xkhCdb5.js","sources":["../../src/views/applications/update.vue"],"sourcesContent":["<template>\r\n    <section class=\"manage section-height shadowed\">\r\n        <div class=\"manage__inner section-padding\">\r\n            <ManageHead \r\n                title=\"editApplicationTitle\" \r\n                :to=\"routes.APPLICATIONS.path\"\r\n            />\r\n            <form class=\"manage__form form-manage\" @submit.prevent=\"submitHandler\">\r\n                <FormInput \r\n                    v-for=\"input in inputs\"\r\n                    :key=\"input.id\"\r\n                    v-model=\"state[input.model]\"\r\n                    :width=\"500\" \r\n                    :placeholder=\"$t(input.placeholder)\"\r\n                    :name=\"input.icon\"\r\n                    :error=\"v$?.[input.errorKey]?.$error\" \r\n                    :textError=\"v$?.[input.errorKey]?.$errors[0]?.$message\"\r\n                    :type=\"input?.type\"\r\n                    :isDisabled=\"true\"\r\n                >\r\n                    {{ $t(input.label) }}\r\n                </FormInput>\r\n                <FormSelect \r\n                    v-for=\"select in selects\"\r\n                    :key=\"select.id\"\r\n                    v-model=\"state[select.model]\" \r\n                    :width=\"500\" \r\n                    :options=\"select.options\"\r\n                    :error=\"v$?.[select?.errorKey]?.$error\" \r\n                    :placeholder=\"select?.placeholder\"\r\n                    :textError=\"v$?.[select?.errorKey]?.$errors[0]?.$message\"\r\n                    :success=\"select.success\"\r\n                    :loading=\"select.loading\"\r\n                    :isMultiSelect=\"select?.multiple\"\r\n                    :isDisabled=\"true\"\r\n                >\r\n                    {{ $t(select.label) }}\r\n                </FormSelect>\r\n            </form>\r\n        </div>\r\n    </section>\r\n</template>\r\n\r\n<script setup>\r\nimport { ref, computed, watch } from \"vue\";\r\nimport { useRouter, useRoute } from \"vue-router\";\r\nimport { useVuelidate } from \"@vuelidate/core\";\r\nimport { useToast } from \"vue-toastification\";\r\nimport { useI18n } from \"vue-i18n\";\r\nimport { required } from \"@/utils/i18n-validators.js\";\r\nimport { useQueryClient, useQuery, useMutation } from \"@tanstack/vue-query\";\r\nimport { getWithId, updateById } from \"@/services/crud.services.js\";\r\nimport { \r\n    manualConstructionMaterial, \r\n    manualGetFloors, \r\n    manualGetCost, \r\n    manualGetObjects, \r\n    manualGetBlocks,\r\n    manualGetRoles\r\n} from \"@/services/manual.services.js\";\r\nimport { routes } from \"@/utils/routes.js\";\r\n\r\nconst queryClient = useQueryClient();\r\nconst router = useRouter();\r\nconst route = useRoute();\r\nconst toast = useToast();\r\nconst { t } = useI18n();\r\n\r\nconst slugId = ref(route.params.id);\r\n\r\nconst organizationId = ref(localStorage.getItem(\"organizationId\"));\r\n\r\nconst isSubmit = ref(false);\r\nconst isFirstChangeObject = ref(false);\r\nconst isFirstChangeBlock = ref(false);\r\n\r\nconst state = ref({\r\n    userId: \"\",\r\n    deadline: \"\",\r\n    constructionMaterialIds: [],\r\n    buildingObjectId: [],\r\n    buildingBlockId: [],\r\n    floorId: [],\r\n    costId: [],\r\n    roleIds: []\r\n});\r\n\r\nconst {\r\n    data: objects,\r\n    isSuccess: isSuccessObjects,\r\n    isLoading: isLoadingObjects\r\n} = await useQuery({\r\n    queryKey: [\"objectsList\", { organizationId }],\r\n    queryFn: () => manualGetObjects(),\r\n\r\n});\r\n\r\nconst valueObject = computed(() => state.value.buildingObjectId);\r\n\r\nconst isEnabledBlocks = computed(() => !!valueObject.value.length);\r\n\r\nwatch(valueObject, (value) => {\r\n    if (!isFirstChangeObject.value && !isSubmit.value) {\r\n        state.value.buildingBlockId = [];\r\n    }\r\n\r\n    isFirstChangeObject.value = false;\r\n}, { immediate: true });\r\n\r\nconst {\r\n    data: blocks,\r\n    isSuccess: isSuccessBlocks,\r\n    isLoading: isLoadingBlocks\r\n} = await useQuery({\r\n    queryKey: [\"blocksList\", { blockId: valueObject }],\r\n    queryFn: () => manualGetBlocks(valueObject.value),\r\n    enabled: isEnabledBlocks\r\n});\r\n\r\nconst valueBlock = computed(() => state.value.buildingBlockId);\r\n\r\nconst isEnabledFloors = computed(() => !!valueBlock.value.length);\r\n\r\nwatch(valueBlock, (value) => {\r\n    if (!isFirstChangeBlock.value && !isSubmit.value) {\r\n        state.value.floorId = [];\r\n    }\r\n\r\n    isFirstChangeBlock.value = false;\r\n}, { immediate: true });\r\n\r\nconst {\r\n    data: floors,\r\n    isSuccess: isSuccessFloors,\r\n    isLoading: isLoadingFloors\r\n} = await useQuery({\r\n    queryKey: [\"floors\", { floorId: valueBlock }],\r\n    queryFn: () => manualGetFloors(valueBlock.value),\r\n    enabled: isEnabledFloors\r\n});\r\n\r\nconst {\r\n    data: costs,\r\n    isSuccess: isSuccessCosts,\r\n    isLoading: isLoadingCosts\r\n} = await useQuery({\r\n    queryKey: [\"costs\", { organizationId }],\r\n    queryFn: () => manualGetCost()\r\n});\r\n\r\nconst {\r\n    data: materials,\r\n    isSuccess: isSuccessMaterials,\r\n    isLoading: isLoadingMaterials\r\n} = await useQuery({\r\n    queryKey: [\"materials\", { organizationId }],\r\n    queryFn: () => manualConstructionMaterial()\r\n});\r\n\r\nconst {\r\n    data: roles,\r\n    isSuccess: isSuccessRoles,\r\n    isLoading: isLoadingRoles\r\n} = await useQuery({\r\n    queryKey: [\"roles\"],\r\n    queryFn: () => manualGetRoles()\r\n});\r\n\r\nconst rules = computed(() => ({\r\n    userId: { required },\r\n    deadline: { required },\r\n    constructionMaterialIds: { required },\r\n    buildingObjectId: { required },\r\n    buildingBlockId: { required },\r\n    floorId: { required },\r\n    costId: { required },\r\n    roleIds: { required }\r\n}));\r\n\r\nconst v$ = useVuelidate(rules, state);\r\n\r\nconst inputs = ref([\r\n    { \r\n        id: 1, \r\n        model: \"deadline\", \r\n        label: \"dateAppLabel\", \r\n        placeholder: \"dateAppPlaceholder\", \r\n        icon: \"date\",\r\n        errorKey: \"deadline\",\r\n        type: \"date\"\r\n    }\r\n]);\r\n\r\nconst selects = ref([\r\n    { \r\n        id: 1, \r\n        model: \"buildingObjectId\", \r\n        label: \"objectAppLabel\", \r\n        placeholder: \"objectAppPlaceholder\",\r\n        errorKey: \"buildingObjectId\",\r\n        options: objects,\r\n        success: isSuccessObjects,\r\n        loading: isLoadingObjects\r\n    },\r\n    { \r\n        id: 2, \r\n        model: \"buildingBlockId\", \r\n        label: \"blockAppLabel\", \r\n        placeholder: \"blockAppPlaceholder\",\r\n        errorKey: \"buildingBlockId\",\r\n        options: blocks,\r\n        success: isSuccessBlocks,\r\n        loading: isLoadingBlocks\r\n    },\r\n    { \r\n        id: 3, \r\n        model: \"floorId\", \r\n        label: \"floorsAppLabel\", \r\n        placeholder: \"floorsAppPlaceholder\", \r\n        errorKey: \"floorId\",\r\n        options: floors,\r\n        success: isSuccessFloors,\r\n        loading: isLoadingFloors\r\n    },\r\n    { \r\n        id: 4, \r\n        model: \"costId\", \r\n        label: \"costAppLabel\", \r\n        placeholder: \"costAppPlaceholder\",\r\n        errorKey: \"costId\",\r\n        options: costs,\r\n        success: isSuccessCosts,\r\n        loading: isLoadingCosts\r\n    },\r\n    { \r\n        id: 5, \r\n        model: \"constructionMaterialIds\", \r\n        label: \"materialsAppLabel\", \r\n        placeholder: \"materialsAppPlaceholder\",\r\n        errorKey: \"constructionMaterialIds\",\r\n        options: materials,\r\n        success: isSuccessMaterials,\r\n        loading: isLoadingMaterials,\r\n        multiple: true\r\n    },\r\n    { \r\n        id: 6, \r\n        model: \"roleIds\", \r\n        label: \"appRoleLabel\", \r\n        placeholder: \"appRolePlaceholder\", \r\n        errorKey: \"roleIds\", \r\n        options: roles, \r\n        success: isSuccessRoles,\r\n        loading: isLoadingRoles,\r\n        multiple: true\r\n    },\r\n]);\r\n\r\nconst { isError } = await useQuery({\r\n    queryKey: [\"applicationsById\", slugId],\r\n    queryFn: () => getWithId(\"application\", slugId.value),\r\n    select: (data) => {\r\n        state.value.id = data.id;\r\n        state.value.userId = data.userId;\r\n        state.value.deadline = data.deadline;\r\n        state.value.constructionMaterialIds = [...data.constructionMaterialIds];\r\n        state.value.buildingObjectId = [data.buildingObjectId];\r\n        state.value.buildingBlockId = [data.buildingBlockId];\r\n        state.value.floorId = [data.floorId];\r\n        state.value.costId = [data.costId];\r\n        state.value.roleIds = [...data.roleIds];\r\n\r\n        isFirstChangeObject.value = true;\r\n        isFirstChangeBlock.value = true;\r\n    }\r\n});\r\n\r\nwatch(isError, (value) => {\r\n    if (value) {\r\n        router.push(routes.HOME.path);\r\n    }\r\n});\r\n\r\nconst { mutate: updateMutate } = useMutation({\r\n    onMutate: (body) => {\r\n        isSubmit.value = true;\r\n        \r\n        body.buildingObjectId = body.buildingObjectId[0];\r\n        body.buildingBlockId = body.buildingBlockId[0];\r\n        body.floorId = body.floorId[0];\r\n        body.costId = body.costId[0];\r\n    },\r\n    mutationFn: (body) => updateById(\"application\", body),\r\n    onSuccess: () => {\r\n        queryClient.invalidateQueries({ queryKey: [\"applications\"] });\r\n        queryClient.invalidateQueries({ queryKey: [\"applicationsById\", slugId] });\r\n        router.push(routes.APPLICATIONS.path);\r\n        // setTimeout(() => toast.success(t(\"updateToast\")), 1000);\r\n    }\r\n});\r\n\r\nconst submitHandler = async () => {\r\n    v$.value.$validate();\r\n\r\n    if (v$.value.$errors.length) {\r\n        return;\r\n    }\r\n\r\n    updateMutate(state.value);\r\n    v$.value.$reset();\r\n}\r\n</script>\r\n\r\n<style lang=\"scss\" scoped></style>"],"names":["queryClient","useQueryClient","router","useRouter","route","useRoute","useToast","useI18n","slugId","ref","organizationId","isSubmit","isFirstChangeObject","isFirstChangeBlock","state","objects","isSuccessObjects","isLoadingObjects","__temp","__restore","_withAsyncContext","useQuery","manualGetObjects","valueObject","computed","isEnabledBlocks","watch","value","blocks","isSuccessBlocks","isLoadingBlocks","manualGetBlocks","valueBlock","isEnabledFloors","floors","isSuccessFloors","isLoadingFloors","manualGetFloors","costs","isSuccessCosts","isLoadingCosts","manualGetCost","materials","isSuccessMaterials","isLoadingMaterials","manualConstructionMaterial","roles","isSuccessRoles","isLoadingRoles","manualGetRoles","rules","required","v$","useVuelidate","inputs","selects","isError","getWithId","data","routes","updateMutate","useMutation","body","updateById","submitHandler"],"mappings":"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"}