import{_ as Qe,u as Re,a as Je,b as We,y as Xe,c as u,r as v,z as V,B as Ye,d as b,e as T,k as ue,h as l,w as Ze,F as P,C as x,D as $,t as p,i as m,A as g,l as ea,m as h,o as r,s as de,f as S,H as aa,G as ta,I as O}from"./index-vMPD68lu.js";import{E as oa}from"./EstimateForm-vKDd2jtn.js";import{u as sa,r as M}from"./i18n-validators-6bFMv5c_.js";import{a as la,u as ra}from"./generic.services-lYBczCwf.js";import{u as L}from"./useQuery-iPiJsYsS.js";import{c as na}from"./crud.services-Ewelvizm.js";import{f as ia,g as ua,h as da,i as ca,j as ma}from"./manual.services-4txGHHAa.js";import{v as ba}from"./v4-yQnnJER4.js";const pa={key:0,class:"manage section-height shadowed"},va={class:"manage__inner section-padding"},ga={class:"manage__overlay"},ha={key:0,class:"manage__title"},_a={key:1,class:"manage__blocks"},fa=["onClick"],Ia={key:4,class:"error"},ya={__name:"create",async setup(ka){let o,d;const ce=la(),me=ea();Re(),Je();const be=We(),{user:_}=Xe(be),z=u(()=>{var e,t;return!!((t=(e=_==null?void 0:_.value.user)==null?void 0:e.modules)!=null&&t.includes(ta.ESTIMATE.CREATE))}),pe=v([{id:1,label:"estimateBlock",width:200},{id:2,label:"estimateFloor",width:200},{id:3,label:"estimateMaterial",width:260},{id:4,label:"estimateBudget",width:200},{id:5,label:"estimateCost"}]),s=v({fullname:"",buildingObjectId:[],price:"",tables:[],details:""}),A=v(!1),i=v(""),ve=u(()=>s.value.tables.filter(e=>+e.buildingBlockId==+i.value)),ge=u(()=>({fullname:{required:M},buildingObjectId:{required:M},price:{required:M},tables:{required:M},details:{required:M}})),n=sa(ge,s),{data:he,isSuccess:_e,isLoading:fe}=([o,d]=V(()=>L({queryKey:["objectsList",{organizationId:_.value.user.organizationId}],queryFn:()=>ia(),enabled:z})),o=await o,d(),o),w=u(()=>s.value.buildingObjectId),Ie=u(()=>!!w.value.length);Ye(w,()=>{A.value||(s.value.tables=[],i.value="")},{immediate:!0});const{data:C,isSuccess:U,isLoading:ye}=([o,d]=V(()=>L({queryKey:["blocksList",{blockId:w}],queryFn:()=>ca(w.value[0]),enabled:Ie})),o=await o,d(),o),q=u(()=>i.value),j=u(()=>!!q.value),{data:H,isSuccess:ke,isLoading:Ee}=([o,d]=V(()=>L({queryKey:["floorsList",{floorId:q}],queryFn:()=>ma(q.value),enabled:j})),o=await o,d(),o),{data:N,isSuccess:Ve,isLoading:$e}=([o,d]=V(()=>L({queryKey:["costsList",{organizationId:_.value.user.organizationId}],queryFn:()=>ua(),enabled:j})),o=await o,d(),o),{data:D,isSuccess:Se,isLoading:Me}=([o,d]=V(()=>L({queryKey:["materialsList",{organizationId:_.value.user.organizationId}],queryFn:()=>da(),enabled:j})),o=await o,d(),o),Le=v([{id:1,model:"fullname",label:"nameEstimateLabel",placeholder:"nameEstimatePlaceholder",icon:"input-company",errorKey:"fullname"}]),we=v([{id:1,model:"buildingObjectId",label:"objectEstimateLabel",placeholder:"objectEstimatePlaceholder",errorKey:"buildingObjectId",options:he,success:_e,loading:fe}]),Ce=v([{id:1,model:"floorId",label:"floorsEstimateLabel",placeholder:"floorsEstimatePlaceholder",options:H,success:ke,loading:Ee},{id:2,model:"costId",label:"costEstimateLabel",placeholder:"costEstimatePlaceholder",options:N,success:Ve,loading:$e},{id:3,model:"constructionMaterailIds",label:"materialsEstimateLabel",placeholder:"materialsEstimatePlaceholder",options:D,success:Se,loading:Me,multiple:!0}]),Fe=u(()=>O(C.value||[])),Be=u(()=>O(H.value||[])),Te=u(()=>O(N.value||[])),Oe=u(()=>O(D.value||[])),qe=e=>{var t;return(t=Fe.value[e.buildingBlockId])==null?void 0:t.name},je=e=>{var t;return(t=Be.value[e.floorId])==null?void 0:t.name},Ke=e=>{var t;return(t=Te.value[e.costId])==null?void 0:t.name},Pe=e=>{var t;return(t=e.constructionMaterailIds)==null?void 0:t.map((c,F)=>{var B;return{id:F+1,name:((B=Oe.value[c])==null?void 0:B.name)||"Unknown Material"}})},xe=e=>{s.value.tables.push({...e,delId:ba(),blockValue:qe(e),floorValue:je(e),costValue:Ke(e),constructionMaterialIdsValue:Pe(e)}),s.value.price=+s.value.price+ +e.price},ze=e=>{s.value.tables=s.value.tables.filter(t=>t.delId!==e)},{mutate:Ae}=ra({onMutate:e=>{A.value=!0,e.tables=e.tables.map(t=>{let c={...t};return delete c.delId,delete c.blockValue,delete c.floorValue,delete c.costValue,delete c.constructionMaterialIdsValue,c}),e.buildingObjectId=e.buildingObjectId[0]},mutationFn:e=>na("budget",e),onSuccess:e=>{ce.invalidateQueries({queryKey:["budgets"]}),me.push(de.ESTIMATE.path)}}),Ue=()=>{n.value.$validate(),!n.value.$errors.length&&(Ae(s.value),n.value.$reset())};return(e,t)=>{var G,Q,R,J,W,X,Y,Z,ee,ae,te,oe,se,le,re,ne,ie;const c=h("ManageHead"),F=h("FormInput"),B=h("FormSelect"),He=h("Spinner"),Ne=h("SubTable"),De=h("FormTextarea"),Ge=h("CustomButton");return z.value?(r(),b("section",pa,[T("div",va,[ue(c,{title:"addNewEstimateTitle",to:l(de).ESTIMATE.path},null,8,["to"]),T("form",{class:"manage__form",onSubmit:Ze(Ue,["prevent"])},[T("div",ga,[(r(!0),b(P,null,x(Le.value,a=>{var f,I,y,k,E;return r(),g(F,{key:a.id,modelValue:s.value[a.model],"onUpdate:modelValue":K=>s.value[a.model]=K,width:500,placeholder:e.$t(a.placeholder),name:a.icon,error:(I=(f=l(n))==null?void 0:f[a.errorKey])==null?void 0:I.$error,textError:(E=(k=(y=l(n))==null?void 0:y[a.errorKey])==null?void 0:k.$errors[0])==null?void 0:E.$message},{default:$(()=>[S(p(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","name","error","textError"])}),128)),(r(!0),b(P,null,x(we.value,a=>{var f,I,y,k,E;return r(),g(B,{key:a.id,modelValue:s.value[a.model],"onUpdate:modelValue":K=>s.value[a.model]=K,modelModifiers:{trim:!0},width:500,options:a.options,error:(I=(f=l(n))==null?void 0:f[a==null?void 0:a.errorKey])==null?void 0:I.$error,placeholder:a==null?void 0:a.placeholder,textError:(E=(k=(y=l(n))==null?void 0:y[a==null?void 0:a.errorKey])==null?void 0:k.$errors[0])==null?void 0:E.$message,success:a.success,loading:a.loading},{default:$(()=>[S(p(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","options","error","placeholder","textError","success","loading"])}),128)),ue(F,{modelValue:s.value.price,"onUpdate:modelValue":t[0]||(t[0]=a=>s.value.price=a),width:500,placeholder:e.$t("estimatePricePlaceholder"),name:"money",error:(Q=(G=l(n))==null?void 0:G.price)==null?void 0:Q.$error,textError:(W=(J=(R=l(n))==null?void 0:R.price)==null?void 0:J.$errors[0])==null?void 0:W.$message,isDisabled:!0},{default:$(()=>[S(p(e.$t("estimatePriceLabel")),1)]),_:1},8,["modelValue","placeholder","error","textError"])]),l(U)&&((X=l(C))!=null&&X.length)?(r(),b("h3",ha,p(e.$t("blockEstimateLabel")),1)):m("",!0),l(U)&&((Y=l(C))!=null&&Y.length)?(r(),b("ul",_a,[(r(!0),b(P,null,x(l(C),a=>(r(),b("li",{key:a.id,class:"manage__block",onClick:()=>i.value=a.id},[T("div",{class:aa(`manage__block-box ${i.value===a.id?"is-active":""}`)},p(a.name),3)],8,fa))),128))])):m("",!0),l(ye)?(r(),g(He,{key:2})):m("",!0),i.value?(r(),g(oa,{key:3,selects:Ce.value,blockId:i.value,onOnAddTable:xe,onOnChangeBlock:t[1]||(t[1]=a=>i.value=a)},null,8,["selects","blockId"])):m("",!0),(ee=(Z=l(n))==null?void 0:Z.tables)!=null&&ee.$error?(r(),b("span",Ia,p((oe=(te=(ae=l(n))==null?void 0:ae.tables)==null?void 0:te.$errors[0])==null?void 0:oe.$message),1)):m("",!0),i.value?(r(),g(Ne,{key:5,headers:pe.value,table:ve.value,onOnActionDelete:ze,isShowDelete:!0},null,8,["headers","table"])):m("",!0),i.value?(r(),g(De,{key:6,modelValue:s.value.details,"onUpdate:modelValue":t[2]||(t[2]=a=>s.value.details=a),modelModifiers:{trim:!0},width:500,placeholder:e.$t("estimateCommentPlaceholder"),error:(le=(se=l(n))==null?void 0:se.details)==null?void 0:le.$error,textError:(ie=(ne=(re=l(n))==null?void 0:re.details)==null?void 0:ne.$errors[0])==null?void 0:ie.$message},{default:$(()=>[S(p(e.$t("estimateCommentLabel")),1)]),_:1},8,["modelValue","placeholder","error","textError"])):m("",!0),i.value?(r(),g(Ge,{key:7,className:"manage__submit"},{default:$(()=>[S(p(e.$t("formButton")),1)]),_:1})):m("",!0)],32)])])):m("",!0)}}},Fa=Qe(ya,[["__scopeId","data-v-bf7156e6"]]);export{Fa as default};
