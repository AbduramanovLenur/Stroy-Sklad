import{_ as oa,u as ra,a as ua,b as na,y as ia,c as i,r as b,z as p,C as q,d as v,e as L,k as ca,h as o,w as da,F as K,D as Ve,t as h,i as m,B as I,A as F,l as ma,G as ba,m as y,o as r,s as N,f as C,I as ga,H as va,J as $,E as pa}from"./index-td5OKsxi.js";import{E as ha}from"./EstimateForm-r6lj2ubJ.js";import{u as Ia,r as _}from"./i18n-validators-Zg_qUvB4.js";import{u as ya}from"./generic.services-lfCsIIL0.js";import{u as k}from"./useQuery-wqCEShPl.js";import{u as _a}from"./useMutation-td-rGYVU.js";import{a as ka,u as Ea}from"./crud.services-f6-dtRnP.js";import{f as Sa,g as Ta,h as Va,i as Ma,j as La,b as Fa}from"./manual.services-EaI1aYj6.js";import{v as Me}from"./v4-yQnnJER4.js";const Ca={key:0,class:"manage section-height shadowed"},$a={class:"manage__inner section-padding"},wa={class:"manage__overlay"},fa={key:0,class:"manage__title"},Ba={key:1,class:"manage__blocks"},ja=["onClick"],Oa={key:3,class:"error"},qa={__name:"update",async setup(Ka){let l,u;const z=ya(),P=ma(),Le=ba(),Fe=ra(),{t:Ce}=ua(),$e=na(),{user:n}=ia($e),E=i(()=>{var e,t;return!!((t=(e=n==null?void 0:n.value.user)==null?void 0:e.modules)!=null&&t.includes(va.ESTIMATE.CREATE))}),w=b(Le.params.id),we=b([{id:1,label:"estimateBlock",width:15},{id:2,label:"estimateFloor",width:20},{id:3,label:"estimateMaterial",width:25},{id:4,label:"estimateBudget",width:20},{id:5,label:"estimateCost",width:20}]),s=b({id:"",fullname:"",buildingObjectId:[],price:"",budgetTables:[],details:"",stateId:[]}),A=b(!1),f=b(!1),c=b(""),fe=i(()=>s.value.budgetTables.filter(e=>+e.buildingBlockId==+c.value)),Be=i(()=>({id:{required:_},fullname:{required:_},buildingObjectId:{required:_},price:{required:_},budgetTables:{required:_},details:{required:_},stateId:{required:_}})),d=Ia(Be,s),{data:je,isSuccess:Oe,isLoading:qe}=([l,u]=p(()=>k({queryKey:["objectsList",{organizationId:n.value.user.organizationId,name:n.value.user.fullName}],queryFn:()=>Sa(),enabled:E})),l=await l,u(),l),T=i(()=>s.value.buildingObjectId[0]),Ke=i(()=>!!T.value);q(T,()=>{!f.value&&!A.value&&(s.value.budgetTables=[],c.value=""),f.value=!1},{immediate:!0});const{data:V,isSuccess:D,isLoading:Ne}=([l,u]=p(()=>k({queryKey:["blocksList",{objectId:T,organizationId:n.value.user.organizationId,name:n.value.user.fullName}],queryFn:()=>Ta(T.value),enabled:Ke})),l=await l,u(),l),B=i(()=>c.value),ze=i(()=>!!B.value),{data:x,isSuccess:Pe,isLoading:Ae}=([l,u]=p(()=>k({queryKey:["floorsList",{blockId:B,organizationId:n.value.user.organizationId,name:n.value.user.fullName}],queryFn:()=>Va(B.value),enabled:ze})),l=await l,u(),l),{data:U,isSuccess:De,isLoading:xe}=([l,u]=p(()=>k({queryKey:["costsList",{organizationId:n.value.user.organizationId,name:n.value.user.fullName}],queryFn:()=>Ma(),enabled:E})),l=await l,u(),l),{data:G,isSuccess:Ue,isLoading:Ge}=([l,u]=p(()=>k({queryKey:["materialsList",{organizationId:n.value.user.organizationId,name:n.value.user.fullName}],queryFn:()=>La(),enabled:E})),l=await l,u(),l),{data:He,isSuccess:Re,isLoading:Qe}=([l,u]=p(()=>k({queryKey:["states"],queryFn:()=>Fa(),enabled:E})),l=await l,u(),l),Je=b([{id:1,model:"fullname",label:"nameEstimateLabel",placeholder:"nameEstimatePlaceholder",icon:"input-company",errorKey:"fullname"},{id:2,model:"buildingObjectId",label:"objectEstimateLabel",placeholder:"objectEstimatePlaceholder",errorKey:"buildingObjectId",options:je,success:Oe,loading:qe,select:!0},{id:3,model:"price",label:"estimatePriceLabel",placeholder:"estimatePricePlaceholder",icon:"money",errorKey:"price",isDisabled:!0},{id:4,model:"stateId",label:"estimateStateLabel",placeholder:"estimateStatePlaceholder",errorKey:"stateId",options:He,success:Re,loading:Qe,select:!0}]),We=b([{id:1,model:"floorId",label:"floorsEstimateLabel",placeholder:"floorsEstimatePlaceholder",options:x,success:Pe,loading:Ae,select:!0},{id:2,model:"costId",label:"costEstimateLabel",placeholder:"costEstimatePlaceholder",options:U,success:De,loading:xe,select:!0},{id:3,model:"constructionMaterailIds",label:"materialsEstimateLabel",placeholder:"materialsEstimatePlaceholder",options:G,success:Ue,loading:Ge,multiple:!0,select:!0},{id:4,model:"price",label:"priceEstimateLabel",placeholder:"priceEstimatePlaceholder",icon:"money"}]),H=i(()=>$(V.value||[])),R=i(()=>$(x.value||[])),Q=i(()=>$(U.value||[])),J=i(()=>$(G.value||[])),W=e=>{var t;return(t=H.value[e.buildingBlockId])==null?void 0:t.name},X=e=>{var t;return(t=R.value[e.floorId])==null?void 0:t.name},Y=e=>{var t;return(t=Q.value[e.costId])==null?void 0:t.name},Z=e=>{var t;return(t=e.constructionMaterailIds)==null?void 0:t.map((g,M)=>{var S;return{id:M+1,name:((S=J.value[g])==null?void 0:S.name)||"Unknown Material"}})},Xe=i(()=>!!(s.value.budgetTables.length&&Object.keys(H.value).length&&Object.keys(R.value).length&&Object.keys(Q.value).length&&Object.keys(J.value).length)),ee=b(!0);q(Xe,e=>{e&&ee.value&&(s.value.budgetTables=s.value.budgetTables.map(t=>({...t,delId:Me(),blockValue:W(t),floorValue:X(t),costValue:Y(t),constructionMaterialIdsValue:Z(t)})),ee.value=!1)},{immediate:!0});const Ye=e=>{s.value.budgetTables.push({...e,delId:Me(),blockValue:W(e),floorValue:X(e),costValue:Y(e),constructionMaterialIdsValue:Z(e)}),s.value.price=+s.value.price+e.price},Ze=e=>{s.value.budgetTables=s.value.budgetTables.filter(t=>{const g=t.delId!==e;return g||(s.value.price-=t.price),g})},{isError:ea}=([l,u]=p(()=>k({queryKey:["budgetById",w,n.value.user.fullName],queryFn:()=>ka("budget",w.value),select:e=>{s.value.id=e.id,s.value.fullname=e.fullname,s.value.buildingObjectId=[e.buildingObjectId],s.value.price=e.price,s.value.budgetTables=[...e.budgetTables],s.value.details=e.details,s.value.stateId=[e.stateId],f.value=!0},enabled:E})),l=await l,u(),l);q(ea,e=>{e&&P.push(N.ESTIMATE.path)});const{mutate:aa,status:ta}=_a({onMutate:e=>{A.value=!0,e.budgetTables=e.budgetTables.map(t=>{const{delId:g,blockValue:M,floorValue:S,costValue:ae,constructionMaterialIdsValue:te,...j}=t;return j}),e.buildingObjectId=e.buildingObjectId[0],e.stateId=e.stateId[0]},mutationFn:e=>Ea("budget",e),onSuccess:e=>{e!=null&&e.success&&(s.value=pa(s.value),z.invalidateQueries({queryKey:["budgets"]}),z.invalidateQueries({queryKey:["budgetById",w]}),P.push(N.ESTIMATE.path),setTimeout(()=>Fe.success(Ce("updateToast")),150))}}),sa=()=>{if(d.value.$validate(),d.value.$errors.length)return;const e={...s.value};aa(e),d.value.$reset()};return(e,t)=>{var se,le,oe,re,ue,ne,ie,ce,de,me,be,ge;const g=y("ManageHead"),M=y("FormInput"),S=y("FormSelect"),ae=y("SubTable"),te=y("FormTextarea"),j=y("CustomButton"),la=y("Spinner");return E.value?(r(),v("section",Ca,[L("div",$a,[ca(g,{title:"addNewEstimateTitle",to:o(N).ESTIMATE.path},null,8,["to"]),L("form",{class:"manage__form",onSubmit:da(sa,["prevent"])},[L("div",wa,[(r(!0),v(K,null,Ve(Je.value,a=>{var ve,pe,he,Ie,ye,_e,ke,Ee,Se,Te;return r(),v(K,{key:a.id},[a!=null&&a.select?m("",!0):(r(),I(M,{key:0,modelValue:s.value[a.model],"onUpdate:modelValue":O=>s.value[a.model]=O,placeholder:e.$t(a.placeholder),name:a.icon,error:(pe=(ve=o(d))==null?void 0:ve[a.errorKey])==null?void 0:pe.$error,textError:(ye=(Ie=(he=o(d))==null?void 0:he[a.errorKey])==null?void 0:Ie.$errors[0])==null?void 0:ye.$message,isDisabled:a==null?void 0:a.isDisabled},{default:F(()=>[C(h(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","name","error","textError","isDisabled"])),a!=null&&a.select?(r(),I(S,{key:1,modelValue:s.value[a.model],"onUpdate:modelValue":O=>s.value[a.model]=O,modelModifiers:{trim:!0},options:a.options,error:(ke=(_e=o(d))==null?void 0:_e[a==null?void 0:a.errorKey])==null?void 0:ke.$error,placeholder:a==null?void 0:a.placeholder,textError:(Te=(Se=(Ee=o(d))==null?void 0:Ee[a==null?void 0:a.errorKey])==null?void 0:Se.$errors[0])==null?void 0:Te.$message,success:a.success,loading:a.loading},{default:F(()=>[C(h(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","options","error","placeholder","textError","success","loading"])):m("",!0)],64)}),128))]),o(D)&&((se=o(V))!=null&&se.length)?(r(),v("h3",fa,h(e.$t("blockEstimateLabel")),1)):m("",!0),o(D)&&((le=o(V))!=null&&le.length)?(r(),v("ul",Ba,[(r(!0),v(K,null,Ve(o(V),a=>(r(),v("li",{key:a.id,class:"manage__block",onClick:()=>c.value=a.id},[L("div",{class:ga(`manage__block-box ${c.value===a.id?"is-active":""}`)},h(a.name),3)],8,ja))),128))])):m("",!0),c.value?(r(),I(ha,{key:2,subFields:We.value,blockId:c.value,onOnAddTable:Ye,onOnChangeBlock:t[0]||(t[0]=a=>c.value=a)},null,8,["subFields","blockId"])):m("",!0),(re=(oe=o(d))==null?void 0:oe.budgetTables)!=null&&re.$error?(r(),v("span",Oa,h((ie=(ne=(ue=o(d))==null?void 0:ue.budgetTables)==null?void 0:ne.$errors[0])==null?void 0:ie.$message),1)):m("",!0),c.value?(r(),I(ae,{key:4,headers:we.value,table:fe.value,onOnActionDelete:Ze,isShowDelete:!0},null,8,["headers","table"])):m("",!0),c.value?(r(),I(te,{key:5,modelValue:s.value.details,"onUpdate:modelValue":t[1]||(t[1]=a=>s.value.details=a),modelModifiers:{trim:!0},width:500,placeholder:e.$t("estimateCommentPlaceholder"),error:(de=(ce=o(d))==null?void 0:ce.details)==null?void 0:de.$error,textError:(ge=(be=(me=o(d))==null?void 0:me.details)==null?void 0:be.$errors[0])==null?void 0:ge.$message},{default:F(()=>[C(h(e.$t("estimateCommentLabel")),1)]),_:1},8,["modelValue","placeholder","error","textError"])):m("",!0),c.value?(r(),I(j,{key:6,className:"manage__submit",disabled:o(ta)==="pending"},{default:F(()=>[C(h(e.$t("formButton")),1)]),_:1},8,["disabled"])):m("",!0)],32),o(Ne)?(r(),I(la,{key:0})):m("",!0)])])):m("",!0)}}},Ra=oa(qa,[["__scopeId","data-v-359602df"]]);export{Ra as default};
