import{_ as Ae,u as ke,a as Ve,r as k,c as d,C as $e,m as v,o as p,d as b,e as V,t as m,F as w,D as Se,B as C,A as g,f as h,i as $,k as I,K as Fe,q as ea,b as aa,y as ta,z as y,h as i,w as oa,l as la,s as _e,H as sa,J as L,E as ra}from"./index-QWM1teQg.js";import{c as na}from"./crud.services-j9N-rseG.js";import{f as ca,g as ua,h as ia,i as da,j as pa,k as ma}from"./manual.services-MoeaU9LJ.js";import{u as va,r as _}from"./i18n-validators-hZvu6jXW.js";import{u as ga}from"./generic.services-gfDTK8oT.js";import{u as A}from"./useQuery-53-aSZRv.js";import{u as ha}from"./useMutation-qCLal6Gk.js";import{v as Ia}from"./v4-yQnnJER4.js";const ba={class:"application-form"},ya={class:"application-form__title"},_a={class:"application-form__overlay form-manage"},Aa={__name:"ApplicationForm",props:{subFields:Array,buildingBlockId:Array,isSubmit:Boolean},emits:["onAddTable"],setup(f,{emit:o}){const c=ke(),{t:q}=Ve(),E=f,O=o,r=k({floorId:[],costId:[],constructionMaterialId:[],count:""}),P=d(()=>E.buildingBlockId);$e(P,()=>{r.value.floorId=[]});const n=()=>{if(!Fe(r.value)){c.error(q("isEmptyModal"));return}r.value={floorId:r.value.floorId[0],costId:r.value.costId[0],constructionMaterialId:r.value.constructionMaterialId[0],count:r.value.count},O("onAddTable",r.value),r.value=ea(r.value)};return(u,T)=>{const K=v("FormInput"),l=v("FormSelect"),N=v("CustomButton");return p(),b("div",ba,[V("h4",ya,m(u.$t("appInfo")),1),V("div",_a,[(p(!0),b(w,null,Se(f.subFields,e=>(p(),b(w,{key:e.id},[e!=null&&e.select?$("",!0):(p(),C(K,{key:0,modelValue:r.value[e.model],"onUpdate:modelValue":S=>r.value[e.model]=S,width:500,placeholder:u.$t(e.placeholder),name:e.icon,type:e==null?void 0:e.type},{default:g(()=>[h(m(u.$t(e.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","name","type"])),e!=null&&e.select?(p(),C(l,{key:1,modelValue:r.value[e.model],"onUpdate:modelValue":S=>r.value[e.model]=S,modelModifiers:{trim:!0},width:500,options:e.options,placeholder:e==null?void 0:e.placeholder,success:e.success,loading:e.loading,isMultiSelect:e==null?void 0:e.multiple},{default:g(()=>[h(m(u.$t(e.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","options","placeholder","success","loading","isMultiSelect"])):$("",!0)],64))),128)),I(N,{className:"form__submit",type:"button",onClick:n},{default:g(()=>[h(m(u.$t("addButtonForm")),1)]),_:1})])])}}},ka=Ae(Aa,[["__scopeId","data-v-3c9202b7"]]),Va={key:0,class:"manage section-height shadowed"},$a={class:"manage__inner section-padding"},Sa={class:"manage__overlay"},Ta={key:0,class:"error"},Ma={class:"manage__textareas"},Ba={__name:"create",async setup(f){let o,c;const q=ga(),E=la(),O=ke(),{t:r}=Ve(),P=aa(),{user:n}=ta(P),u=d(()=>{var a,s;return!!((s=(a=n==null?void 0:n.value.user)==null?void 0:a.modules)!=null&&s.includes(sa.APPLICATION.CREATE))}),T=k(!1),K=k([{id:1,label:"appFloor",width:15},{id:2,label:"appMaterial",width:30},{id:4,label:"appCount",width:15},{id:5,label:"appPrice",width:20}]),l=k({deadline:"",buildingObjectId:[],buildingBlockId:[],createApplicationTables:[],details:"",comment:""}),N=d(()=>({deadline:{required:_},buildingObjectId:{required:_},buildingBlockId:{required:_},createApplicationTables:{required:_},details:{required:_},comment:{required:_}})),e=va(N,l),{data:S,isSuccess:Te,isLoading:Me}=([o,c]=y(()=>A({queryKey:["objectsList",{organizationId:n.value.user.organizationId,name:n.value.user.fullName}],queryFn:()=>ca(),enabled:u})),o=await o,c(),o),M=d(()=>l.value.buildingObjectId),Be=d(()=>!!M.value.length);$e(M,()=>{T.value||(l.value.buildingBlockId=[])},{immediate:!0});const{data:Le,isSuccess:we,isLoading:Ce}=([o,c]=y(()=>A({queryKey:["blocksList",{blockId:M,organizationId:n.value.user.organizationId,name:n.value.user.fullName}],queryFn:()=>ua(M.value),enabled:Be})),o=await o,c(),o),j=d(()=>l.value.buildingBlockId),fe=d(()=>!!j.value.length),{data:D,isSuccess:qe,isLoading:Ee}=([o,c]=y(()=>A({queryKey:["floorsList",{floorId:j,organizationId:n.value.user.organizationId,name:n.value.user.fullName}],queryFn:()=>ia(j.value),enabled:fe})),o=await o,c(),o),{data:H,isSuccess:Oe,isLoading:Pe}=([o,c]=y(()=>A({queryKey:["costsList",{organizationId:n.value.user.organizationId,name:n.value.user.fullName}],queryFn:()=>da(),enabled:u})),o=await o,c(),o),{data:Q,isSuccess:Ke,isLoading:Ne}=([o,c]=y(()=>A({queryKey:["materialsList",{organizationId:n.value.user.organizationId,name:n.value.user.fullName}],queryFn:()=>pa(),enabled:u})),o=await o,c(),o),{data:je,isSuccess:La,isLoading:wa}=([o,c]=y(()=>A({queryKey:["types"],queryFn:()=>ma(),enabled:u})),o=await o,c(),o),ze=k([{id:1,model:"deadline",label:"dateAppLabel",placeholder:"dateAppPlaceholder",icon:"date",errorKey:"deadline",type:"date"},{id:2,model:"buildingObjectId",label:"objectAppLabel",placeholder:"objectAppPlaceholder",errorKey:"buildingObjectId",options:S,success:Te,loading:Me,select:!0},{id:3,model:"buildingBlockId",label:"blockAppLabel",placeholder:"blockAppPlaceholder",errorKey:"buildingBlockId",options:Le,success:we,loading:Ce,select:!0}]),Ue=k([{id:1,model:"floorId",label:"floorsAppLabel",placeholder:"floorsAppPlaceholder",options:D,success:qe,loading:Ee,select:!0},{id:2,model:"costId",label:"costAppLabel",placeholder:"costAppPlaceholder",options:H,success:Oe,loading:Pe,select:!0},{id:3,model:"constructionMaterialId",label:"materialsAppLabel",placeholder:"materialsAppPlaceholder",options:Q,success:Ke,loading:Ne,select:!0},{id:4,model:"count",label:"countAppLabel",placeholder:"countAppPlaceholder",icon:"list"}]),De=d(()=>L(D.value)),He=d(()=>L(H.value)),Qe=d(()=>L(Q.value));d(()=>L(je.value));const xe=a=>{var s;return(s=De.value[a.floorId])==null?void 0:s.name},Ge=a=>{var s;return(s=He.value[a.costId])==null?void 0:s.name},Re=a=>{var s;return(s=Qe.value[a==null?void 0:a.constructionMaterialId])==null?void 0:s.name},Je=a=>{l.value.createApplicationTables.push({...a,delId:Ia(),floorValue:xe(a),costValue:Ge(a),constructionMaterialValue:Re(a)})},We=a=>{l.value.createApplicationTables=l.value.createApplicationTables.filter(s=>s.delId!==a)},{mutate:Xe,status:Ye}=ha({onMutate:a=>{T.value=!0,a.buildingObjectId=a.buildingObjectId[0],a.buildingBlockId=a.buildingBlockId[0],a.createApplicationTables=a.createApplicationTables.map(s=>{const{delId:x,floorValue:G,costValue:R,constructionMaterialValue:J,typeValue:z,quantityTypeId:W,...B}=s;return B})},mutationFn:a=>na("application",a),onSuccess:a=>{a!=null&&a.success&&(l.value=ra(l.value),q.invalidateQueries({queryKey:["applications"]}),E.push(_e.APPLICATION.path),setTimeout(()=>O.success(r("createToast")),150))}}),Ze=()=>{if(e.value.$validate(),e.value.$errors.length)return;const a={...l.value};Xe(a),e.value.$reset()};return(a,s)=>{var B,X,Y,Z,F,ee,ae,te,oe,le,se,re,ne,ce,ue;const x=v("ManageHead"),G=v("FormInput"),R=v("FormSelect"),J=v("SubTable"),z=v("FormTextarea"),W=v("CustomButton");return u.value?(p(),b("section",Va,[V("div",$a,[I(x,{title:"addNewApplicationTitle",to:i(_e).APPLICATION.path},null,8,["to"]),V("form",{class:"manage__form",onSubmit:oa(Ze,["prevent"])},[V("div",Sa,[(p(!0),b(w,null,Se(ze.value,t=>{var ie,de,pe,me,ve,ge,he,Ie,be,ye;return p(),b(w,{key:t.id},[t!=null&&t.select?$("",!0):(p(),C(G,{key:0,modelValue:l.value[t.model],"onUpdate:modelValue":U=>l.value[t.model]=U,width:500,placeholder:a.$t(t.placeholder),name:t.icon,error:(de=(ie=i(e))==null?void 0:ie[t.errorKey])==null?void 0:de.$error,textError:(ve=(me=(pe=i(e))==null?void 0:pe[t.errorKey])==null?void 0:me.$errors[0])==null?void 0:ve.$message,type:t==null?void 0:t.type},{default:g(()=>[h(m(a.$t(t.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","name","error","textError","type"])),t!=null&&t.select?(p(),C(R,{key:1,modelValue:l.value[t.model],"onUpdate:modelValue":U=>l.value[t.model]=U,modelModifiers:{trim:!0},width:500,options:t.options,error:(he=(ge=i(e))==null?void 0:ge[t==null?void 0:t.errorKey])==null?void 0:he.$error,placeholder:t==null?void 0:t.placeholder,textError:(ye=(be=(Ie=i(e))==null?void 0:Ie[t==null?void 0:t.errorKey])==null?void 0:be.$errors[0])==null?void 0:ye.$message,success:t.success,loading:t.loading,isMultiSelect:t==null?void 0:t.multiple},{default:g(()=>[h(m(a.$t(t.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","options","error","placeholder","textError","success","loading","isMultiSelect"])):$("",!0)],64)}),128))]),I(ka,{subFields:Ue.value,buildingBlockId:l.value.buildingBlockId,isSubmit:T.value,onOnAddTable:Je},null,8,["subFields","buildingBlockId","isSubmit"]),(X=(B=i(e))==null?void 0:B.createApplicationTables)!=null&&X.$error?(p(),b("span",Ta,m((F=(Z=(Y=i(e))==null?void 0:Y.createApplicationTables)==null?void 0:Z.$errors[0])==null?void 0:F.$message),1)):$("",!0),I(J,{headers:K.value,table:l.value.createApplicationTables,onOnActionDelete:We,isShowDelete:!0},null,8,["headers","table"]),V("div",Ma,[I(z,{modelValue:l.value.details,"onUpdate:modelValue":s[0]||(s[0]=t=>l.value.details=t),modelModifiers:{trim:!0},width:500,placeholder:a.$t("appDetailsPlaceholder"),error:(ae=(ee=i(e))==null?void 0:ee.details)==null?void 0:ae.$error,textError:(le=(oe=(te=i(e))==null?void 0:te.details)==null?void 0:oe.$errors[0])==null?void 0:le.$message},{default:g(()=>[h(m(a.$t("appDetailsLabel")),1)]),_:1},8,["modelValue","placeholder","error","textError"]),I(z,{modelValue:l.value.comment,"onUpdate:modelValue":s[1]||(s[1]=t=>l.value.comment=t),modelModifiers:{trim:!0},width:500,placeholder:a.$t("appCommentPlaceholder"),error:(re=(se=i(e))==null?void 0:se.comment)==null?void 0:re.$error,textError:(ue=(ce=(ne=i(e))==null?void 0:ne.comment)==null?void 0:ce.$errors[0])==null?void 0:ue.$message},{default:g(()=>[h(m(a.$t("appCommentLabel")),1)]),_:1},8,["modelValue","placeholder","error","textError"])]),I(W,{className:"manage__submit",disabled:i(Ye)==="pending"},{default:g(()=>[h(m(a.$t("appButton")),1)]),_:1},8,["disabled"])],32)])])):$("",!0)}}},ja=Ae(Ba,[["__scopeId","data-v-3ee174a2"]]);export{ja as default};
