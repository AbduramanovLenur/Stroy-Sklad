import{_ as na,u as da,a as ca,b as ma,y as ba,c as n,r as m,z as v,B as U,d as p,e as O,k as z,h as o,w as ga,F as H,C as N,D as k,t as b,i as g,A as h,l as pa,E as va,m as I,o as u,s as D,f as E,H as ha,G as Ia,I as j}from"./index-0QVwumwK.js";import{E as fa}from"./EstimateForm-I9Cnm6Z0.js";import{u as ya,r as f}from"./i18n-validators-HH176oYr.js";import{a as _a,u as ka}from"./generic.services-MiG8bmru.js";import{u as y}from"./useQuery-pQbev7C6.js";import{a as Ea,u as Va}from"./crud.services-E8qyVQZH.js";import{f as Sa,g as Ta,h as $a,i as Ma,j as La,b as wa}from"./manual.services-yuepKyN0.js";import{v as we}from"./v4-yQnnJER4.js";const Ca={key:0,class:"manage section-height shadowed"},Fa={class:"manage__inner section-padding"},Ba={class:"manage__overlay"},Oa={key:0,class:"manage__title"},ja={key:1,class:"manage__blocks"},qa=["onClick"],Ka={key:4,class:"error"},Pa={__name:"update",async setup(xa){let l,i;const G=_a(),R=pa(),Ce=va();da(),ca();const Fe=ma(),{user:_}=ba(Fe),w=n(()=>{var e,t;return!!((t=(e=_==null?void 0:_.value.user)==null?void 0:e.modules)!=null&&t.includes(Ia.ESTIMATE.CREATE))}),q=m(Ce.params.id),Be=m([{id:1,label:"estimateBlock",width:200},{id:2,label:"estimateFloor",width:200},{id:3,label:"estimateMaterial",width:260},{id:4,label:"estimateBudget",width:200},{id:5,label:"estimateCost"}]),s=m({id:"",fullname:"",buildingObjectId:[],price:"",budgetTables:[],details:"",stateId:[]}),Q=m(!1),K=m(!1),d=m(""),Oe=n(()=>s.value.budgetTables.filter(e=>+e.buildingBlockId==+d.value)),je=n(()=>({id:{required:f},fullname:{required:f},buildingObjectId:{required:f},price:{required:f},budgetTables:{required:f},details:{required:f},stateId:{required:f}})),r=ya(je,s),{data:qe,isSuccess:Ke,isLoading:Pe}=([l,i]=v(()=>y({queryKey:["objectsList",{organizationId:_.value.user.organizationId}],queryFn:()=>Sa(),enabled:w})),l=await l,i(),l),C=n(()=>s.value.buildingObjectId),xe=n(()=>!!C.value.length);U(C,()=>{!K.value&&!Q.value&&(s.value.budgetTables=[],d.value=""),K.value=!1},{immediate:!0});const{data:F,isSuccess:W,isLoading:Ae}=([l,i]=v(()=>y({queryKey:["blocksList",{blockId:C}],queryFn:()=>Ma(C.value[0]),enabled:xe})),l=await l,i(),l),P=n(()=>d.value),x=n(()=>!!P.value),{data:J,isSuccess:Ue,isLoading:ze}=([l,i]=v(()=>y({queryKey:["floorsList",{floorId:P}],queryFn:()=>La(P.value),enabled:x})),l=await l,i(),l),{data:X,isSuccess:He,isLoading:Ne}=([l,i]=v(()=>y({queryKey:["costsList",{organizationId:_.value.user.organizationId}],queryFn:()=>Ta(),enabled:x})),l=await l,i(),l),{data:Y,isSuccess:De,isLoading:Ge}=([l,i]=v(()=>y({queryKey:["materialsList",{organizationId:_.value.user.organizationId}],queryFn:()=>$a(),enabled:x})),l=await l,i(),l),{data:Re,isSuccess:Qe,isLoading:We}=([l,i]=v(()=>y({queryKey:["states"],queryFn:()=>wa(),enabled:w})),l=await l,i(),l),Je=m([{id:1,model:"fullname",label:"nameEstimateLabel",placeholder:"nameEstimatePlaceholder",icon:"input-company",errorKey:"fullname"}]),Xe=m([{id:1,model:"buildingObjectId",label:"objectEstimateLabel",placeholder:"objectEstimatePlaceholder",errorKey:"buildingObjectId",options:qe,success:Ke,loading:Pe}]),Ye=m([{id:1,model:"floorId",label:"floorsEstimateLabel",placeholder:"floorsEstimatePlaceholder",options:J,success:Ue,loading:ze},{id:2,model:"costId",label:"costEstimateLabel",placeholder:"costEstimatePlaceholder",options:X,success:He,loading:Ne},{id:3,model:"constructionMaterailIds",label:"materialsEstimateLabel",placeholder:"materialsEstimatePlaceholder",options:Y,success:De,loading:Ge,multiple:!0}]),Z=n(()=>j(F.value||[])),ee=n(()=>j(J.value||[])),ae=n(()=>j(X.value||[])),te=n(()=>j(Y.value||[])),se=e=>{var t;return(t=Z.value[e.buildingBlockId])==null?void 0:t.name},le=e=>{var t;return(t=ee.value[e.floorId])==null?void 0:t.name},oe=e=>{var t;return(t=ae.value[e.costId])==null?void 0:t.name},re=e=>{var t;return(t=e.constructionMaterailIds)==null?void 0:t.map((c,B)=>{var V;return{id:B+1,name:((V=te.value[c])==null?void 0:V.name)||"Unknown Material"}})},Ze=e=>{s.value.budgetTables.push({...e,delId:we(),blockValue:se(e),floorValue:le(e),costValue:oe(e),constructionMaterialIdsValue:re(e)}),s.value.price+=parseInt(e.price,10)},ea=n(()=>!!(s.value.budgetTables.length&&Object.keys(Z.value).length&&Object.keys(ee.value).length&&Object.keys(ae.value).length&&Object.keys(te.value).length)),ue=m(!0);U(ea,e=>{e&&ue.value&&(s.value.budgetTables=s.value.budgetTables.map(t=>({...t,delId:we(),blockValue:se(t),floorValue:le(t),costValue:oe(t),constructionMaterialIdsValue:re(t)})),ue.value=!1)},{immediate:!0});const aa=e=>{s.value.budgetTables=s.value.budgetTables.filter(t=>t.delId!==e)},{isError:ta}=([l,i]=v(()=>y({queryKey:["budgetById",q],queryFn:()=>Ea("budget",q.value),select:e=>{s.value.id=e.id,s.value.fullname=e.fullname,s.value.buildingObjectId=[e.buildingObjectId],s.value.price=e.price,s.value.budgetTables=[...e.budgetTables],s.value.details=e.details,s.value.stateId=[e.stateId],K.value=!0},enabled:w})),l=await l,i(),l);U(ta,e=>{e&&R.push(D.HOME.path)});const{mutate:sa}=ka({onMutate:e=>{Q.value=!0,e.budgetTables=e.budgetTables.map(t=>{let c={...t};return delete c.delId,delete c.blockValue,delete c.floorValue,delete c.costValue,delete c.constructionMaterialIdsValue,c}),e.buildingObjectId=e.buildingObjectId[0],e.stateId=e.stateId[0]},mutationFn:e=>Va("budget",e),onSuccess:e=>{G.invalidateQueries({queryKey:["budgets"]}),G.invalidateQueries({queryKey:["budgetById",q]}),R.push(D.ESTIMATE.path)}}),la=()=>{r.value.$validate(),!r.value.$errors.length&&(sa(s.value),r.value.$reset())};return(e,t)=>{var ie,ne,de,ce,me,be,ge,pe,ve,he,Ie,fe,ye,_e,ke,Ee,Ve,Se,Te,$e,Me,Le;const c=I("ManageHead"),B=I("FormInput"),V=I("FormSelect"),oa=I("Spinner"),ra=I("SubTable"),ua=I("FormTextarea"),ia=I("CustomButton");return w.value?(u(),p("section",Ca,[O("div",Fa,[z(c,{title:"addNewEstimateTitle",to:o(D).ESTIMATE.path},null,8,["to"]),O("form",{class:"manage__form",onSubmit:ga(la,["prevent"])},[O("div",Ba,[(u(!0),p(H,null,N(Je.value,a=>{var S,T,$,M,L;return u(),h(B,{key:a.id,modelValue:s.value[a.model],"onUpdate:modelValue":A=>s.value[a.model]=A,width:500,placeholder:e.$t(a.placeholder),name:a.icon,error:(T=(S=o(r))==null?void 0:S[a.errorKey])==null?void 0:T.$error,textError:(L=(M=($=o(r))==null?void 0:$[a.errorKey])==null?void 0:M.$errors[0])==null?void 0:L.$message},{default:k(()=>[E(b(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","name","error","textError"])}),128)),(u(!0),p(H,null,N(Xe.value,a=>{var S,T,$,M,L;return u(),h(V,{key:a.id,modelValue:s.value[a.model],"onUpdate:modelValue":A=>s.value[a.model]=A,modelModifiers:{trim:!0},width:500,options:a.options,error:(T=(S=o(r))==null?void 0:S[a==null?void 0:a.errorKey])==null?void 0:T.$error,placeholder:a==null?void 0:a.placeholder,textError:(L=(M=($=o(r))==null?void 0:$[a==null?void 0:a.errorKey])==null?void 0:M.$errors[0])==null?void 0:L.$message,success:a.success,loading:a.loading},{default:k(()=>[E(b(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","options","error","placeholder","textError","success","loading"])}),128)),z(B,{modelValue:s.value.price,"onUpdate:modelValue":t[0]||(t[0]=a=>s.value.price=a),width:500,placeholder:e.$t("estimatePricePlaceholder"),name:"money",error:(ne=(ie=o(r))==null?void 0:ie.price)==null?void 0:ne.$error,textError:(me=(ce=(de=o(r))==null?void 0:de.price)==null?void 0:ce.$errors[0])==null?void 0:me.$message,isDisabled:!0},{default:k(()=>[E(b(e.$t("estimatePriceLabel")),1)]),_:1},8,["modelValue","placeholder","error","textError"]),z(V,{modelValue:s.value.stateId,"onUpdate:modelValue":t[1]||(t[1]=a=>s.value.stateId=a),modelModifiers:{trim:!0},width:500,options:o(Re),error:(ge=(be=o(r))==null?void 0:be.stateId)==null?void 0:ge.$error,placeholder:"estimateStatePlaceholder",textError:(he=(ve=(pe=o(r))==null?void 0:pe.stateId)==null?void 0:ve.$errors[0])==null?void 0:he.$message,success:o(Qe),loading:o(We)},{default:k(()=>[E(b(e.$t("estimateStateLabel")),1)]),_:1},8,["modelValue","options","error","textError","success","loading"])]),o(W)&&((Ie=o(F))!=null&&Ie.length)?(u(),p("h3",Oa,b(e.$t("blockEstimateLabel")),1)):g("",!0),o(W)&&((fe=o(F))!=null&&fe.length)?(u(),p("ul",ja,[(u(!0),p(H,null,N(o(F),a=>(u(),p("li",{key:a.id,class:"manage__block",onClick:()=>d.value=a.id},[O("div",{class:ha(`manage__block-box ${d.value===a.id?"is-active":""}`)},b(a.name),3)],8,qa))),128))])):g("",!0),o(Ae)?(u(),h(oa,{key:2})):g("",!0),d.value?(u(),h(fa,{key:3,selects:Ye.value,blockId:d.value,onOnAddTable:Ze,onOnChangeBlock:t[2]||(t[2]=a=>d.value=a)},null,8,["selects","blockId"])):g("",!0),(_e=(ye=o(r))==null?void 0:ye.budgetTables)!=null&&_e.$error?(u(),p("span",Ka,b((Ve=(Ee=(ke=o(r))==null?void 0:ke.budgetTables)==null?void 0:Ee.$errors[0])==null?void 0:Ve.$message),1)):g("",!0),d.value?(u(),h(ra,{key:5,headers:Be.value,table:Oe.value,onOnActionDelete:aa,isShowDelete:!0},null,8,["headers","table"])):g("",!0),d.value?(u(),h(ua,{key:6,modelValue:s.value.details,"onUpdate:modelValue":t[3]||(t[3]=a=>s.value.details=a),modelModifiers:{trim:!0},width:500,placeholder:e.$t("estimateCommentPlaceholder"),error:(Te=(Se=o(r))==null?void 0:Se.details)==null?void 0:Te.$error,textError:(Le=(Me=($e=o(r))==null?void 0:$e.details)==null?void 0:Me.$errors[0])==null?void 0:Le.$message},{default:k(()=>[E(b(e.$t("estimateCommentLabel")),1)]),_:1},8,["modelValue","placeholder","error","textError"])):g("",!0),d.value?(u(),h(ia,{key:7,className:"manage__submit"},{default:k(()=>[E(b(e.$t("formButton")),1)]),_:1})):g("",!0)],32)])])):g("",!0)}}},Qa=na(Pa,[["__scopeId","data-v-4f80d23d"]]);export{Qa as default};
