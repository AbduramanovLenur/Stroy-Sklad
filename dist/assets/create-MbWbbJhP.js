import{_ as we,u as Ke,a as qe,b as Fe,y as Ce,c,r as w,z as b,C as Ee,d as S,e as I,k as J,h as d,t as m,i as B,w as $e,F as Y,D as Ne,A as K,l as je,m as L,o as p,s as Z,B as ee,f as q,H as Ve,E as Oe}from"./index-rC1JZu5l.js";import{c as ze}from"./crud.services-RXnC2s99.js";import{u as Pe,r as g}from"./i18n-validators-8hLDNWni.js";import{n as Te,f as Qe,g as Ge,h as Ue,i as He}from"./manual.services-jkM3FzjG.js";import{u as fe}from"./generic.services-N1nKRFvy.js";import{u as h}from"./useQuery-RAea3pH0.js";import{u as Ae}from"./useMutation-RUuAVq9K.js";const De={key:0,class:"manage section-height shadowed"},Re={class:"manage__inner section-padding"},Xe={class:"manage__stock-warehouse"},We={class:"manage__stock-label"},Je={key:0,class:"manage__stock-value"},Ye={class:"manage__overlay"},Ze={__name:"create",async setup(ea){let s,r;const v=fe(),ae=je(),F=Ke(),{t:C}=qe(),se=Fe(),{user:o}=Ce(se),_=c(()=>{var a,n;return!!((n=(a=o==null?void 0:o.value.user)==null?void 0:a.modules)!=null&&n.includes(Ve.EXPENS.CREATE))}),oe=w(!1),t=w({constructionMaterialId:[],count:"",buildingObjectId:[],buildingBlockId:[],floorId:[],costId:[]}),te=c(()=>({constructionMaterialId:{required:g},count:{required:g},buildingObjectId:{required:g},buildingBlockId:{required:g},floorId:{required:g},costId:{required:g}})),u=Pe(te,t),{data:E,isSuccess:re,isLoading:ne}=([s,r]=b(()=>h({queryKey:["warehouseList",{organizationId:o.value.user.organizationId,name:o.value.user.fullName}],queryFn:()=>Te(),enabled:_})),s=await s,r(),s),i=c(()=>{var a;return(a=E.value)==null?void 0:a.filter(n=>{var l;return n.id===((l=t.value.constructionMaterialId)==null?void 0:l[0])})}),{data:le,isSuccess:ue,isLoading:ce}=([s,r]=b(()=>h({queryKey:["objectsList",{organizationId:o.value.user.organizationId,name:o.value.user.fullName}],queryFn:()=>Qe(),enabled:_})),s=await s,r(),s),y=c(()=>t.value.buildingObjectId[0]),ie=c(()=>!!y.value);Ee(y,()=>{oe.value||(t.value.buildingBlockId=[])},{immediate:!0});const{data:de,isSuccess:me,isLoading:pe}=([s,r]=b(()=>h({queryKey:["blocksList",{blockId:y,organizationId:o.value.user.organizationId,name:o.value.user.fullName}],queryFn:()=>Ge(y.value),enabled:ie})),s=await s,r(),s),M=c(()=>t.value.buildingBlockId[0]),ge=c(()=>!!M.value),{data:ve,isSuccess:be,isLoading:Ie}=([s,r]=b(()=>h({queryKey:["floorsList",{floorId:M,organizationId:o.value.user.organizationId,name:o.value.user.fullName}],queryFn:()=>Ue(M.value),enabled:ge})),s=await s,r(),s),{data:he,isSuccess:_e,isLoading:ye}=([s,r]=b(()=>h({queryKey:["costsList",{organizationId:o.value.user.organizationId,name:o.value.user.fullName}],queryFn:()=>He(),enabled:_})),s=await s,r(),s),ke=w([{id:1,model:"constructionMaterialId",label:"expenseMaterialLabel",placeholder:"expenseMaterialPlaceholder",errorKey:"constructionMaterialId",options:E,success:re,loading:ne,select:!0},{id:2,model:"count",label:"expenseCountLabel",placeholder:"expenseCountPlaceholder",icon:"list",errorKey:"count",type:"number"},{id:3,model:"buildingObjectId",label:"expenseObjectLabel",placeholder:"expenseObjectPlaceholder",errorKey:"buildingObjectId",options:le,success:ue,loading:ce,select:!0},{id:4,model:"buildingBlockId",label:"expenseBlockLabel",placeholder:"expenseBlockPlaceholder",errorKey:"buildingBlockId",options:de,success:me,loading:pe,select:!0},{id:5,model:"floorId",label:"expenseFloorLabel",placeholder:"expenseFloorPlaceholder",errorKey:"floorId",options:ve,success:be,loading:Ie,select:!0},{id:6,model:"costId",label:"expenseCostLabel",placeholder:"expenseCostPlaceholder",errorKey:"costId",options:he,success:_e,loading:ye,select:!0}]),{mutate:Se,status:Be}=Ae({onMutate:a=>{a.constructionMaterialId=a.constructionMaterialId[0],a.buildingObjectId=a.buildingObjectId[0],a.buildingBlockId=a.buildingBlockId[0],a.floorId=a.floorId[0],a.costId=a.costId[0]},mutationFn:a=>ze("expense",a),onSuccess:a=>{var n,l;a!=null&&a.success&&(v.invalidateQueries({queryKey:["expenses"]}),v.invalidateQueries({queryKey:["warehouse"]}),v.invalidateQueries({queryKey:["warehouseById",(l=(n=i.value)==null?void 0:n[0])==null?void 0:l.warehouseId.toString()]}),v.invalidateQueries({queryKey:["warehouseList"]}),v.invalidateQueries({queryKey:["reports","expense"]}),t.value=Oe(t.value),ae.push(Z.EXPENS.path),setTimeout(()=>F.success(C("createToast")),150))}}),Le=()=>{var l,k;if(((k=(l=i.value)==null?void 0:l[0])==null?void 0:k.count)-t.value.count<0){F.error(C("negativeMeaningToast"));return}if(u.value.$validate(),u.value.$errors.length)return;const n={...t.value};Se(n),u.value.$reset()};return(a,n)=>{var $,N,j,V,O,z,P,T;const l=L("ManageHead"),k=L("FormInput"),Me=L("FormSelect"),xe=L("CustomButton");return _.value?(p(),S("section",De,[I("div",Re,[J(l,{title:"addNewExpensesTitle",to:d(Z).EXPENS.path},null,8,["to"]),I("div",Xe,[I("div",We,m((N=($=i.value)==null?void 0:$[0])!=null&&N.count?a.$t("expenseStockMaterial"):a.$t("expenseSampleMaterial")),1),(V=(j=i.value)==null?void 0:j[0])!=null&&V.count?(p(),S("div",Je,m((z=(O=i.value)==null?void 0:O[0])==null?void 0:z.count)+" "+m((T=(P=i.value)==null?void 0:P[0])==null?void 0:T.quantityType),1)):B("",!0)]),I("form",{class:"manage__form",onSubmit:$e(Le,["prevent"])},[I("div",Ye,[(p(!0),S(Y,null,Ne(ke.value,e=>{var Q,G,U,H,f,A,D,R,X,W;return p(),S(Y,{key:e.id},[e!=null&&e.select?B("",!0):(p(),ee(k,{key:0,modelValue:t.value[e.model],"onUpdate:modelValue":x=>t.value[e.model]=x,width:500,placeholder:a.$t(e.placeholder),name:e.icon,error:(G=(Q=d(u))==null?void 0:Q[e.errorKey])==null?void 0:G.$error,textError:(f=(H=(U=d(u))==null?void 0:U[e.errorKey])==null?void 0:H.$errors[0])==null?void 0:f.$message,type:e==null?void 0:e.type},{default:K(()=>[q(m(a.$t(e.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","name","error","textError","type"])),e!=null&&e.select?(p(),ee(Me,{key:1,modelValue:t.value[e.model],"onUpdate:modelValue":x=>t.value[e.model]=x,modelModifiers:{trim:!0},width:500,options:e.options,error:(D=(A=d(u))==null?void 0:A[e==null?void 0:e.errorKey])==null?void 0:D.$error,placeholder:e==null?void 0:e.placeholder,textError:(W=(X=(R=d(u))==null?void 0:R[e==null?void 0:e.errorKey])==null?void 0:X.$errors[0])==null?void 0:W.$message,success:e.success,loading:e.loading},{default:K(()=>[q(m(a.$t(e.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","options","error","placeholder","textError","success","loading"])):B("",!0)],64)}),128))]),J(xe,{className:"manage__submit",disabled:d(Be)==="pending"},{default:K(()=>[q(m(a.$t("formButton")),1)]),_:1},8,["disabled"])],32)])])):B("",!0)}}},ua=we(Ze,[["__scopeId","data-v-eb703973"]]);export{ua as default};
