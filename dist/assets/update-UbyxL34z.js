import{_ as ca,u as ma,a as ba,b as ga,x as pa,c as n,r as m,y as v,B as U,d as p,e as O,k as z,h as o,w as va,F as D,C as H,D as k,t as b,i as g,z as h,l as ha,E as Ia,m as I,o as u,A as N,f as E,H as fa,G as ya,I as j}from"./index-dNR7J35r.js";import{E as _a}from"./EstimateForm-zXypVIod.js";import{u as ka,r as f}from"./i18n-validators-yhWyvfAc.js";import{a as Ea,u as Va}from"./generic.services-95joJjsH.js";import{u as y}from"./useQuery-64zn7DqL.js";import{a as Sa,u as Ta}from"./crud.services-Wr6W6qUE.js";import{f as $a,g as Ma,h as La,i as wa,j as Ca,b as Fa}from"./manual.services-Cu3jPfWO.js";import{v as Ce}from"./v4-yQnnJER4.js";const Ba={key:0,class:"manage section-height shadowed"},Oa={class:"manage__inner section-padding"},ja={class:"manage__overlay"},qa={key:0,class:"manage__title"},Ka={key:1,class:"manage__blocks"},xa=["onClick"],Pa={key:4,class:"error"},Aa={__name:"update",async setup(Ua){let l,i;const G=Ea(),R=ha(),Fe=Ia(),Be=ma(),{t:Oe}=ba(),je=ga(),{user:_}=pa(je),w=n(()=>{var e,t;return!!((t=(e=_==null?void 0:_.value.user)==null?void 0:e.modules)!=null&&t.includes(ya.ESTIMATE.CREATE))}),q=m(Fe.params.id),qe=m([{id:1,label:"estimateBlock",width:200},{id:2,label:"estimateFloor",width:200},{id:3,label:"estimateMaterial",width:260},{id:4,label:"estimateBudget",width:200},{id:5,label:"estimateCost"}]),s=m({id:"",fullname:"",buildingObjectId:[],price:"",budgetTables:[],details:"",stateId:[]}),Q=m(!1),K=m(!1),d=m(""),Ke=n(()=>s.value.budgetTables.filter(e=>+e.buildingBlockId==+d.value)),xe=n(()=>({id:{required:f},fullname:{required:f},buildingObjectId:{required:f},price:{required:f},budgetTables:{required:f},details:{required:f},stateId:{required:f}})),r=ka(xe,s),{data:Pe,isSuccess:Ae,isLoading:Ue}=([l,i]=v(()=>y({queryKey:["objectsList",{organizationId:_.value.user.organizationId}],queryFn:()=>$a(),enabled:w})),l=await l,i(),l),C=n(()=>s.value.buildingObjectId),ze=n(()=>!!C.value.length);U(C,()=>{!K.value&&!Q.value&&(s.value.budgetTables=[],d.value=""),K.value=!1},{immediate:!0});const{data:F,isSuccess:W,isLoading:De}=([l,i]=v(()=>y({queryKey:["blocksList",{blockId:C}],queryFn:()=>wa(C.value[0]),enabled:ze})),l=await l,i(),l),x=n(()=>d.value),P=n(()=>!!x.value),{data:J,isSuccess:He,isLoading:Ne}=([l,i]=v(()=>y({queryKey:["floorsList",{floorId:x}],queryFn:()=>Ca(x.value),enabled:P})),l=await l,i(),l),{data:X,isSuccess:Ge,isLoading:Re}=([l,i]=v(()=>y({queryKey:["costsList",{organizationId:_.value.user.organizationId}],queryFn:()=>Ma(),enabled:P})),l=await l,i(),l),{data:Y,isSuccess:Qe,isLoading:We}=([l,i]=v(()=>y({queryKey:["materialsList",{organizationId:_.value.user.organizationId}],queryFn:()=>La(),enabled:P})),l=await l,i(),l),{data:Je,isSuccess:Xe,isLoading:Ye}=([l,i]=v(()=>y({queryKey:["states"],queryFn:()=>Fa(),enabled:w})),l=await l,i(),l),Ze=m([{id:1,model:"fullname",label:"nameEstimateLabel",placeholder:"nameEstimatePlaceholder",icon:"input-company",errorKey:"fullname"}]),ea=m([{id:1,model:"buildingObjectId",label:"objectEstimateLabel",placeholder:"objectEstimatePlaceholder",errorKey:"buildingObjectId",options:Pe,success:Ae,loading:Ue}]),aa=m([{id:1,model:"floorId",label:"floorsEstimateLabel",placeholder:"floorsEstimatePlaceholder",options:J,success:He,loading:Ne},{id:2,model:"costId",label:"costEstimateLabel",placeholder:"costEstimatePlaceholder",options:X,success:Ge,loading:Re},{id:3,model:"constructionMaterailIds",label:"materialsEstimateLabel",placeholder:"materialsEstimatePlaceholder",options:Y,success:Qe,loading:We,multiple:!0}]),Z=n(()=>j(F.value||[])),ee=n(()=>j(J.value||[])),ae=n(()=>j(X.value||[])),te=n(()=>j(Y.value||[])),se=e=>{var t;return(t=Z.value[e.buildingBlockId])==null?void 0:t.name},le=e=>{var t;return(t=ee.value[e.floorId])==null?void 0:t.name},oe=e=>{var t;return(t=ae.value[e.costId])==null?void 0:t.name},re=e=>{var t;return(t=e.constructionMaterailIds)==null?void 0:t.map((c,B)=>{var V;return{id:B+1,name:((V=te.value[c])==null?void 0:V.name)||"Unknown Material"}})},ue=n(()=>!!(s.value.budgetTables.length&&Object.keys(Z.value).length&&Object.keys(ee.value).length&&Object.keys(ae.value).length&&Object.keys(te.value).length)),ta=e=>{if(ue){s.value.budgetTables.push({...e,delId:Ce(),blockValue:se(e),floorValue:le(e),costValue:oe(e),constructionMaterialIdsValue:re(e)}),s.value.price=+s.value.price+ +e.price;return}Be.error(Oe("estimateEmptyData"))},ie=m(!0);U(ue,e=>{e&&ie.value&&(s.value.budgetTables=s.value.budgetTables.map(t=>({...t,delId:Ce(),blockValue:se(t),floorValue:le(t),costValue:oe(t),constructionMaterialIdsValue:re(t)})),ie.value=!1)},{immediate:!0});const sa=e=>{s.value.budgetTables=s.value.budgetTables.filter(t=>t.delId!==e)},{isError:la}=([l,i]=v(()=>y({queryKey:["budgetsById",q],queryFn:()=>Sa("budget",q.value),select:e=>{s.value.id=e.id,s.value.fullname=e.fullname,s.value.buildingObjectId=[e.buildingObjectId],s.value.price=e.price,s.value.budgetTables=[...e.budgetTables],s.value.details=e.details,s.value.stateId=[e.stateId],K.value=!0},enabled:w})),l=await l,i(),l);U(la,e=>{e&&R.push(N.HOME.path)});const{mutate:oa}=Va({onMutate:e=>{Q.value=!0,e.budgetTables=e.budgetTables.map(t=>{let c={...t};return delete c.delId,delete c.blockValue,delete c.floorValue,delete c.costValue,delete c.constructionMaterialIdsValue,c}),e.buildingObjectId=e.buildingObjectId[0],e.stateId=e.stateId[0]},mutationFn:e=>Ta("budget",e),onSuccess:()=>{G.invalidateQueries({queryKey:["budgets"]}),G.invalidateQueries({queryKey:["budgetsById",q]}),R.push(N.ESTIMATE.path)}}),ra=()=>{r.value.$validate(),!r.value.$errors.length&&(oa(s.value),r.value.$reset())};return(e,t)=>{var ne,de,ce,me,be,ge,pe,ve,he,Ie,fe,ye,_e,ke,Ee,Ve,Se,Te,$e,Me,Le,we;const c=I("ManageHead"),B=I("FormInput"),V=I("FormSelect"),ua=I("Spinner"),ia=I("SubTable"),na=I("FormTextarea"),da=I("CustomButton");return w.value?(u(),p("section",Ba,[O("div",Oa,[z(c,{title:"addNewEstimateTitle",to:o(N).ESTIMATE.path},null,8,["to"]),O("form",{class:"manage__form",onSubmit:va(ra,["prevent"])},[O("div",ja,[(u(!0),p(D,null,H(Ze.value,a=>{var S,T,$,M,L;return u(),h(B,{key:a.id,modelValue:s.value[a.model],"onUpdate:modelValue":A=>s.value[a.model]=A,width:500,placeholder:e.$t(a.placeholder),name:a.icon,error:(T=(S=o(r))==null?void 0:S[a.errorKey])==null?void 0:T.$error,textError:(L=(M=($=o(r))==null?void 0:$[a.errorKey])==null?void 0:M.$errors[0])==null?void 0:L.$message},{default:k(()=>[E(b(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","name","error","textError"])}),128)),(u(!0),p(D,null,H(ea.value,a=>{var S,T,$,M,L;return u(),h(V,{key:a.id,modelValue:s.value[a.model],"onUpdate:modelValue":A=>s.value[a.model]=A,modelModifiers:{trim:!0},width:500,options:a.options,error:(T=(S=o(r))==null?void 0:S[a==null?void 0:a.errorKey])==null?void 0:T.$error,placeholder:a==null?void 0:a.placeholder,textError:(L=(M=($=o(r))==null?void 0:$[a==null?void 0:a.errorKey])==null?void 0:M.$errors[0])==null?void 0:L.$message,success:a.success,loading:a.loading},{default:k(()=>[E(b(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","options","error","placeholder","textError","success","loading"])}),128)),z(B,{modelValue:s.value.price,"onUpdate:modelValue":t[0]||(t[0]=a=>s.value.price=a),width:500,placeholder:e.$t("estimatePricePlaceholder"),name:"money",error:(de=(ne=o(r))==null?void 0:ne.price)==null?void 0:de.$error,textError:(be=(me=(ce=o(r))==null?void 0:ce.price)==null?void 0:me.$errors[0])==null?void 0:be.$message,isDisabled:!0},{default:k(()=>[E(b(e.$t("estimatePriceLabel")),1)]),_:1},8,["modelValue","placeholder","error","textError"]),z(V,{modelValue:s.value.stateId,"onUpdate:modelValue":t[1]||(t[1]=a=>s.value.stateId=a),modelModifiers:{trim:!0},width:500,options:o(Je),error:(pe=(ge=o(r))==null?void 0:ge.stateId)==null?void 0:pe.$error,placeholder:"estimateStatePlaceholder",textError:(Ie=(he=(ve=o(r))==null?void 0:ve.stateId)==null?void 0:he.$errors[0])==null?void 0:Ie.$message,success:o(Xe),loading:o(Ye)},{default:k(()=>[E(b(e.$t("estimateStateLabel")),1)]),_:1},8,["modelValue","options","error","textError","success","loading"])]),o(W)&&((fe=o(F))!=null&&fe.length)?(u(),p("h3",qa,b(e.$t("blockEstimateLabel")),1)):g("",!0),o(W)&&((ye=o(F))!=null&&ye.length)?(u(),p("ul",Ka,[(u(!0),p(D,null,H(o(F),a=>(u(),p("li",{key:a.id,class:"manage__block",onClick:()=>d.value=a.id},[O("div",{class:fa(`manage__block-box ${d.value===a.id?"is-active":""}`)},b(a.name),3)],8,xa))),128))])):g("",!0),o(De)?(u(),h(ua,{key:2})):g("",!0),d.value?(u(),h(_a,{key:3,selects:aa.value,blockId:d.value,onOnAddTable:ta,onOnChangeBlock:t[2]||(t[2]=a=>d.value=a)},null,8,["selects","blockId"])):g("",!0),(ke=(_e=o(r))==null?void 0:_e.budgetTables)!=null&&ke.$error?(u(),p("span",Pa,b((Se=(Ve=(Ee=o(r))==null?void 0:Ee.budgetTables)==null?void 0:Ve.$errors[0])==null?void 0:Se.$message),1)):g("",!0),d.value?(u(),h(ia,{key:5,headers:qe.value,table:Ke.value,onOnActionDelete:sa,isShowDelete:!0},null,8,["headers","table"])):g("",!0),d.value?(u(),h(na,{key:6,modelValue:s.value.details,"onUpdate:modelValue":t[3]||(t[3]=a=>s.value.details=a),modelModifiers:{trim:!0},width:500,placeholder:e.$t("estimateCommentPlaceholder"),error:($e=(Te=o(r))==null?void 0:Te.details)==null?void 0:$e.$error,textError:(we=(Le=(Me=o(r))==null?void 0:Me.details)==null?void 0:Le.$errors[0])==null?void 0:we.$message},{default:k(()=>[E(b(e.$t("estimateCommentLabel")),1)]),_:1},8,["modelValue","placeholder","error","textError"])):g("",!0),d.value?(u(),h(da,{key:7,className:"manage__submit"},{default:k(()=>[E(b(e.$t("formButton")),1)]),_:1})):g("",!0)],32)])])):g("",!0)}}},Ja=ca(Aa,[["__scopeId","data-v-0a707d86"]]);export{Ja as default};
//# sourceMappingURL=update-UbyxL34z.js.map
