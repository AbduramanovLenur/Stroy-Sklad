import{_ as oa,u as ra,a as ua,b as na,y as ia,c as n,r as m,z as v,B as f,d as p,e as L,k as ca,h as o,w as da,F as z,C as Me,t as h,i as d,A as I,D as F,l as ma,G as ba,m as y,o as r,s as P,f as w,I as ga,H as pa,J as C,E as va}from"./index-qYaOSAk5.js";import{E as ha}from"./EstimateForm-RJ57bByY.js";import{u as Ia,r as _}from"./i18n-validators-FA-njMbI.js";import{a as ya,u as _a}from"./generic.services-uSp9rJcx.js";import{u as k}from"./useQuery-3KlBkAoQ.js";import{a as ka,u as Ea}from"./crud.services-6H1cbtzh.js";import{f as Sa,g as Ta,h as Va,i as Ma,j as La,b as Fa}from"./manual.services-e5QN_9-o.js";import{v as Le}from"./v4-yQnnJER4.js";const wa={key:0,class:"manage section-height shadowed"},Ca={class:"manage__inner section-padding"},$a={class:"manage__overlay"},Ba={key:0,class:"manage__title"},ja={key:1,class:"manage__blocks"},Oa=["onClick"],qa={key:3,class:"error"},Ka={__name:"update",async setup(fa){let l,u;const A=ya(),D=ma(),Fe=ba(),we=ra(),{t:Ce}=ua(),$e=na(),{user:b}=ia($e),S=n(()=>{var e,t;return!!((t=(e=b==null?void 0:b.value.user)==null?void 0:e.modules)!=null&&t.includes(pa.ESTIMATE.CREATE))}),$=m(Fe.params.id),Be=m([{id:1,label:"estimateBlock",width:15},{id:2,label:"estimateFloor",width:20},{id:3,label:"estimateMaterial",width:25},{id:4,label:"estimateBudget",width:20},{id:5,label:"estimateCost",width:20}]),s=m({id:"",fullname:"",buildingObjectId:[],price:"",budgetTables:[],details:"",stateId:[]}),x=m(!1),B=m(!1),i=m(""),je=n(()=>s.value.budgetTables.filter(e=>+e.buildingBlockId==+i.value)),Oe=n(()=>({id:{required:_},fullname:{required:_},buildingObjectId:{required:_},price:{required:_},budgetTables:{required:_},details:{required:_},stateId:{required:_}})),c=Ia(Oe,s),{data:qe,isSuccess:Ke,isLoading:fe}=([l,u]=v(()=>k({queryKey:["objectsList",{organizationId:b.value.user.organizationId}],queryFn:()=>Sa(),enabled:S})),l=await l,u(),l),T=n(()=>s.value.buildingObjectId[0]),ze=n(()=>!!T.value);f(T,()=>{!B.value&&!x.value&&(s.value.budgetTables=[],i.value=""),B.value=!1},{immediate:!0});const{data:V,isSuccess:N,isLoading:Pe}=([l,u]=v(()=>k({queryKey:["blocksList",{objectId:T,organizationId:b.value.user.organizationId}],queryFn:()=>Ta(T.value),enabled:ze})),l=await l,u(),l),j=n(()=>i.value),O=n(()=>!!j.value),{data:U,isSuccess:Ae,isLoading:De}=([l,u]=v(()=>k({queryKey:["floorsList",{blockId:j,organizationId:b.value.user.organizationId}],queryFn:()=>Va(j.value),enabled:O})),l=await l,u(),l),{data:G,isSuccess:xe,isLoading:Ne}=([l,u]=v(()=>k({queryKey:["costsList",{organizationId:b.value.user.organizationId}],queryFn:()=>Ma(),enabled:O})),l=await l,u(),l),{data:H,isSuccess:Ue,isLoading:Ge}=([l,u]=v(()=>k({queryKey:["materialsList",{organizationId:b.value.user.organizationId}],queryFn:()=>La(),enabled:O})),l=await l,u(),l),{data:He,isSuccess:Re,isLoading:Qe}=([l,u]=v(()=>k({queryKey:["states"],queryFn:()=>Fa(),enabled:S})),l=await l,u(),l),Je=m([{id:1,model:"fullname",label:"nameEstimateLabel",placeholder:"nameEstimatePlaceholder",icon:"input-company",errorKey:"fullname"},{id:2,model:"buildingObjectId",label:"objectEstimateLabel",placeholder:"objectEstimatePlaceholder",errorKey:"buildingObjectId",options:qe,success:Ke,loading:fe,select:!0},{id:3,model:"price",label:"estimatePriceLabel",placeholder:"estimatePricePlaceholder",icon:"money",errorKey:"price",isDisabled:!0},{id:4,model:"stateId",label:"estimateStateLabel",placeholder:"estimateStatePlaceholder",errorKey:"stateId",options:He,success:Re,loading:Qe,select:!0}]),We=m([{id:1,model:"floorId",label:"floorsEstimateLabel",placeholder:"floorsEstimatePlaceholder",options:U,success:Ae,loading:De,select:!0},{id:2,model:"costId",label:"costEstimateLabel",placeholder:"costEstimatePlaceholder",options:G,success:xe,loading:Ne,select:!0},{id:3,model:"constructionMaterailIds",label:"materialsEstimateLabel",placeholder:"materialsEstimatePlaceholder",options:H,success:Ue,loading:Ge,multiple:!0,select:!0},{id:4,model:"price",label:"priceEstimateLabel",placeholder:"priceEstimatePlaceholder",icon:"money"}]),R=n(()=>C(V.value||[])),Q=n(()=>C(U.value||[])),J=n(()=>C(G.value||[])),W=n(()=>C(H.value||[])),X=e=>{var t;return(t=R.value[e.buildingBlockId])==null?void 0:t.name},Y=e=>{var t;return(t=Q.value[e.floorId])==null?void 0:t.name},Z=e=>{var t;return(t=J.value[e.costId])==null?void 0:t.name},ee=e=>{var t;return(t=e.constructionMaterailIds)==null?void 0:t.map((g,M)=>{var E;return{id:M+1,name:((E=W.value[g])==null?void 0:E.name)||"Unknown Material"}})},Xe=n(()=>!!(s.value.budgetTables.length&&Object.keys(R.value).length&&Object.keys(Q.value).length&&Object.keys(J.value).length&&Object.keys(W.value).length)),ae=m(!0);f(Xe,e=>{e&&ae.value&&(s.value.budgetTables=s.value.budgetTables.map(t=>({...t,delId:Le(),blockValue:X(t),floorValue:Y(t),costValue:Z(t),constructionMaterialIdsValue:ee(t)})),ae.value=!1)},{immediate:!0});const Ye=e=>{s.value.budgetTables.push({...e,delId:Le(),blockValue:X(e),floorValue:Y(e),costValue:Z(e),constructionMaterialIdsValue:ee(e)}),s.value.price=+s.value.price+e.price},Ze=e=>{s.value.budgetTables=s.value.budgetTables.filter(t=>{const g=t.delId!==e;return g||(s.value.price-=t.price),g})},{isError:ea}=([l,u]=v(()=>k({queryKey:["budgetById",$],queryFn:()=>ka("budget",$.value),select:e=>{s.value.id=e.id,s.value.fullname=e.fullname,s.value.buildingObjectId=[e.buildingObjectId],s.value.price=e.price,s.value.budgetTables=[...e.budgetTables],s.value.details=e.details,s.value.stateId=[e.stateId],B.value=!0},enabled:S})),l=await l,u(),l);f(ea,e=>{e&&D.push(P.ESTIMATE.path)});const{mutate:aa,status:ta}=_a({onMutate:e=>{x.value=!0,e.budgetTables=e.budgetTables.map(t=>{const{delId:g,blockValue:M,floorValue:E,costValue:te,constructionMaterialIdsValue:se,...q}=t;return q}),e.buildingObjectId=e.buildingObjectId[0],e.stateId=e.stateId[0]},mutationFn:e=>Ea("budget",e),onSuccess:e=>{e!=null&&e.success&&(s.value=va(s.value),A.invalidateQueries({queryKey:["budgets"]}),A.invalidateQueries({queryKey:["budgetById",$]}),D.push(P.ESTIMATE.path),setTimeout(()=>we.success(Ce("updateToast")),150))}}),sa=()=>{if(c.value.$validate(),c.value.$errors.length)return;const e={...s.value};aa(e),c.value.$reset()};return(e,t)=>{var le,oe,re,ue,ne,ie,ce,de,me,be,ge,pe;const g=y("ManageHead"),M=y("FormInput"),E=y("FormSelect"),te=y("SubTable"),se=y("FormTextarea"),q=y("CustomButton"),la=y("Spinner");return S.value?(r(),p("section",wa,[L("div",Ca,[ca(g,{title:"addNewEstimateTitle",to:o(P).ESTIMATE.path},null,8,["to"]),L("form",{class:"manage__form",onSubmit:da(sa,["prevent"])},[L("div",$a,[(r(!0),p(z,null,Me(Je.value,a=>{var ve,he,Ie,ye,_e,ke,Ee,Se,Te,Ve;return r(),p(z,{key:a.id},[a!=null&&a.select?d("",!0):(r(),I(M,{key:0,modelValue:s.value[a.model],"onUpdate:modelValue":K=>s.value[a.model]=K,width:500,placeholder:e.$t(a.placeholder),name:a.icon,error:(he=(ve=o(c))==null?void 0:ve[a.errorKey])==null?void 0:he.$error,textError:(_e=(ye=(Ie=o(c))==null?void 0:Ie[a.errorKey])==null?void 0:ye.$errors[0])==null?void 0:_e.$message,isDisabled:a==null?void 0:a.isDisabled},{default:F(()=>[w(h(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","name","error","textError","isDisabled"])),a!=null&&a.select?(r(),I(E,{key:1,modelValue:s.value[a.model],"onUpdate:modelValue":K=>s.value[a.model]=K,modelModifiers:{trim:!0},width:500,options:a.options,error:(Ee=(ke=o(c))==null?void 0:ke[a==null?void 0:a.errorKey])==null?void 0:Ee.$error,placeholder:a==null?void 0:a.placeholder,textError:(Ve=(Te=(Se=o(c))==null?void 0:Se[a==null?void 0:a.errorKey])==null?void 0:Te.$errors[0])==null?void 0:Ve.$message,success:a.success,loading:a.loading},{default:F(()=>[w(h(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","options","error","placeholder","textError","success","loading"])):d("",!0)],64)}),128))]),o(N)&&((le=o(V))!=null&&le.length)?(r(),p("h3",Ba,h(e.$t("blockEstimateLabel")),1)):d("",!0),o(N)&&((oe=o(V))!=null&&oe.length)?(r(),p("ul",ja,[(r(!0),p(z,null,Me(o(V),a=>(r(),p("li",{key:a.id,class:"manage__block",onClick:()=>i.value=a.id},[L("div",{class:ga(`manage__block-box ${i.value===a.id?"is-active":""}`)},h(a.name),3)],8,Oa))),128))])):d("",!0),i.value?(r(),I(ha,{key:2,subFields:We.value,blockId:i.value,onOnAddTable:Ye,onOnChangeBlock:t[0]||(t[0]=a=>i.value=a)},null,8,["subFields","blockId"])):d("",!0),(ue=(re=o(c))==null?void 0:re.budgetTables)!=null&&ue.$error?(r(),p("span",qa,h((ce=(ie=(ne=o(c))==null?void 0:ne.budgetTables)==null?void 0:ie.$errors[0])==null?void 0:ce.$message),1)):d("",!0),i.value?(r(),I(te,{key:4,headers:Be.value,table:je.value,onOnActionDelete:Ze,isShowDelete:!0},null,8,["headers","table"])):d("",!0),i.value?(r(),I(se,{key:5,modelValue:s.value.details,"onUpdate:modelValue":t[1]||(t[1]=a=>s.value.details=a),modelModifiers:{trim:!0},width:500,placeholder:e.$t("estimateCommentPlaceholder"),error:(me=(de=o(c))==null?void 0:de.details)==null?void 0:me.$error,textError:(pe=(ge=(be=o(c))==null?void 0:be.details)==null?void 0:ge.$errors[0])==null?void 0:pe.$message},{default:F(()=>[w(h(e.$t("estimateCommentLabel")),1)]),_:1},8,["modelValue","placeholder","error","textError"])):d("",!0),i.value?(r(),I(q,{key:6,className:"manage__submit",disabled:o(ta)==="pending"},{default:F(()=>[w(h(e.$t("formButton")),1)]),_:1},8,["disabled"])):d("",!0)],32),o(Pe)?(r(),I(la,{key:0})):d("",!0)])])):d("",!0)}}},Ha=oa(Ka,[["__scopeId","data-v-169b138f"]]);export{Ha as default};
