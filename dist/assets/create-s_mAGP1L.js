import{_ as Ye,u as Ze,a as ea,b as aa,x as ta,c as i,r as c,y as M,B as la,d as m,e as K,k as be,h as l,w as oa,F as j,C as q,D as L,t as f,i as b,z as I,l as sa,m as k,o as r,A as pe,f as w,H as ra,G as na,I as x}from"./index-JvbhfmnW.js";import{E as ia}from"./EstimateForm-K-Qv4RV9.js";import{u as ua,r as C}from"./i18n-validators-pdrHvBMx.js";import{a as da,u as ca}from"./generic.services-nPQjChLr.js";import{u as F}from"./useQuery-83Oo_vnt.js";import{c as ma}from"./crud.services-ysnFdDpK.js";import{f as ba,g as pa,h as va,i as ga,j as ha}from"./manual.services-jHvvpFhH.js";import{v as ve}from"./v4-yQnnJER4.js";const _a={key:0,class:"manage section-height shadowed"},ya={class:"manage__inner section-padding"},fa={class:"manage__overlay"},Ia={key:0,class:"manage__title"},ka={key:1,class:"manage__blocks"},Ea=["onClick"],$a={key:4,class:"error"},Sa={__name:"create",async setup(Va){let o,d;const ge=da(),he=sa(),_e=Ze(),{t:ye}=ea(),fe=aa(),{user:E}=ta(fe),U=i(()=>{var a,t;return!!((t=(a=E==null?void 0:E.value.user)==null?void 0:a.modules)!=null&&t.includes(na.ESTIMATE.CREATE))}),Ie=c([{id:1,label:"estimateBlock",width:200},{id:2,label:"estimateFloor",width:200},{id:3,label:"estimateMaterial",width:260},{id:4,label:"estimateBudget",width:200},{id:5,label:"estimateCost"}]),s=c({fullname:"",buildingObjectId:[],price:"",tables:[],details:""}),z=c(!1),u=c(""),S=c([]),ke=i(()=>S.value.filter(a=>+a.blockId==+u.value)),Ee=i(()=>({fullname:{required:C},buildingObjectId:{required:C},price:{required:C},tables:{required:C},details:{required:C}})),n=ua(Ee,s),{data:$e,isSuccess:Se,isLoading:Ve}=([o,d]=M(()=>F({queryKey:["objectsList",{organizationId:E.value.user.organizationId}],queryFn:()=>ba(),enabled:U})),o=await o,d(),o),B=i(()=>s.value.buildingObjectId),Me=i(()=>!!B.value.length);la(B,()=>{z.value||(s.value.tables=[],S.value=[],u.value="")},{immediate:!0});const{data:p,isSuccess:D,isLoading:Le}=([o,d]=M(()=>F({queryKey:["blocksList",{blockId:B}],queryFn:()=>ga(B.value[0]),enabled:Me})),o=await o,d(),o),A=i(()=>u.value),P=i(()=>!!A.value),{data:N,isSuccess:we,isLoading:Ce}=([o,d]=M(()=>F({queryKey:["floorsList",{floorId:A}],queryFn:()=>ha(A.value),enabled:P})),o=await o,d(),o),{data:H,isSuccess:Fe,isLoading:Be}=([o,d]=M(()=>F({queryKey:["costsList",{organizationId:E.value.user.organizationId}],queryFn:()=>pa(),enabled:P})),o=await o,d(),o),{data:G,isSuccess:Oe,isLoading:Te}=([o,d]=M(()=>F({queryKey:["materialsList",{organizationId:E.value.user.organizationId}],queryFn:()=>va(),enabled:P})),o=await o,d(),o),Ke=c([{id:1,model:"fullname",label:"nameEstimateLabel",placeholder:"nameEstimatePlaceholder",icon:"input-company",errorKey:"fullname"}]),je=c([{id:1,model:"buildingObjectId",label:"objectEstimateLabel",placeholder:"objectEstimatePlaceholder",errorKey:"buildingObjectId",options:$e,success:Se,loading:Ve}]),qe=c([{id:1,model:"floorId",label:"floorsEstimateLabel",placeholder:"floorsEstimatePlaceholder",options:N,success:we,loading:Ce},{id:2,model:"costId",label:"costEstimateLabel",placeholder:"costEstimatePlaceholder",options:H,success:Fe,loading:Be},{id:3,model:"constructionMaterailIds",label:"materialsEstimateLabel",placeholder:"materialsEstimatePlaceholder",options:G,success:Oe,loading:Te,multiple:!0}]),xe=c([{id:1,model:"details",label:"estimateCommentLabel",placeholder:"estimateCommentPlaceholder",errorKey:"details"}]),Q=i(()=>x(p.value||[])),R=i(()=>x(N.value||[])),J=i(()=>x(H.value||[])),W=i(()=>x(G.value||[])),Ae=a=>{var t;return(t=Q.value[a.buildingBlockId])==null?void 0:t.name},Pe=a=>{var t;return(t=R.value[a.floorId])==null?void 0:t.name},Ue=a=>{var t;return(t=J.value[a.costId])==null?void 0:t.name},ze=a=>{var t;return(t=a.constructionMaterailIds)==null?void 0:t.map(($,O)=>{var T;return{id:O+1,name:((T=W.value[$])==null?void 0:T.name)||"Unknown Material"}})},De=i(()=>s.value.budgetTables.length&&Object.keys(Q.value).length&&Object.keys(R.value).length&&Object.keys(J.value).length&&Object.keys(W.value).length),Ne=a=>{if(De){S.value.push({delId:ve(),blockValue:Ae(a),blockId:a.buildingBlockId,floorValue:Pe(a),costValue:Ue(a),constructionMaterialIdsValue:ze(a),price:a.price}),s.value.tables.push({delId:ve(),...a}),s.value.price=+s.value.price+ +a.price;return}_e.error(ye("estimateEmptyData"))},He=a=>{s.value.tables=s.value.tables.filter(t=>t.delId!==a),S.value=S.value.filter(t=>t.delId!==a)},{mutate:Ge}=ca({onMutate:a=>{z.value=!0,a.tables=a.tables.map(t=>{console.log(t);let $={...t};return delete $.delId,$}),a.buildingObjectId=a.buildingObjectId[0]},mutationFn:a=>ma("budget",a),onSuccess:()=>{ge.invalidateQueries({queryKey:["budgets"]}),he.push(pe.ESTIMATE.path)}}),Qe=()=>{n.value.$validate(),!n.value.$errors.length&&(Ge(s.value),n.value.$reset())};return(a,t)=>{var X,Y,Z,ee,ae,te,le,oe,se,re,ne,ie,ue,de,ce,me;const $=k("ManageHead"),O=k("FormInput"),T=k("FormSelect"),Re=k("Spinner"),Je=k("SubTable"),We=k("FormTextarea"),Xe=k("CustomButton");return U.value?(r(),m("section",_a,[K("div",ya,[be($,{title:"addNewEstimateTitle",to:l(pe).ESTIMATE.path},null,8,["to"]),K("form",{class:"manage__form",onSubmit:oa(Qe,["prevent"])},[K("div",fa,[(r(!0),m(j,null,q(Ke.value,e=>{var v,g,h,_,y;return r(),I(O,{key:e.id,modelValue:s.value[e.model],"onUpdate:modelValue":V=>s.value[e.model]=V,width:500,placeholder:a.$t(e.placeholder),name:e.icon,error:(g=(v=l(n))==null?void 0:v[e.errorKey])==null?void 0:g.$error,textError:(y=(_=(h=l(n))==null?void 0:h[e.errorKey])==null?void 0:_.$errors[0])==null?void 0:y.$message},{default:L(()=>[w(f(a.$t(e.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","name","error","textError"])}),128)),(r(!0),m(j,null,q(je.value,e=>{var v,g,h,_,y;return r(),I(T,{key:e.id,modelValue:s.value[e.model],"onUpdate:modelValue":V=>s.value[e.model]=V,modelModifiers:{trim:!0},width:500,options:e.options,error:(g=(v=l(n))==null?void 0:v[e==null?void 0:e.errorKey])==null?void 0:g.$error,placeholder:e==null?void 0:e.placeholder,textError:(y=(_=(h=l(n))==null?void 0:h[e==null?void 0:e.errorKey])==null?void 0:_.$errors[0])==null?void 0:y.$message,success:e.success,loading:e.loading},{default:L(()=>[w(f(a.$t(e.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","options","error","placeholder","textError","success","loading"])}),128)),be(O,{modelValue:s.value.price,"onUpdate:modelValue":t[0]||(t[0]=e=>s.value.price=e),width:500,placeholder:a.$t("estimatePricePlaceholder"),name:"money",error:(Y=(X=l(n))==null?void 0:X.price)==null?void 0:Y.$error,textError:(ae=(ee=(Z=l(n))==null?void 0:Z.price)==null?void 0:ee.$errors[0])==null?void 0:ae.$message,isDisabled:!0},{default:L(()=>[w(f(a.$t("estimatePriceLabel")),1)]),_:1},8,["modelValue","placeholder","error","textError"])]),l(D)&&((te=l(p))!=null&&te.length)?(r(),m("h3",Ia,f(a.$t("blockEstimateLabel")),1)):b("",!0),l(D)&&((le=l(p))!=null&&le.length)?(r(),m("ul",ka,[(r(!0),m(j,null,q(l(p),e=>(r(),m("li",{key:e.id,class:"manage__block",onClick:()=>u.value=e.id},[K("div",{class:ra(`manage__block-box ${u.value===e.id?"is-active":""}`)},f(e.name),3)],8,Ea))),128))])):b("",!0),l(Le)?(r(),I(Re,{key:2})):b("",!0),u.value&&((oe=l(p))!=null&&oe.length)?(r(),I(ia,{key:3,selects:qe.value,blockId:u.value,onOnAddTable:Ne,onOnChangeBlock:t[1]||(t[1]=e=>u.value=e)},null,8,["selects","blockId"])):b("",!0),(re=(se=l(n))==null?void 0:se.tables)!=null&&re.$error?(r(),m("span",$a,f((ue=(ie=(ne=l(n))==null?void 0:ne.tables)==null?void 0:ie.$errors[0])==null?void 0:ue.$message),1)):b("",!0),u.value&&((de=l(p))!=null&&de.length)?(r(),I(Je,{key:5,headers:Ie.value,table:ke.value,onOnActionDelete:He,isShowDelete:!0},null,8,["headers","table"])):b("",!0),u.value&&((ce=l(p))!=null&&ce.length)?(r(!0),m(j,{key:6},q(xe.value,e=>{var v,g,h,_,y;return r(),I(We,{key:e.id,modelValue:s.value[e.model],"onUpdate:modelValue":V=>s.value[e.model]=V,modelModifiers:{trim:!0},width:500,placeholder:a.$t(e.placeholder),error:(g=(v=l(n))==null?void 0:v[e.errorKey])==null?void 0:g.$error,textError:(y=(_=(h=l(n))==null?void 0:h[e.errorKey])==null?void 0:_.$errors[0])==null?void 0:y.$message},{default:L(()=>[w(f(a.$t(e.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","error","textError"])}),128)):b("",!0),u.value&&((me=l(p))!=null&&me.length)?(r(),I(Xe,{key:7,className:"manage__submit"},{default:L(()=>[w(f(a.$t("formButton")),1)]),_:1})):b("",!0)],32)])])):b("",!0)}}},Ka=Ye(Sa,[["__scopeId","data-v-9e952b5d"]]);export{Ka as default};
//# sourceMappingURL=create-s_mAGP1L.js.map
