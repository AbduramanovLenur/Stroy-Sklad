import{_ as Y,c as d,o as n,d as b,e as u,t as r,F as P,C as $,I as Fe,p as je,n as qe,u as Pe,a as $e,r as w,b as Ne,y as Ke,z as g,B as J,k as De,h,w as Re,A as v,i as m,D as y,ah as He,l as ze,G as Ee,m as f,s as M,f as A,H as j,J as q}from"./index-zkjpq5my.js";import{a as Ue,u as X}from"./generic.services-wx_DtCHh.js";import{u as k}from"./useQuery-copJlXh0.js";import{a as Qe,e as Ge,f as We}from"./crud.services-8TgOaY3n.js";import{f as xe,g as Je,h as Xe,i as Ye,j as Ze}from"./manual.services-LRvKoYix.js";const ea=_=>(je("data-v-1b6ac104"),_=_(),qe(),_),aa={class:"histories"},sa={class:"histories__label"},ta={class:"histories__list"},la={class:"histories__head"},oa={class:"histories__name"},ia=ea(()=>u("div",{class:"histories__divider"}," - ",-1)),na={class:"histories__status"},da={class:"histories__date"},ua={__name:"Histories",props:["histories"],setup(_){const s=d(()=>i=>{let p=new Date(i),a=p.toISOString().split("T")[0],V=p.toISOString().split("T")[1].split(".")[0];return`${a} ${V}`});return(i,p)=>(n(),b("div",aa,[u("div",sa,r(i.$t("historiesLabel")),1),u("ul",ta,[(n(!0),b(P,null,$(_.histories,a=>(n(),b("li",{key:a.id,class:"histories__item"},[u("div",{class:Fe(`histories__box ${(a==null?void 0:a.statusId)===1?"created":(a==null?void 0:a.statusId)===7?"accepted":(a==null?void 0:a.statusId)===20?"expected":(a==null?void 0:a.statusId)===15?"refused":""}`)},[u("div",la,[u("div",oa,r(a==null?void 0:a.userName),1),ia,u("div",na,r(a==null?void 0:a.status),1)]),u("div",da,r(s.value(a==null?void 0:a.createdDate)),1)],2)]))),128))])]))}},ca=Y(ua,[["__scopeId","data-v-1b6ac104"]]),ra={key:0,class:"manage section-height shadowed"},pa={class:"manage__inner section-padding"},va={class:"manage__overlay"},ma={key:3,class:"manage__triggers"},ba={__name:"view",async setup(_){let s,i;const p=Ue(),a=ze(),V=Ee();Pe(),$e();const I=w(V.params.id),Z=Ne(),{user:c}=Ke(Z),C=d(()=>{var e,o;return!!((o=(e=c==null?void 0:c.value.user)==null?void 0:e.modules)!=null&&o.includes(j.APPLICATION.READ))}),ee=w([{id:1,label:"appFloor",width:20},{id:2,label:"appMaterial",width:30},{id:3,label:"appCount",width:20},{id:4,label:"appPrice",width:30}]),t=w({id:"",deadline:"",buildingObjectId:[],buildingBlockId:[],applicationTables:[],details:"",statusId:"",allowedActionRoleIds:[],histories:[]}),{data:ae,isSuccess:se,isLoading:te}=([s,i]=g(()=>k({queryKey:["objectsList",{organizationId:c.value.user.organizationId}],queryFn:()=>xe(),enabled:C})),s=await s,i(),s),O=d(()=>t.value.buildingObjectId),le=d(()=>{var e;return!!((e=O.value)!=null&&e.length)}),{data:oe,isSuccess:ie,isLoading:ne}=([s,i]=g(()=>k({queryKey:["blocksList",{blockId:O}],queryFn:()=>Ye(O.value),enabled:le})),s=await s,i(),s),B=d(()=>t.value.buildingBlockId),T=d(()=>{var e;return!!((e=B.value)!=null&&e.length)}),{data:de,isSuccess:ue,isLoading:ce}=([s,i]=g(()=>k({queryKey:["floorsList",{floorId:B}],queryFn:()=>Ze(B.value),enabled:T})),s=await s,i(),s),{data:re,isSuccess:pe,isLoading:ve}=([s,i]=g(()=>k({queryKey:["costsList",{organizationId:c.value.user.organizationId}],queryFn:()=>Je(),enabled:T})),s=await s,i(),s),{data:me,isSuccess:be,isLoading:_e}=([s,i]=g(()=>k({queryKey:["materialsList",{organizationId:c.value.user.organizationId}],queryFn:()=>Xe(),enabled:T})),s=await s,i(),s),L=d(()=>!!(pe&&be&&ue&&t.value.applicationTables.every(e=>e.floorValue&&e.costValue&&e.constructionMaterialValue))),Ie=d(()=>!!(ve.value||_e.value||ce.value||!t.value.applicationTables.every(e=>e.floorValue&&e.costValue&&e.constructionMaterialValue))),ge=w([{id:1,model:"deadline",label:"dateAppLabel",placeholder:"dateAppPlaceholder",icon:"date",errorKey:"deadline",type:"date"}]),he=w([{id:1,model:"buildingObjectId",label:"objectAppLabel",placeholder:"objectAppPlaceholder",errorKey:"buildingObjectId",options:ae,success:se,loading:te},{id:2,model:"buildingBlockId",label:"blockAppLabel",placeholder:"blockAppPlaceholder",errorKey:"buildingBlockId",options:oe,success:ie,loading:ne}]),{isError:fe}=([s,i]=g(()=>k({queryKey:["applicationsById",I],queryFn:()=>Qe("application",I.value),select:e=>{t.value.id=e.id,t.value.deadline=e.deadline,t.value.buildingObjectId=[e.buildingObjectId],t.value.buildingBlockId=[e.buildingBlockId],t.value.applicationTables=[...e.applicationTables],t.value.details=e.details,t.value.statusId=e.statusId,t.value.allowedActionRoleIds=e.allowedActionRoleIds,t.value.histories=e.applicationHistories},enabled:C})),s=await s,i(),s),N=d(()=>q(de.value||[])),K=d(()=>q(re.value||[])),D=d(()=>q(me.value||[])),ke=e=>{var o;return(o=N.value[e.floorId])==null?void 0:o.name},Se=e=>{var o;return(o=K.value[e.costId])==null?void 0:o.name},we=e=>{var o;return(o=D.value[e==null?void 0:e.constructionMaterialId])==null?void 0:o.name},ye=d(()=>{var e,o,S;return((e=Object.keys(N.value))==null?void 0:e.length)&&((o=Object.keys(K.value))==null?void 0:o.length)&&((S=Object.keys(D.value))==null?void 0:S.length)});J(ye,e=>{e&&(t.value.applicationTables=t.value.applicationTables.map(o=>({...o,floorValue:ke(o),costValue:Se(o),constructionMaterialValue:we(o)})))},{immediate:!0}),J(fe,e=>{e&&a.push(M.HOME.path)});const{mutate:Ae}=X({mutationFn:e=>Ge("application",e),onSuccess:e=>{p.invalidateQueries({queryKey:["applications"]}),p.invalidateQueries({queryKey:["applicationsById",I]}),a.push(M.APPLICATION.path)}}),{mutate:Le}=X({mutationFn:e=>We("application",e),onSuccess:e=>{p.invalidateQueries({queryKey:["applications"]}),p.invalidateQueries({queryKey:["applicationsById",I]}),a.push(M.APPLICATION.path)}}),Me=()=>{Ae(I.value)},Ve=()=>{Le(I.value)};return(e,o)=>{var H,z,E,U,Q,G,W,x;const S=f("ManageHead"),Ce=f("FormInput"),Oe=f("FormSelect"),Be=f("SubTable"),Te=f("Spinner"),R=f("MyButton");return C.value?(n(),b("section",ra,[u("div",pa,[De(S,{title:"addNewApplicationTitle",to:h(M).APPLICATION.path},null,8,["to"]),u("form",{class:"manage__form",onSubmit:o[1]||(o[1]=Re(()=>{},["prevent"]))},[u("div",va,[(n(!0),b(P,null,$(ge.value,l=>(n(),v(Ce,{key:l.id,modelValue:t.value[l.model],"onUpdate:modelValue":F=>t.value[l.model]=F,width:500,placeholder:e.$t(l.placeholder),name:l.icon,type:l==null?void 0:l.type,isDisabled:!0},{default:y(()=>[A(r(e.$t(l.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","name","type"]))),128)),(n(!0),b(P,null,$(he.value,l=>(n(),v(Oe,{key:l.id,modelValue:t.value[l.model],"onUpdate:modelValue":F=>t.value[l.model]=F,width:500,options:l.options,placeholder:l==null?void 0:l.placeholder,success:l.success,loading:l.loading,isMultiSelect:l==null?void 0:l.multiple,isDisabled:!0},{default:y(()=>[A(r(e.$t(l.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","options","placeholder","success","loading","isMultiSelect"]))),128))]),L.value?(n(),v(Be,{key:0,headers:ee.value,table:t.value.applicationTables},null,8,["headers","table"])):m("",!0),Ie.value?(n(),v(Te,{key:1})):m("",!0),L.value?(n(),v(He,{key:2,modelValue:t.value.details,"onUpdate:modelValue":o[0]||(o[0]=l=>t.value.details=l),modelModifiers:{trim:!0},width:500,placeholder:e.$t("appCommentPlaceholder"),isDisabled:!0},{default:y(()=>[A(r(e.$t("appCommentLabel")),1)]),_:1},8,["modelValue","placeholder"])):m("",!0),L.value&&t.value.statusId!==7&&t.value.statusId!==15&&t.value.allowedActionRoleIds.includes((z=(H=h(c))==null?void 0:H.user)==null?void 0:z.roleId)?(n(),b("div",ma,[(Q=(U=(E=h(c))==null?void 0:E.user)==null?void 0:U.modules)!=null&&Q.includes(h(j).APPLICATION.CONFIRM)?(n(),v(R,{key:0,icon:"approve",type:"submit",color:"green",width:180,onClick:Ve},{default:y(()=>[A(r(e.$t("acceptButton")),1)]),_:1})):m("",!0),(x=(W=(G=h(c))==null?void 0:G.user)==null?void 0:W.modules)!=null&&x.includes(h(j).APPLICATION.REFUSAL)?(n(),v(R,{key:1,icon:"refusal",type:"submit",color:"red",width:180,onClick:Me},{default:y(()=>[A(r(e.$t("cancelButton")),1)]),_:1})):m("",!0)])):m("",!0)],32),L.value?(n(),v(ca,{key:0,histories:t.value.histories},null,8,["histories"])):m("",!0)])])):m("",!0)}}},ka=Y(ba,[["__scopeId","data-v-54c1704f"]]);export{ka as default};
