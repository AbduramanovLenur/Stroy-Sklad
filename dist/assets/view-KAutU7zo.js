import{_ as ee,c as d,o as n,d as _,e as c,t as p,F as P,C as $,H as Ve,p as qe,n as Pe,u as $e,a as Ne,r as w,b as Ke,y as De,z as h,B as X,k as Y,h as r,w as Re,A as b,i as v,D as A,ag as Ee,l as He,E as ze,m as f,s as y,f as L,G as V,I as q}from"./index-jw_W6FAd.js";import{a as Ue,u as Z}from"./generic.services-QNpx3SIA.js";import{u as k}from"./useQuery-7GCzhTKE.js";import{a as Qe,e as Ge,f as We}from"./crud.services-zWHC4qFT.js";import{f as xe,g as Je,h as Xe,i as Ye,j as Ze}from"./manual.services-6oDi3gTH.js";const ea=I=>(qe("data-v-1b6ac104"),I=I(),Pe(),I),aa={class:"histories"},sa={class:"histories__label"},ta={class:"histories__list"},la={class:"histories__head"},oa={class:"histories__name"},ia=ea(()=>c("div",{class:"histories__divider"}," - ",-1)),na={class:"histories__status"},da={class:"histories__date"},ca={__name:"Histories",props:["histories"],setup(I){const s=d(()=>i=>{let m=new Date(i),a=m.toISOString().split("T")[0],C=m.toISOString().split("T")[1].split(".")[0];return`${a} ${C}`});return(i,m)=>(n(),_("div",aa,[c("div",sa,p(i.$t("historiesLabel")),1),c("ul",ta,[(n(!0),_(P,null,$(I.histories,a=>(n(),_("li",{key:a.id,class:"histories__item"},[c("div",{class:Ve(`histories__box ${(a==null?void 0:a.statusId)===1?"created":(a==null?void 0:a.statusId)===7?"accepted":(a==null?void 0:a.statusId)===20?"expected":(a==null?void 0:a.statusId)===15?"refused":""}`)},[c("div",la,[c("div",oa,p(a==null?void 0:a.userName),1),ia,c("div",na,p(a==null?void 0:a.status),1)]),c("div",da,p(s.value(a==null?void 0:a.createdDate)),1)],2)]))),128))])]))}},ua=ee(ca,[["__scopeId","data-v-1b6ac104"]]),ra={key:0,class:"manage section-height shadowed"},pa={class:"manage__inner section-padding"},ma={class:"manage__overlay"},ba={key:3,class:"manage__triggers"},va={__name:"view",async setup(I){let s,i;const m=Ue(),a=He(),C=ze();$e(),Ne();const g=w(C.params.id),ae=Ke(),{user:u}=De(ae),M=d(()=>{var e,o;return!!((o=(e=u==null?void 0:u.value.user)==null?void 0:e.modules)!=null&&o.includes(V.APPLICATION.READ))}),se=w([{id:1,label:"appFloor",width:350},{id:2,label:"appMaterial",width:370},{id:3,label:"appCount",width:260},{id:4,label:"appPrice"}]),t=w({id:"",deadline:"",buildingObjectId:[],buildingBlockId:[],applicationTables:[],details:"",statusId:"",allowedActionRoleIds:[],histories:[]}),{data:te,isSuccess:le,isLoading:oe}=([s,i]=h(()=>k({queryKey:["objectsList",{organizationId:u.value.user.organizationId}],queryFn:()=>xe(),enabled:M})),s=await s,i(),s),O=d(()=>t.value.buildingObjectId),ie=d(()=>{var e;return!!((e=O.value)!=null&&e.length)}),{data:ne,isSuccess:de,isLoading:ce}=([s,i]=h(()=>k({queryKey:["blocksList",{blockId:O}],queryFn:()=>Ye(O.value),enabled:ie})),s=await s,i(),s),B=d(()=>t.value.buildingBlockId),T=d(()=>{var e;return!!((e=B.value)!=null&&e.length)}),{data:ue,isSuccess:re,isLoading:pe}=([s,i]=h(()=>k({queryKey:["floorsList",{floorId:B}],queryFn:()=>Ze(B.value),enabled:T})),s=await s,i(),s),{data:me,isSuccess:be,isLoading:ve}=([s,i]=h(()=>k({queryKey:["costsList",{organizationId:u.value.user.organizationId}],queryFn:()=>Je(),enabled:T})),s=await s,i(),s),{data:_e,isSuccess:Ie,isLoading:ge}=([s,i]=h(()=>k({queryKey:["materialsList",{organizationId:u.value.user.organizationId}],queryFn:()=>Xe(),enabled:T})),s=await s,i(),s),F=d(()=>{var e;return!!(be&&Ie&&re&&((e=t.value.applicationTables)!=null&&e.length))}),he=w([{id:1,model:"deadline",label:"dateAppLabel",placeholder:"dateAppPlaceholder",icon:"date",errorKey:"deadline",type:"date"}]),fe=w([{id:1,model:"buildingObjectId",label:"objectAppLabel",placeholder:"objectAppPlaceholder",errorKey:"buildingObjectId",options:te,success:le,loading:oe},{id:2,model:"buildingBlockId",label:"blockAppLabel",placeholder:"blockAppPlaceholder",errorKey:"buildingBlockId",options:ne,success:de,loading:ce}]),{isError:ke}=([s,i]=h(()=>k({queryKey:["applicationsById",g],queryFn:()=>Qe("application",g.value),select:e=>{t.value.id=e.id,t.value.deadline=e.deadline,t.value.buildingObjectId=[e.buildingObjectId],t.value.buildingBlockId=[e.buildingBlockId],t.value.applicationTables=[...e.applicationTables],t.value.details=e.details,t.value.statusId=e.statusId,t.value.allowedActionRoleIds=e.allowedActionRoleIds,t.value.histories=e.applicationHistories},enabled:M})),s=await s,i(),s),N=d(()=>q(ue.value||[])),K=d(()=>q(me.value||[])),D=d(()=>q(_e.value||[])),Se=e=>{var o;return(o=N.value[e.floorId])==null?void 0:o.name},we=e=>{var o;return(o=K.value[e.costId])==null?void 0:o.name},Ae=e=>{var o;return(o=D.value[e==null?void 0:e.constructionMaterialId])==null?void 0:o.name},Le=d(()=>{var e,o,S;return((e=Object.keys(N.value))==null?void 0:e.length)&&((o=Object.keys(K.value))==null?void 0:o.length)&&((S=Object.keys(D.value))==null?void 0:S.length)});X(Le,e=>{e&&(t.value.applicationTables=t.value.applicationTables.map(o=>({...o,floorValue:Se(o),costValue:we(o),constructionMaterialValue:Ae(o)})))},{immediate:!0}),X(ke,e=>{e&&a.push(y.HOME.path)});const{mutate:ye}=Z({mutationFn:e=>Ge("application",e),onSuccess:e=>{m.invalidateQueries({queryKey:["applications"]}),m.invalidateQueries({queryKey:["applicationsById",g]}),a.push(y.APPLICATION.path)}}),{mutate:Ce}=Z({mutationFn:e=>We("application",e),onSuccess:e=>{m.invalidateQueries({queryKey:["applications"]}),m.invalidateQueries({queryKey:["applicationsById",g]}),a.push(y.APPLICATION.path)}}),Me=()=>{ye(g.value)},Oe=()=>{Ce(g.value)};return(e,o)=>{var E,H,z,U,Q,G,W,x,J;const S=f("ManageHead"),Be=f("FormInput"),Te=f("FormSelect"),Fe=f("SubTable"),je=f("Spinner"),R=f("MyButton");return M.value?(n(),_("section",ra,[c("div",pa,[Y(S,{title:"addNewApplicationTitle",to:r(y).APPLICATION.path},null,8,["to"]),c("form",{class:"manage__form",onSubmit:o[1]||(o[1]=Re(()=>{},["prevent"]))},[c("div",ma,[(n(!0),_(P,null,$(he.value,l=>(n(),b(Be,{key:l.id,modelValue:t.value[l.model],"onUpdate:modelValue":j=>t.value[l.model]=j,width:500,placeholder:e.$t(l.placeholder),name:l.icon,type:l==null?void 0:l.type,isDisabled:!0},{default:A(()=>[L(p(e.$t(l.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","name","type"]))),128)),(n(!0),_(P,null,$(fe.value,l=>(n(),b(Te,{key:l.id,modelValue:t.value[l.model],"onUpdate:modelValue":j=>t.value[l.model]=j,width:500,options:l.options,placeholder:l==null?void 0:l.placeholder,success:l.success,loading:l.loading,isMultiSelect:l==null?void 0:l.multiple,isDisabled:!0},{default:A(()=>[L(p(e.$t(l.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","options","placeholder","success","loading","isMultiSelect"]))),128))]),F.value?(n(),b(Fe,{key:0,headers:se.value,table:t.value.applicationTables},null,8,["headers","table"])):v("",!0),r(ve)||r(ge)||r(pe)||!((E=t.value.applicationTables)!=null&&E.length)?(n(),b(je,{key:1})):v("",!0),F.value?(n(),b(Ee,{key:2,modelValue:t.value.details,"onUpdate:modelValue":o[0]||(o[0]=l=>t.value.details=l),modelModifiers:{trim:!0},width:500,placeholder:e.$t("appCommentPlaceholder"),isDisabled:!0},{default:A(()=>[L(p(e.$t("appCommentLabel")),1)]),_:1},8,["modelValue","placeholder"])):v("",!0),F.value&&t.value.statusId!==7&&t.value.statusId!==15&&t.value.allowedActionRoleIds.includes((z=(H=r(u))==null?void 0:H.user)==null?void 0:z.roleId)?(n(),_("div",ba,[(G=(Q=(U=r(u))==null?void 0:U.user)==null?void 0:Q.modules)!=null&&G.includes(r(V).APPLICATION.CONFIRM)?(n(),b(R,{key:0,icon:"approve",type:"submit",color:"green",width:180,onClick:Oe},{default:A(()=>[L(p(e.$t("acceptButton")),1)]),_:1})):v("",!0),(J=(x=(W=r(u))==null?void 0:W.user)==null?void 0:x.modules)!=null&&J.includes(r(V).APPLICATION.REFUSAL)?(n(),b(R,{key:1,icon:"refusal",type:"submit",color:"red",width:180,onClick:Me},{default:A(()=>[L(p(e.$t("cancelButton")),1)]),_:1})):v("",!0)])):v("",!0)],32),Y(ua,{histories:t.value.histories},null,8,["histories"])])])):v("",!0)}}},ka=ee(va,[["__scopeId","data-v-b4ccfc26"]]);export{ka as default};
