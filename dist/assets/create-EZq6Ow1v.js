import{_ as Je,u as We,a as Xe,b as Ye,y as Ze,c as u,r as g,z as S,B as ea,d as b,e as T,k as me,h as l,w as aa,F as P,C as x,D as M,t as p,i as c,A as h,l as ta,m as f,o as r,s as be,f as w,I as oa,H as sa,J as q,E as la}from"./index-duUvqP-c.js";import{E as ra}from"./EstimateForm-m0JbH2YT.js";import{c as ia}from"./crud.services-W2EdIOzx.js";import{f as na,g as ua,h as da,i as ca,j as ma}from"./manual.services-UeOdc-dP.js";import{u as ba,r as L}from"./i18n-validators-vfJMHImW.js";import{a as pa,u as va}from"./generic.services-9zWUdppN.js";import{u as C}from"./useQuery-nCo--xAY.js";import{v as ga}from"./v4-yQnnJER4.js";const ha={key:0,class:"manage section-height shadowed"},fa={class:"manage__inner section-padding"},_a={class:"manage__overlay"},Ia={key:0,class:"manage__title"},ya={key:1,class:"manage__blocks"},ka=["onClick"],Ea={key:4,class:"error"},Va={__name:"create",async setup($a){let s,d;const pe=pa(),ve=ta(),ge=We(),{t:he}=Xe(),fe=Ye(),{user:m}=Ze(fe),A=u(()=>{var e,t;return!!((t=(e=m==null?void 0:m.value.user)==null?void 0:e.modules)!=null&&t.includes(sa.ESTIMATE.CREATE))}),_e=g([{id:1,label:"estimateBlock",width:15},{id:2,label:"estimateFloor",width:20},{id:3,label:"estimateMaterial",width:25},{id:4,label:"estimateBudget",width:20},{id:5,label:"estimateCost",width:20}]),o=g({fullname:"",buildingObjectId:[],price:"",tables:[],details:""}),U=g(!1),n=g(""),Ie=u(()=>o.value.tables.filter(e=>+e.buildingBlockId==+n.value)),ye=u(()=>({fullname:{required:L},buildingObjectId:{required:L},price:{required:L},tables:{required:L},details:{required:L}})),i=ba(ye,o),{data:ke,isSuccess:Ee,isLoading:Ve}=([s,d]=S(()=>C({queryKey:["objectsList",{organizationId:m.value.user.organizationId}],queryFn:()=>na(),enabled:A})),s=await s,d(),s),F=u(()=>o.value.buildingObjectId),$e=u(()=>!!F.value.length);ea(F,()=>{U.value||(o.value.tables=[],n.value="")},{immediate:!0});const{data:B,isSuccess:D,isLoading:Se}=([s,d]=S(()=>C({queryKey:["blocksList",{blockId:F,organizationId:m.value.user.organizationId}],queryFn:()=>ua(F.value[0]),enabled:$e})),s=await s,d(),s),O=u(()=>n.value),z=u(()=>!!O.value),{data:H,isSuccess:Me,isLoading:we}=([s,d]=S(()=>C({queryKey:["floorsList",{floorId:O,organizationId:m.value.user.organizationId}],queryFn:()=>da(O.value),enabled:z})),s=await s,d(),s),{data:N,isSuccess:Le,isLoading:Ce}=([s,d]=S(()=>C({queryKey:["costsList",{organizationId:m.value.user.organizationId}],queryFn:()=>ca(),enabled:z})),s=await s,d(),s),{data:G,isSuccess:Fe,isLoading:Be}=([s,d]=S(()=>C({queryKey:["materialsList",{organizationId:m.value.user.organizationId}],queryFn:()=>ma(),enabled:z})),s=await s,d(),s),Te=g([{id:1,model:"fullname",label:"nameEstimateLabel",placeholder:"nameEstimatePlaceholder",icon:"input-company",errorKey:"fullname"}]),qe=g([{id:1,model:"buildingObjectId",label:"objectEstimateLabel",placeholder:"objectEstimatePlaceholder",errorKey:"buildingObjectId",options:ke,success:Ee,loading:Ve}]),Oe=g([{id:1,model:"floorId",label:"floorsEstimateLabel",placeholder:"floorsEstimatePlaceholder",options:H,success:Me,loading:we},{id:2,model:"costId",label:"costEstimateLabel",placeholder:"costEstimatePlaceholder",options:N,success:Le,loading:Ce},{id:3,model:"constructionMaterailIds",label:"materialsEstimateLabel",placeholder:"materialsEstimatePlaceholder",options:G,success:Fe,loading:Be,multiple:!0}]),ze=u(()=>q(B.value||[])),Ke=u(()=>q(H.value||[])),je=u(()=>q(N.value||[])),Pe=u(()=>q(G.value||[])),xe=e=>{var t;return(t=ze.value[e.buildingBlockId])==null?void 0:t.name},Ae=e=>{var t;return(t=Ke.value[e.floorId])==null?void 0:t.name},Ue=e=>{var t;return(t=je.value[e.costId])==null?void 0:t.name},De=e=>{var t;return(t=e.constructionMaterailIds)==null?void 0:t.map((v,_)=>{var I;return{id:_+1,name:((I=Pe.value[v])==null?void 0:I.name)||"Unknown Material"}})},He=e=>{o.value.tables.push({...e,delId:ga(),blockValue:xe(e),floorValue:Ae(e),costValue:Ue(e),constructionMaterialIdsValue:De(e)}),o.value.price=+o.value.price+e.price},Ne=e=>{o.value.tables=o.value.tables.filter(t=>{const v=t.delId!==e;return v||(o.value.price-=t.price),v})},{mutate:Ge}=va({onMutate:e=>{U.value=!0,e.tables=e.tables.map(t=>{const{delId:v,blockValue:_,floorValue:I,costValue:Q,constructionMaterialIdsValue:R,...K}=t;return K}),e.buildingObjectId=e.buildingObjectId[0]},mutationFn:e=>ia("budget",e),onSuccess:e=>{e!=null&&e.success&&(o.value=la(o.value),pe.invalidateQueries({queryKey:["budgets"]}),ve.push(be.ESTIMATE.path),setTimeout(()=>ge.success(he("createToast")),150))}}),Qe=()=>{if(i.value.$validate(),i.value.$errors.length)return;const e={...o.value};Ge(e),i.value.$reset()};return(e,t)=>{var J,W,X,Y,Z,ee,ae,te,oe,se,le,re,ie,ne,ue,de,ce;const v=f("ManageHead"),_=f("FormInput"),I=f("FormSelect"),Q=f("Spinner"),R=f("SubTable"),K=f("FormTextarea"),Re=f("CustomButton");return A.value?(r(),b("section",ha,[T("div",fa,[me(v,{title:"addNewEstimateTitle",to:l(be).ESTIMATE.path},null,8,["to"]),T("form",{class:"manage__form",onSubmit:aa(Qe,["prevent"])},[T("div",_a,[(r(!0),b(P,null,x(Te.value,a=>{var y,k,E,V,$;return r(),h(_,{key:a.id,modelValue:o.value[a.model],"onUpdate:modelValue":j=>o.value[a.model]=j,width:500,placeholder:e.$t(a.placeholder),name:a.icon,error:(k=(y=l(i))==null?void 0:y[a.errorKey])==null?void 0:k.$error,textError:($=(V=(E=l(i))==null?void 0:E[a.errorKey])==null?void 0:V.$errors[0])==null?void 0:$.$message},{default:M(()=>[w(p(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","name","error","textError"])}),128)),(r(!0),b(P,null,x(qe.value,a=>{var y,k,E,V,$;return r(),h(I,{key:a.id,modelValue:o.value[a.model],"onUpdate:modelValue":j=>o.value[a.model]=j,modelModifiers:{trim:!0},width:500,options:a.options,error:(k=(y=l(i))==null?void 0:y[a==null?void 0:a.errorKey])==null?void 0:k.$error,placeholder:a==null?void 0:a.placeholder,textError:($=(V=(E=l(i))==null?void 0:E[a==null?void 0:a.errorKey])==null?void 0:V.$errors[0])==null?void 0:$.$message,success:a.success,loading:a.loading},{default:M(()=>[w(p(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","options","error","placeholder","textError","success","loading"])}),128)),me(_,{modelValue:o.value.price,"onUpdate:modelValue":t[0]||(t[0]=a=>o.value.price=a),width:500,placeholder:e.$t("estimatePricePlaceholder"),name:"money",error:(W=(J=l(i))==null?void 0:J.price)==null?void 0:W.$error,textError:(Z=(Y=(X=l(i))==null?void 0:X.price)==null?void 0:Y.$errors[0])==null?void 0:Z.$message,isDisabled:!0},{default:M(()=>[w(p(e.$t("estimatePriceLabel")),1)]),_:1},8,["modelValue","placeholder","error","textError"])]),l(D)&&((ee=l(B))!=null&&ee.length)?(r(),b("h3",Ia,p(e.$t("blockEstimateLabel")),1)):c("",!0),l(D)&&((ae=l(B))!=null&&ae.length)?(r(),b("ul",ya,[(r(!0),b(P,null,x(l(B),a=>(r(),b("li",{key:a.id,class:"manage__block",onClick:()=>n.value=a.id},[T("div",{class:oa(`manage__block-box ${n.value===a.id?"is-active":""}`)},p(a.name),3)],8,ka))),128))])):c("",!0),l(Se)?(r(),h(Q,{key:2})):c("",!0),n.value?(r(),h(ra,{key:3,selects:Oe.value,blockId:n.value,onOnAddTable:He,onOnChangeBlock:t[1]||(t[1]=a=>n.value=a)},null,8,["selects","blockId"])):c("",!0),(oe=(te=l(i))==null?void 0:te.tables)!=null&&oe.$error?(r(),b("span",Ea,p((re=(le=(se=l(i))==null?void 0:se.tables)==null?void 0:le.$errors[0])==null?void 0:re.$message),1)):c("",!0),n.value?(r(),h(R,{key:5,headers:_e.value,table:Ie.value,onOnActionDelete:Ne,isShowDelete:!0},null,8,["headers","table"])):c("",!0),n.value?(r(),h(K,{key:6,modelValue:o.value.details,"onUpdate:modelValue":t[2]||(t[2]=a=>o.value.details=a),modelModifiers:{trim:!0},width:500,placeholder:e.$t("estimateCommentPlaceholder"),error:(ne=(ie=l(i))==null?void 0:ie.details)==null?void 0:ne.$error,textError:(ce=(de=(ue=l(i))==null?void 0:ue.details)==null?void 0:de.$errors[0])==null?void 0:ce.$message},{default:M(()=>[w(p(e.$t("estimateCommentLabel")),1)]),_:1},8,["modelValue","placeholder","error","textError"])):c("",!0),n.value?(r(),h(Re,{key:7,className:"manage__submit"},{default:M(()=>[w(p(e.$t("formButton")),1)]),_:1})):c("",!0)],32)])])):c("",!0)}}},qa=Je(Va,[["__scopeId","data-v-08965312"]]);export{qa as default};
