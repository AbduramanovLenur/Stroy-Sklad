import{_ as Re,u as Je,a as We,b as Xe,y as Ye,c as i,r as _,z as y,B as Ze,d as b,e as L,k as ea,h as l,w as aa,F as O,C as de,t as v,i as c,A as g,D as $,l as ta,m as h,o as r,s as me,f as w,I as sa,H as oa,J as C,E as la}from"./index-qYaOSAk5.js";import{E as ra}from"./EstimateForm-RJ57bByY.js";import{c as na}from"./crud.services-6H1cbtzh.js";import{f as ua,g as ia,h as ca,i as da,j as ma}from"./manual.services-e5QN_9-o.js";import{u as ba,r as k}from"./i18n-validators-FA-njMbI.js";import{a as pa,u as va}from"./generic.services-uSp9rJcx.js";import{u as E}from"./useQuery-3KlBkAoQ.js";import{v as ga}from"./v4-yQnnJER4.js";const ha={key:0,class:"manage section-height shadowed"},_a={class:"manage__inner section-padding"},Ia={class:"manage__overlay"},ya={key:0,class:"manage__title"},ka={key:1,class:"manage__blocks"},Ea=["onClick"],Sa={key:4,class:"error"},Va={__name:"create",async setup(Ma){let s,d;const be=pa(),pe=ta(),ve=Je(),{t:ge}=We(),he=Xe(),{user:m}=Ye(he),K=i(()=>{var e,t;return!!((t=(e=m==null?void 0:m.value.user)==null?void 0:e.modules)!=null&&t.includes(oa.ESTIMATE.CREATE))}),_e=_([{id:1,label:"estimateBlock",width:15},{id:2,label:"estimateFloor",width:20},{id:3,label:"estimateMaterial",width:25},{id:4,label:"estimateBudget",width:20},{id:5,label:"estimateCost",width:20}]),o=_({fullname:"",buildingObjectId:[],price:"",tables:[],details:""}),j=_(!1),n=_(""),Ie=i(()=>o.value.tables.filter(e=>+e.buildingBlockId==+n.value)),ye=i(()=>({fullname:{required:k},buildingObjectId:{required:k},price:{required:k},tables:{required:k},details:{required:k}})),u=ba(ye,o),{data:ke,isSuccess:Ee,isLoading:Se}=([s,d]=y(()=>E({queryKey:["objectsList",{organizationId:m.value.user.organizationId}],queryFn:()=>ua(),enabled:K})),s=await s,d(),s),S=i(()=>o.value.buildingObjectId[0]),Ve=i(()=>!!S.value);Ze(S,()=>{j.value||(o.value.tables=[],n.value="")},{immediate:!0});const{data:V,isSuccess:z,isLoading:Me}=([s,d]=y(()=>E({queryKey:["blocksList",{objectId:S,organizationId:m.value.user.organizationId}],queryFn:()=>ia(S.value),enabled:Ve})),s=await s,d(),s),F=i(()=>n.value),B=i(()=>!!F.value),{data:P,isSuccess:Le,isLoading:$e}=([s,d]=y(()=>E({queryKey:["floorsList",{blockId:F,organizationId:m.value.user.organizationId}],queryFn:()=>ca(F.value),enabled:B})),s=await s,d(),s),{data:D,isSuccess:we,isLoading:Ce}=([s,d]=y(()=>E({queryKey:["costsList",{organizationId:m.value.user.organizationId}],queryFn:()=>da(),enabled:B})),s=await s,d(),s),{data:x,isSuccess:Fe,isLoading:Be}=([s,d]=y(()=>E({queryKey:["materialsList",{organizationId:m.value.user.organizationId}],queryFn:()=>ma(),enabled:B})),s=await s,d(),s),Te=_([{id:1,model:"fullname",label:"nameEstimateLabel",placeholder:"nameEstimatePlaceholder",icon:"input-company",errorKey:"fullname"},{id:2,model:"buildingObjectId",label:"objectEstimateLabel",placeholder:"objectEstimatePlaceholder",errorKey:"buildingObjectId",options:ke,success:Ee,loading:Se,select:!0},{id:3,model:"price",label:"estimatePriceLabel",placeholder:"estimatePricePlaceholder",icon:"money",errorKey:"price",isDisabled:!0}]),qe=_([{id:1,model:"floorId",label:"floorsEstimateLabel",placeholder:"floorsEstimatePlaceholder",options:P,success:Le,loading:$e,select:!0},{id:2,model:"costId",label:"costEstimateLabel",placeholder:"costEstimatePlaceholder",options:D,success:we,loading:Ce,select:!0},{id:3,model:"constructionMaterailIds",label:"materialsEstimateLabel",placeholder:"materialsEstimatePlaceholder",options:x,success:Fe,loading:Be,multiple:!0,select:!0},{id:4,model:"price",label:"priceEstimateLabel",placeholder:"priceEstimatePlaceholder",icon:"money"}]),Oe=i(()=>C(V.value||[])),Ke=i(()=>C(P.value||[])),je=i(()=>C(D.value||[])),ze=i(()=>C(x.value||[])),Pe=e=>{var t;return(t=Oe.value[e.buildingBlockId])==null?void 0:t.name},De=e=>{var t;return(t=Ke.value[e.floorId])==null?void 0:t.name},xe=e=>{var t;return(t=je.value[e.costId])==null?void 0:t.name},Ae=e=>{var t;return(t=e.constructionMaterailIds)==null?void 0:t.map((p,M)=>{var I;return{id:M+1,name:((I=ze.value[p])==null?void 0:I.name)||"Unknown Material"}})},Ue=e=>{o.value.tables.push({...e,delId:ga(),blockValue:Pe(e),floorValue:De(e),costValue:xe(e),constructionMaterialIdsValue:Ae(e)}),o.value.price=+o.value.price+e.price},fe=e=>{o.value.tables=o.value.tables.filter(t=>{const p=t.delId!==e;return p||(o.value.price-=t.price),p})},{mutate:He,status:Ne}=va({onMutate:e=>{j.value=!0,e.tables=e.tables.map(t=>{const{delId:p,blockValue:M,floorValue:I,costValue:A,constructionMaterialIdsValue:U,...T}=t;return T}),e.buildingObjectId=e.buildingObjectId[0]},mutationFn:e=>na("budget",e),onSuccess:e=>{e!=null&&e.success&&(o.value=la(o.value),be.invalidateQueries({queryKey:["budgets"]}),pe.push(me.ESTIMATE.path),setTimeout(()=>ve.success(ge("createToast")),150))}}),Ge=()=>{if(u.value.$validate(),u.value.$errors.length)return;const e={...o.value};He(e),u.value.$reset()};return(e,t)=>{var f,H,N,G,Q,R,J,W,X,Y,Z,ee;const p=h("ManageHead"),M=h("FormInput"),I=h("FormSelect"),A=h("Spinner"),U=h("SubTable"),T=h("FormTextarea"),Qe=h("CustomButton");return K.value?(r(),b("section",ha,[L("div",_a,[ea(p,{title:"addNewEstimateTitle",to:l(me).ESTIMATE.path},null,8,["to"]),L("form",{class:"manage__form",onSubmit:aa(Ge,["prevent"])},[L("div",Ia,[(r(!0),b(O,null,de(Te.value,a=>{var ae,te,se,oe,le,re,ne,ue,ie,ce;return r(),b(O,{key:a.id},[a!=null&&a.select?c("",!0):(r(),g(M,{key:0,modelValue:o.value[a.model],"onUpdate:modelValue":q=>o.value[a.model]=q,width:500,placeholder:e.$t(a.placeholder),name:a.icon,error:(te=(ae=l(u))==null?void 0:ae[a.errorKey])==null?void 0:te.$error,textError:(le=(oe=(se=l(u))==null?void 0:se[a.errorKey])==null?void 0:oe.$errors[0])==null?void 0:le.$message,isDisabled:a==null?void 0:a.isDisabled},{default:$(()=>[w(v(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","name","error","textError","isDisabled"])),a!=null&&a.select?(r(),g(I,{key:1,modelValue:o.value[a.model],"onUpdate:modelValue":q=>o.value[a.model]=q,modelModifiers:{trim:!0},width:500,options:a.options,error:(ne=(re=l(u))==null?void 0:re[a==null?void 0:a.errorKey])==null?void 0:ne.$error,placeholder:a==null?void 0:a.placeholder,textError:(ce=(ie=(ue=l(u))==null?void 0:ue[a==null?void 0:a.errorKey])==null?void 0:ie.$errors[0])==null?void 0:ce.$message,success:a.success,loading:a.loading},{default:$(()=>[w(v(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","options","error","placeholder","textError","success","loading"])):c("",!0)],64)}),128))]),l(z)&&((f=l(V))!=null&&f.length)?(r(),b("h3",ya,v(e.$t("blockEstimateLabel")),1)):c("",!0),l(z)&&((H=l(V))!=null&&H.length)?(r(),b("ul",ka,[(r(!0),b(O,null,de(l(V),a=>(r(),b("li",{key:a.id,class:"manage__block",onClick:()=>n.value=a.id},[L("div",{class:sa(`manage__block-box ${n.value===a.id?"is-active":""}`)},v(a.name),3)],8,Ea))),128))])):c("",!0),l(Me)?(r(),g(A,{key:2})):c("",!0),n.value?(r(),g(ra,{key:3,subFields:qe.value,blockId:n.value,onOnAddTable:Ue,onOnChangeBlock:t[0]||(t[0]=a=>n.value=a)},null,8,["subFields","blockId"])):c("",!0),(G=(N=l(u))==null?void 0:N.tables)!=null&&G.$error?(r(),b("span",Sa,v((J=(R=(Q=l(u))==null?void 0:Q.tables)==null?void 0:R.$errors[0])==null?void 0:J.$message),1)):c("",!0),n.value?(r(),g(U,{key:5,headers:_e.value,table:Ie.value,onOnActionDelete:fe,isShowDelete:!0},null,8,["headers","table"])):c("",!0),n.value?(r(),g(T,{key:6,modelValue:o.value.details,"onUpdate:modelValue":t[1]||(t[1]=a=>o.value.details=a),modelModifiers:{trim:!0},width:500,placeholder:e.$t("estimateCommentPlaceholder"),error:(X=(W=l(u))==null?void 0:W.details)==null?void 0:X.$error,textError:(ee=(Z=(Y=l(u))==null?void 0:Y.details)==null?void 0:Z.$errors[0])==null?void 0:ee.$message},{default:$(()=>[w(v(e.$t("estimateCommentLabel")),1)]),_:1},8,["modelValue","placeholder","error","textError"])):c("",!0),n.value?(r(),g(Qe,{key:7,className:"manage__submit",disabled:l(Ne)==="pending"},{default:$(()=>[w(v(e.$t("formButton")),1)]),_:1},8,["disabled"])):c("",!0)],32)])])):c("",!0)}}},Oa=Re(Va,[["__scopeId","data-v-05c1ad96"]]);export{Oa as default};
