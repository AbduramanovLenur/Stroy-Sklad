import{_ as R,c,o as n,d as _,e as d,t as u,F as K,C as z,I as le,p as Re,n as De,L as He,w as ie,u as Ee,a as Ue,r as I,b as Qe,y as Ge,z as C,B as te,k as N,h,A as v,i as b,D as f,ai as We,l as Je,G as Xe,m as O,s as w,f as g,H as q,J as P}from"./index-BTOQ0EkA.js";import{a as Ye,u as se}from"./generic.services-aA1xp-Zb.js";import{u as S}from"./useQuery-0j72TF6v.js";import{a as Ze,e as xe,f as ea}from"./crud.services-omo8rLXB.js";import{f as aa,g as ta,h as sa,i as oa,j as la}from"./manual.services-9NlZIeU2.js";const ia=p=>(Re("data-v-28fb4607"),p=p(),De(),p),na={class:"histories"},da={class:"histories__label"},ua={class:"histories__list"},ca={class:"histories__head"},ra={class:"histories__name"},pa=ia(()=>d("div",{class:"histories__divider"}," - ",-1)),ma={class:"histories__status"},va={class:"histories__date"},ba={__name:"Histories",props:["histories"],setup(p){const a=c(()=>l=>{let m=new Date(l),s=m.toISOString().split("T")[0],A=m.toISOString().split("T")[1].split(".")[0];return`${s} ${A}`});return(l,m)=>(n(),_("div",na,[d("div",da,u(l.$t("historiesLabel")),1),d("ul",ua,[(n(!0),_(K,null,z(p.histories,s=>(n(),_("li",{key:s.id,class:"histories__item"},[d("div",{class:le(`histories__box ${(s==null?void 0:s.statusId)===1?"created":(s==null?void 0:s.statusId)===7?"accepted":(s==null?void 0:s.statusId)===20?"expected":(s==null?void 0:s.statusId)===15?"refused":""}`)},[d("div",ca,[d("div",ra,u(s==null?void 0:s.userName),1),pa,d("div",ma,u(s==null?void 0:s.status),1)]),d("div",va,u(a.value(s==null?void 0:s.createdDate)),1)],2)]))),128))])]))}},_a=R(ba,[["__scopeId","data-v-28fb4607"]]),Ia={class:"confirmation-modal__title"},fa={class:"confirmation-modal__triggers"},ga={__name:"ConfirmationModal",props:["isOpen"],setup(p){return(a,l)=>(n(),_("div",{class:le(`confirmation-modal ${p.isOpen?"is-active":""}`),onClick:l[3]||(l[3]=()=>a.$emit("onNotConfirmed"))},[d("div",{class:"confirmation-modal__overlay",onClick:l[2]||(l[2]=ie(()=>{},["stop"]))},[d("h4",Ia,[He(a.$slots,"default",{},void 0,!0)]),d("div",fa,[d("button",{type:"button",class:"confirmation-modal__accepted",onClick:l[0]||(l[0]=()=>a.$emit("onConfirmed"))},u(a.$t("yesButton")),1),d("button",{type:"button",class:"confirmation-modal__refused",onClick:l[1]||(l[1]=()=>a.$emit("onNotConfirmed"))},u(a.$t("noButton")),1)])])],2))}},oe=R(ga,[["__scopeId","data-v-c25f4d7f"]]),ka={key:0,class:"manage section-height shadowed"},Ca={class:"manage__inner section-padding"},ha={class:"manage__overlay"},Oa={key:3,class:"manage__triggers"},Sa={__name:"view",async setup(p){let a,l;const m=Ye(),s=Je(),A=Xe(),D=Ee(),{t:H}=Ue(),k=I(A.params.id),ne=Qe(),{user:r}=Ge(ne),L=c(()=>{var e,t;return!!((t=(e=r==null?void 0:r.value.user)==null?void 0:e.modules)!=null&&t.includes(q.APPLICATION.READ))}),$=I(!1),T=I(!1),de=I([{id:1,label:"appFloor",width:20},{id:2,label:"appMaterial",width:30},{id:3,label:"appCount",width:20},{id:4,label:"appPrice",width:30}]),o=I({id:"",deadline:"",buildingObjectId:[],buildingBlockId:[],applicationTables:[],details:"",statusId:"",allowedActionRoleIds:[],histories:[]}),{data:ue,isSuccess:ce,isLoading:re}=([a,l]=C(()=>S({queryKey:["objectsList",{organizationId:r.value.user.organizationId}],queryFn:()=>aa(),enabled:L})),a=await a,l(),a),V=c(()=>o.value.buildingObjectId),pe=c(()=>{var e;return!!((e=V.value)!=null&&e.length)}),{data:me,isSuccess:ve,isLoading:be}=([a,l]=C(()=>S({queryKey:["blocksList",{blockId:V,organizationId:r.value.user.organizationId}],queryFn:()=>ta(V.value),enabled:pe})),a=await a,l(),a),B=c(()=>o.value.buildingBlockId),F=c(()=>{var e;return!!((e=B.value)!=null&&e.length)}),{data:_e,isSuccess:Ie,isLoading:fe}=([a,l]=C(()=>S({queryKey:["floorsList",{floorId:B,organizationId:r.value.user.organizationId}],queryFn:()=>sa(B.value),enabled:F})),a=await a,l(),a),{data:ge,isSuccess:ke,isLoading:Ce}=([a,l]=C(()=>S({queryKey:["costsList",{organizationId:r.value.user.organizationId}],queryFn:()=>oa(),enabled:F})),a=await a,l(),a),{data:he,isSuccess:Oe,isLoading:Se}=([a,l]=C(()=>S({queryKey:["materialsList",{organizationId:r.value.user.organizationId}],queryFn:()=>la(),enabled:F})),a=await a,l(),a),M=c(()=>!!(ke&&Oe&&Ie&&o.value.applicationTables.every(e=>e.floorValue&&e.costValue&&e.constructionMaterialValue))),ye=c(()=>!!(Ce.value||Se.value||fe.value||!o.value.applicationTables.every(e=>e.floorValue&&e.costValue&&e.constructionMaterialValue))),Me=I([{id:1,model:"deadline",label:"dateAppLabel",placeholder:"dateAppPlaceholder",icon:"date",errorKey:"deadline",type:"date"}]),we=I([{id:1,model:"buildingObjectId",label:"objectAppLabel",placeholder:"objectAppPlaceholder",errorKey:"buildingObjectId",options:ue,success:ce,loading:re},{id:2,model:"buildingBlockId",label:"blockAppLabel",placeholder:"blockAppPlaceholder",errorKey:"buildingBlockId",options:me,success:ve,loading:be}]),{isError:Ae}=([a,l]=C(()=>S({queryKey:["applicationsById",k],queryFn:()=>Ze("application",k.value),select:e=>{o.value.id=e.id,o.value.deadline=e.deadline,o.value.buildingObjectId=[e.buildingObjectId],o.value.buildingBlockId=[e.buildingBlockId],o.value.applicationTables=[...e.applicationTables],o.value.details=e.details,o.value.statusId=e.statusId,o.value.allowedActionRoleIds=e.allowedActionRoleIds,o.value.histories=e.applicationHistories},enabled:L})),a=await a,l(),a),E=c(()=>P(_e.value||[])),U=c(()=>P(ge.value||[])),Q=c(()=>P(he.value||[])),Le=e=>{var t;return(t=E.value[e.floorId])==null?void 0:t.name},$e=e=>{var t;return(t=U.value[e.costId])==null?void 0:t.name},Te=e=>{var t;return(t=Q.value[e==null?void 0:e.constructionMaterialId])==null?void 0:t.name},Ve=c(()=>{var e,t,y;return((e=Object.keys(E.value))==null?void 0:e.length)&&((t=Object.keys(U.value))==null?void 0:t.length)&&((y=Object.keys(Q.value))==null?void 0:y.length)});te(Ve,e=>{e&&(o.value.applicationTables=o.value.applicationTables.map(t=>({...t,floorValue:Le(t),costValue:$e(t),constructionMaterialValue:Te(t)})))},{immediate:!0}),te(Ae,e=>{e&&s.push(w.HOME.path)});const{mutate:Be}=se({mutationFn:e=>xe("application",e),onSuccess:e=>{e!=null&&e.success&&(m.invalidateQueries({queryKey:["applications"]}),m.invalidateQueries({queryKey:["applicationsById",k]}),s.push(w.APPLICATION.path),setTimeout(()=>D.success(H("cancelToast")),150))}}),{mutate:Fe}=se({mutationFn:e=>ea("application",e),onSuccess:e=>{e!=null&&e.success&&(m.invalidateQueries({queryKey:["applications"]}),m.invalidateQueries({queryKey:["applicationsById",k]}),s.push(w.APPLICATION.path),setTimeout(()=>D.success(H("acceptToast")),150))}}),je=()=>{Be(k.value)},Ne=()=>{Fe(k.value)};return(e,t)=>{var W,J,X,Y,Z,x,ee,ae;const y=O("ManageHead"),qe=O("FormInput"),Pe=O("FormSelect"),Ke=O("SubTable"),ze=O("Spinner"),G=O("MyButton");return L.value?(n(),_("section",ka,[d("div",Ca,[N(y,{title:"addNewApplicationTitle",to:h(w).APPLICATION.path},null,8,["to"]),d("form",{class:"manage__form",onSubmit:t[3]||(t[3]=ie(()=>{},["prevent"]))},[d("div",ha,[(n(!0),_(K,null,z(Me.value,i=>(n(),v(qe,{key:i.id,modelValue:o.value[i.model],"onUpdate:modelValue":j=>o.value[i.model]=j,width:500,placeholder:e.$t(i.placeholder),name:i.icon,type:i==null?void 0:i.type,isDisabled:!0},{default:f(()=>[g(u(e.$t(i.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","name","type"]))),128)),(n(!0),_(K,null,z(we.value,i=>(n(),v(Pe,{key:i.id,modelValue:o.value[i.model],"onUpdate:modelValue":j=>o.value[i.model]=j,modelModifiers:{trim:!0},width:500,options:i.options,placeholder:i==null?void 0:i.placeholder,success:i.success,loading:i.loading,isMultiSelect:i==null?void 0:i.multiple,isDisabled:!0},{default:f(()=>[g(u(e.$t(i.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","options","placeholder","success","loading","isMultiSelect"]))),128))]),M.value?(n(),v(Ke,{key:0,headers:de.value,table:o.value.applicationTables},null,8,["headers","table"])):b("",!0),ye.value?(n(),v(ze,{key:1})):b("",!0),M.value?(n(),v(We,{key:2,modelValue:o.value.details,"onUpdate:modelValue":t[0]||(t[0]=i=>o.value.details=i),modelModifiers:{trim:!0},width:500,placeholder:e.$t("appCommentPlaceholder"),isDisabled:!0},{default:f(()=>[g(u(e.$t("appCommentLabel")),1)]),_:1},8,["modelValue","placeholder"])):b("",!0),M.value&&o.value.statusId!==7&&o.value.statusId!==15&&o.value.allowedActionRoleIds.includes((J=(W=h(r))==null?void 0:W.user)==null?void 0:J.roleId)?(n(),_("div",Oa,[(Z=(Y=(X=h(r))==null?void 0:X.user)==null?void 0:Y.modules)!=null&&Z.includes(h(q).APPLICATION.CONFIRM)?(n(),v(G,{key:0,icon:"approve",type:"submit",color:"green",width:180,onClick:t[1]||(t[1]=()=>$.value=!0)},{default:f(()=>[g(u(e.$t("acceptButton")),1)]),_:1})):b("",!0),(ae=(ee=(x=h(r))==null?void 0:x.user)==null?void 0:ee.modules)!=null&&ae.includes(h(q).APPLICATION.REFUSAL)?(n(),v(G,{key:1,icon:"refusal",type:"submit",color:"red",width:180,onClick:t[2]||(t[2]=()=>T.value=!0)},{default:f(()=>[g(u(e.$t("cancelButton")),1)]),_:1})):b("",!0)])):b("",!0)],32),M.value?(n(),v(_a,{key:0,histories:o.value.histories},null,8,["histories"])):b("",!0)]),N(oe,{isOpen:$.value,onOnConfirmed:Ne,onOnNotConfirmed:t[4]||(t[4]=()=>$.value=!1)},{default:f(()=>[g(u(e.$t("sureConfirm")),1)]),_:1},8,["isOpen"]),N(oe,{isOpen:T.value,onOnConfirmed:je,onOnNotConfirmed:t[5]||(t[5]=()=>T.value=!1)},{default:f(()=>[g(u(e.$t("sureRefused")),1)]),_:1},8,["isOpen"])])):b("",!0)}}},$a=R(Sa,[["__scopeId","data-v-ed5fe4ed"]]);export{$a as default};
