import{_ as We,u as Xe,a as Ye,b as Ze,x as ea,c as i,r as f,y as S,B as aa,d as m,e as T,k as me,h as o,w as ta,F as j,C as K,D as M,t as I,i as b,z as k,l as oa,m as E,o as r,A as be,f as L,H as la,G as sa,I as q}from"./index-sKMtYVf1.js";import{E as ra}from"./EstimateForm-lBVBgS4D.js";import{u as na,r as w}from"./i18n-validators-UluQ0_Lr.js";import{a as ia,u as ua}from"./generic.services-Y9l1kbCB.js";import{u as C}from"./useQuery-oNoZrsai.js";import{c as da}from"./crud.services-OfzCCZDD.js";import{f as ca,g as ma,h as ba,i as pa,j as va}from"./manual.services-XDT6etPx.js";import{v as ga}from"./v4-yQnnJER4.js";const ha={key:0,class:"manage section-height shadowed"},_a={class:"manage__inner section-padding"},ya={class:"manage__overlay"},fa={key:0,class:"manage__title"},Ia={key:1,class:"manage__blocks"},ka=["onClick"],Ea={key:4,class:"error"},Va={__name:"create",async setup($a){let l,d;const pe=ia(),ve=oa(),ge=Xe(),{t:he}=Ye(),_e=Ze(),{user:V}=ea(_e),P=i(()=>{var a,t;return!!((t=(a=V==null?void 0:V.value.user)==null?void 0:a.modules)!=null&&t.includes(sa.ESTIMATE.CREATE))}),ye=f([{id:1,label:"estimateBlock",width:200},{id:2,label:"estimateFloor",width:200},{id:3,label:"estimateMaterial",width:260},{id:4,label:"estimateBudget",width:200},{id:5,label:"estimateCost"}]),s=f({fullname:"",buildingObjectId:[],price:"",tables:[],details:""}),U=f(!1),u=f(""),fe=i(()=>s.value.tables.filter(a=>+a.buildingBlockId==+u.value)),Ie=i(()=>({fullname:{required:w},buildingObjectId:{required:w},price:{required:w},tables:{required:w},details:{required:w}})),n=na(Ie,s),{data:ke,isSuccess:Ee,isLoading:Ve}=([l,d]=S(()=>C({queryKey:["objectsList",{organizationId:V.value.user.organizationId}],queryFn:()=>ca(),enabled:P})),l=await l,d(),l),F=i(()=>s.value.buildingObjectId),$e=i(()=>!!F.value.length);aa(F,()=>{U.value||(s.value.tables=[],u.value="")},{immediate:!0});const{data:p,isSuccess:z,isLoading:Se}=([l,d]=S(()=>C({queryKey:["blocksList",{blockId:F}],queryFn:()=>pa(F.value[0]),enabled:$e})),l=await l,d(),l),x=i(()=>u.value),A=i(()=>!!x.value),{data:D,isSuccess:Me,isLoading:Le}=([l,d]=S(()=>C({queryKey:["floorsList",{floorId:x}],queryFn:()=>va(x.value),enabled:A})),l=await l,d(),l),{data:N,isSuccess:we,isLoading:Ce}=([l,d]=S(()=>C({queryKey:["costsList",{organizationId:V.value.user.organizationId}],queryFn:()=>ma(),enabled:A})),l=await l,d(),l),{data:H,isSuccess:Fe,isLoading:Be}=([l,d]=S(()=>C({queryKey:["materialsList",{organizationId:V.value.user.organizationId}],queryFn:()=>ba(),enabled:A})),l=await l,d(),l),Oe=f([{id:1,model:"fullname",label:"nameEstimateLabel",placeholder:"nameEstimatePlaceholder",icon:"input-company",errorKey:"fullname"}]),Te=f([{id:1,model:"buildingObjectId",label:"objectEstimateLabel",placeholder:"objectEstimatePlaceholder",errorKey:"buildingObjectId",options:ke,success:Ee,loading:Ve}]),je=f([{id:1,model:"floorId",label:"floorsEstimateLabel",placeholder:"floorsEstimatePlaceholder",options:D,success:Me,loading:Le},{id:2,model:"costId",label:"costEstimateLabel",placeholder:"costEstimatePlaceholder",options:N,success:we,loading:Ce},{id:3,model:"constructionMaterailIds",label:"materialsEstimateLabel",placeholder:"materialsEstimatePlaceholder",options:H,success:Fe,loading:Be,multiple:!0}]),Ke=f([{id:1,model:"details",label:"estimateCommentLabel",placeholder:"estimateCommentPlaceholder",errorKey:"details"}]),G=i(()=>q(p.value||[])),Q=i(()=>q(D.value||[])),R=i(()=>q(N.value||[])),J=i(()=>q(H.value||[])),qe=a=>{var t;return(t=G.value[a.buildingBlockId])==null?void 0:t.name},xe=a=>{var t;return(t=Q.value[a.floorId])==null?void 0:t.name},Ae=a=>{var t;return(t=R.value[a.costId])==null?void 0:t.name},Pe=a=>{var t;return(t=a.constructionMaterailIds)==null?void 0:t.map((c,B)=>{var O;return{id:B+1,name:((O=J.value[c])==null?void 0:O.name)||"Unknown Material"}})},Ue=i(()=>Object.keys(G.value).length&&Object.keys(Q.value).length&&Object.keys(R.value).length&&Object.keys(J.value).length),ze=a=>{if(Ue){s.value.tables.push({...a,delId:ga(),blockValue:qe(a),floorValue:xe(a),costValue:Ae(a),constructionMaterialIdsValue:Pe(a)}),s.value.price=+s.value.price+ +a.price;return}ge.error(he("estimateEmptyData"))},De=a=>{s.value.tables=s.value.tables.filter(t=>t.delId!==a)},{mutate:Ne}=ua({onMutate:a=>{U.value=!0,a.tables=a.tables.map(t=>{let c={...t};return delete c.delId,delete c.blockValue,delete c.floorValue,delete c.costValue,delete c.constructionMaterialIdsValue,c}),a.buildingObjectId=a.buildingObjectId[0]},mutationFn:a=>da("budget",a),onSuccess:()=>{pe.invalidateQueries({queryKey:["budgets"]}),ve.push(be.ESTIMATE.path)}}),He=()=>{n.value.$validate(),!n.value.$errors.length&&(Ne(s.value),n.value.$reset())};return(a,t)=>{var W,X,Y,Z,ee,ae,te,oe,le,se,re,ne,ie,ue,de,ce;const c=E("ManageHead"),B=E("FormInput"),O=E("FormSelect"),Ge=E("Spinner"),Qe=E("SubTable"),Re=E("FormTextarea"),Je=E("CustomButton");return P.value?(r(),m("section",ha,[T("div",_a,[me(c,{title:"addNewEstimateTitle",to:o(be).ESTIMATE.path},null,8,["to"]),T("form",{class:"manage__form",onSubmit:ta(He,["prevent"])},[T("div",ya,[(r(!0),m(j,null,K(Oe.value,e=>{var v,g,h,_,y;return r(),k(B,{key:e.id,modelValue:s.value[e.model],"onUpdate:modelValue":$=>s.value[e.model]=$,width:500,placeholder:a.$t(e.placeholder),name:e.icon,error:(g=(v=o(n))==null?void 0:v[e.errorKey])==null?void 0:g.$error,textError:(y=(_=(h=o(n))==null?void 0:h[e.errorKey])==null?void 0:_.$errors[0])==null?void 0:y.$message},{default:M(()=>[L(I(a.$t(e.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","name","error","textError"])}),128)),(r(!0),m(j,null,K(Te.value,e=>{var v,g,h,_,y;return r(),k(O,{key:e.id,modelValue:s.value[e.model],"onUpdate:modelValue":$=>s.value[e.model]=$,modelModifiers:{trim:!0},width:500,options:e.options,error:(g=(v=o(n))==null?void 0:v[e==null?void 0:e.errorKey])==null?void 0:g.$error,placeholder:e==null?void 0:e.placeholder,textError:(y=(_=(h=o(n))==null?void 0:h[e==null?void 0:e.errorKey])==null?void 0:_.$errors[0])==null?void 0:y.$message,success:e.success,loading:e.loading},{default:M(()=>[L(I(a.$t(e.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","options","error","placeholder","textError","success","loading"])}),128)),me(B,{modelValue:s.value.price,"onUpdate:modelValue":t[0]||(t[0]=e=>s.value.price=e),width:500,placeholder:a.$t("estimatePricePlaceholder"),name:"money",error:(X=(W=o(n))==null?void 0:W.price)==null?void 0:X.$error,textError:(ee=(Z=(Y=o(n))==null?void 0:Y.price)==null?void 0:Z.$errors[0])==null?void 0:ee.$message,isDisabled:!0},{default:M(()=>[L(I(a.$t("estimatePriceLabel")),1)]),_:1},8,["modelValue","placeholder","error","textError"])]),o(z)&&((ae=o(p))!=null&&ae.length)?(r(),m("h3",fa,I(a.$t("blockEstimateLabel")),1)):b("",!0),o(z)&&((te=o(p))!=null&&te.length)?(r(),m("ul",Ia,[(r(!0),m(j,null,K(o(p),e=>(r(),m("li",{key:e.id,class:"manage__block",onClick:()=>u.value=e.id},[T("div",{class:la(`manage__block-box ${u.value===e.id?"is-active":""}`)},I(e.name),3)],8,ka))),128))])):b("",!0),o(Se)?(r(),k(Ge,{key:2})):b("",!0),u.value&&((oe=o(p))!=null&&oe.length)?(r(),k(ra,{key:3,selects:je.value,blockId:u.value,onOnAddTable:ze,onOnChangeBlock:t[1]||(t[1]=e=>u.value=e)},null,8,["selects","blockId"])):b("",!0),(se=(le=o(n))==null?void 0:le.tables)!=null&&se.$error?(r(),m("span",Ea,I((ie=(ne=(re=o(n))==null?void 0:re.tables)==null?void 0:ne.$errors[0])==null?void 0:ie.$message),1)):b("",!0),u.value&&((ue=o(p))!=null&&ue.length)?(r(),k(Qe,{key:5,headers:ye.value,table:fe.value,onOnActionDelete:De,isShowDelete:!0},null,8,["headers","table"])):b("",!0),u.value&&((de=o(p))!=null&&de.length)?(r(!0),m(j,{key:6},K(Ke.value,e=>{var v,g,h,_,y;return r(),k(Re,{key:e.id,modelValue:s.value[e.model],"onUpdate:modelValue":$=>s.value[e.model]=$,modelModifiers:{trim:!0},width:500,placeholder:a.$t(e.placeholder),error:(g=(v=o(n))==null?void 0:v[e.errorKey])==null?void 0:g.$error,textError:(y=(_=(h=o(n))==null?void 0:h[e.errorKey])==null?void 0:_.$errors[0])==null?void 0:y.$message},{default:M(()=>[L(I(a.$t(e.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","error","textError"])}),128)):b("",!0),u.value&&((ce=o(p))!=null&&ce.length)?(r(),k(Je,{key:7,className:"manage__submit"},{default:M(()=>[L(I(a.$t("formButton")),1)]),_:1})):b("",!0)],32)])])):b("",!0)}}},Ta=We(Va,[["__scopeId","data-v-4deb280e"]]);export{Ta as default};
//# sourceMappingURL=create-wW78GXsd.js.map
