import{_ as Je,u as We,a as Xe,b as Ye,y as Ze,c as u,r as v,z as S,B as ea,d as m,e as T,k as me,h as l,w as aa,F as x,C as z,D as M,t as b,i as c,A as g,l as ta,m as h,o as r,s as be,f as w,I as oa,H as sa,J as q,E as la}from"./index-fb-UMc5g.js";import{E as ra}from"./EstimateForm-_N39NySN.js";import{u as na,r as L}from"./i18n-validators-LLOmn97v.js";import{a as ia,u as ua}from"./generic.services-lq4JeLDX.js";import{u as C}from"./useQuery-jIlHzI4E.js";import{c as da}from"./crud.services-LQy_-Czz.js";import{f as ca,g as ma,h as ba,i as pa,j as va}from"./manual.services-GKLeZtE_.js";import{v as ga}from"./v4-yQnnJER4.js";const ha={key:0,class:"manage section-height shadowed"},fa={class:"manage__inner section-padding"},_a={class:"manage__overlay"},Ia={key:0,class:"manage__title"},ya={key:1,class:"manage__blocks"},ka=["onClick"],Ea={key:4,class:"error"},Va={__name:"create",async setup($a){let o,d;const pe=ia(),ve=ta(),ge=We(),{t:he}=Xe(),fe=Ye(),{user:f}=Ze(fe),A=u(()=>{var e,t;return!!((t=(e=f==null?void 0:f.value.user)==null?void 0:e.modules)!=null&&t.includes(sa.ESTIMATE.CREATE))}),_e=v([{id:1,label:"estimateBlock",width:15},{id:2,label:"estimateFloor",width:20},{id:3,label:"estimateMaterial",width:25},{id:4,label:"estimateBudget",width:20},{id:5,label:"estimateCost",width:20}]),s=v({fullname:"",buildingObjectId:[],price:"",tables:[],details:""}),U=v(!1),i=v(""),Ie=u(()=>s.value.tables.filter(e=>+e.buildingBlockId==+i.value)),ye=u(()=>({fullname:{required:L},buildingObjectId:{required:L},price:{required:L},tables:{required:L},details:{required:L}})),n=na(ye,s),{data:ke,isSuccess:Ee,isLoading:Ve}=([o,d]=S(()=>C({queryKey:["objectsList",{organizationId:f.value.user.organizationId}],queryFn:()=>ca(),enabled:A})),o=await o,d(),o),F=u(()=>s.value.buildingObjectId),$e=u(()=>!!F.value.length);ea(F,()=>{U.value||(s.value.tables=[],i.value="")},{immediate:!0});const{data:B,isSuccess:D,isLoading:Se}=([o,d]=S(()=>C({queryKey:["blocksList",{blockId:F}],queryFn:()=>pa(F.value[0]),enabled:$e})),o=await o,d(),o),O=u(()=>i.value),K=u(()=>!!O.value),{data:H,isSuccess:Me,isLoading:we}=([o,d]=S(()=>C({queryKey:["floorsList",{floorId:O}],queryFn:()=>va(O.value),enabled:K})),o=await o,d(),o),{data:N,isSuccess:Le,isLoading:Ce}=([o,d]=S(()=>C({queryKey:["costsList",{organizationId:f.value.user.organizationId}],queryFn:()=>ma(),enabled:K})),o=await o,d(),o),{data:G,isSuccess:Fe,isLoading:Be}=([o,d]=S(()=>C({queryKey:["materialsList",{organizationId:f.value.user.organizationId}],queryFn:()=>ba(),enabled:K})),o=await o,d(),o),Te=v([{id:1,model:"fullname",label:"nameEstimateLabel",placeholder:"nameEstimatePlaceholder",icon:"input-company",errorKey:"fullname"}]),qe=v([{id:1,model:"buildingObjectId",label:"objectEstimateLabel",placeholder:"objectEstimatePlaceholder",errorKey:"buildingObjectId",options:ke,success:Ee,loading:Ve}]),Oe=v([{id:1,model:"floorId",label:"floorsEstimateLabel",placeholder:"floorsEstimatePlaceholder",options:H,success:Me,loading:we},{id:2,model:"costId",label:"costEstimateLabel",placeholder:"costEstimatePlaceholder",options:N,success:Le,loading:Ce},{id:3,model:"constructionMaterailIds",label:"materialsEstimateLabel",placeholder:"materialsEstimatePlaceholder",options:G,success:Fe,loading:Be,multiple:!0}]),Ke=u(()=>q(B.value||[])),je=u(()=>q(H.value||[])),Pe=u(()=>q(N.value||[])),xe=u(()=>q(G.value||[])),ze=e=>{var t;return(t=Ke.value[e.buildingBlockId])==null?void 0:t.name},Ae=e=>{var t;return(t=je.value[e.floorId])==null?void 0:t.name},Ue=e=>{var t;return(t=Pe.value[e.costId])==null?void 0:t.name},De=e=>{var t;return(t=e.constructionMaterailIds)==null?void 0:t.map((p,_)=>{var I;return{id:_+1,name:((I=xe.value[p])==null?void 0:I.name)||"Unknown Material"}})},He=e=>{s.value.tables.push({...e,delId:ga(),blockValue:ze(e),floorValue:Ae(e),costValue:Ue(e),constructionMaterialIdsValue:De(e)}),s.value.price+=parseInt(e.price,10)},Ne=e=>{s.value.tables=s.value.tables.filter(t=>{const p=t.delId!==e;return p||(s.value.price-=parseInt(t.price,10)),p})},{mutate:Ge}=ua({onMutate:e=>{U.value=!0,e.tables=e.tables.map(t=>{const{delId:p,blockValue:_,floorValue:I,costValue:Q,constructionMaterialIdsValue:R,...j}=t;return j}),e.buildingObjectId=e.buildingObjectId[0]},mutationFn:e=>da("budget",e),onSuccess:e=>{e!=null&&e.success&&(s.value=la(s.value),pe.invalidateQueries({queryKey:["budgets"]}),ve.push(be.ESTIMATE.path),setTimeout(()=>ge.success(he("createToast")),150))}}),Qe=()=>{if(n.value.$validate(),n.value.$errors.length)return;const e={...s.value};Ge(e),n.value.$reset()};return(e,t)=>{var J,W,X,Y,Z,ee,ae,te,oe,se,le,re,ne,ie,ue,de,ce;const p=h("ManageHead"),_=h("FormInput"),I=h("FormSelect"),Q=h("Spinner"),R=h("SubTable"),j=h("FormTextarea"),Re=h("CustomButton");return A.value?(r(),m("section",ha,[T("div",fa,[me(p,{title:"addNewEstimateTitle",to:l(be).ESTIMATE.path},null,8,["to"]),T("form",{class:"manage__form",onSubmit:aa(Qe,["prevent"])},[T("div",_a,[(r(!0),m(x,null,z(Te.value,a=>{var y,k,E,V,$;return r(),g(_,{key:a.id,modelValue:s.value[a.model],"onUpdate:modelValue":P=>s.value[a.model]=P,width:500,placeholder:e.$t(a.placeholder),name:a.icon,error:(k=(y=l(n))==null?void 0:y[a.errorKey])==null?void 0:k.$error,textError:($=(V=(E=l(n))==null?void 0:E[a.errorKey])==null?void 0:V.$errors[0])==null?void 0:$.$message},{default:M(()=>[w(b(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","name","error","textError"])}),128)),(r(!0),m(x,null,z(qe.value,a=>{var y,k,E,V,$;return r(),g(I,{key:a.id,modelValue:s.value[a.model],"onUpdate:modelValue":P=>s.value[a.model]=P,modelModifiers:{trim:!0},width:500,options:a.options,error:(k=(y=l(n))==null?void 0:y[a==null?void 0:a.errorKey])==null?void 0:k.$error,placeholder:a==null?void 0:a.placeholder,textError:($=(V=(E=l(n))==null?void 0:E[a==null?void 0:a.errorKey])==null?void 0:V.$errors[0])==null?void 0:$.$message,success:a.success,loading:a.loading},{default:M(()=>[w(b(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","options","error","placeholder","textError","success","loading"])}),128)),me(_,{modelValue:s.value.price,"onUpdate:modelValue":t[0]||(t[0]=a=>s.value.price=a),width:500,placeholder:e.$t("estimatePricePlaceholder"),name:"money",error:(W=(J=l(n))==null?void 0:J.price)==null?void 0:W.$error,textError:(Z=(Y=(X=l(n))==null?void 0:X.price)==null?void 0:Y.$errors[0])==null?void 0:Z.$message,isDisabled:!0},{default:M(()=>[w(b(e.$t("estimatePriceLabel")),1)]),_:1},8,["modelValue","placeholder","error","textError"])]),l(D)&&((ee=l(B))!=null&&ee.length)?(r(),m("h3",Ia,b(e.$t("blockEstimateLabel")),1)):c("",!0),l(D)&&((ae=l(B))!=null&&ae.length)?(r(),m("ul",ya,[(r(!0),m(x,null,z(l(B),a=>(r(),m("li",{key:a.id,class:"manage__block",onClick:()=>i.value=a.id},[T("div",{class:oa(`manage__block-box ${i.value===a.id?"is-active":""}`)},b(a.name),3)],8,ka))),128))])):c("",!0),l(Se)?(r(),g(Q,{key:2})):c("",!0),i.value?(r(),g(ra,{key:3,selects:Oe.value,blockId:i.value,onOnAddTable:He,onOnChangeBlock:t[1]||(t[1]=a=>i.value=a)},null,8,["selects","blockId"])):c("",!0),(oe=(te=l(n))==null?void 0:te.tables)!=null&&oe.$error?(r(),m("span",Ea,b((re=(le=(se=l(n))==null?void 0:se.tables)==null?void 0:le.$errors[0])==null?void 0:re.$message),1)):c("",!0),i.value?(r(),g(R,{key:5,headers:_e.value,table:Ie.value,onOnActionDelete:Ne,isShowDelete:!0},null,8,["headers","table"])):c("",!0),i.value?(r(),g(j,{key:6,modelValue:s.value.details,"onUpdate:modelValue":t[2]||(t[2]=a=>s.value.details=a),modelModifiers:{trim:!0},width:500,placeholder:e.$t("estimateCommentPlaceholder"),error:(ie=(ne=l(n))==null?void 0:ne.details)==null?void 0:ie.$error,textError:(ce=(de=(ue=l(n))==null?void 0:ue.details)==null?void 0:de.$errors[0])==null?void 0:ce.$message},{default:M(()=>[w(b(e.$t("estimateCommentLabel")),1)]),_:1},8,["modelValue","placeholder","error","textError"])):c("",!0),i.value?(r(),g(Re,{key:7,className:"manage__submit"},{default:M(()=>[w(b(e.$t("formButton")),1)]),_:1})):c("",!0)],32)])])):c("",!0)}}},qa=Je(Va,[["__scopeId","data-v-5a1406e5"]]);export{qa as default};
