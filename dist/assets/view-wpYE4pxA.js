import{_ as U,o as c,d as p,e as i,L as Pe,t as d,w as ne,I as ie,c as r,F as R,D as ue,p as Fe,n as Ne,u as Ve,a as je,r as b,b as qe,y as Ke,z as O,ai as ze,C as De,k as f,h as k,A as _,aj as te,B as y,i as I,l as He,G as Re,m as S,s as A,f as g,H as D,J as H}from"./index-MC-ZGS-B.js";import{a as Ue,e as Ee,f as Qe}from"./crud.services-6pM_UmBK.js";import{f as Ge,g as We,h as Je,i as Xe,j as Ye}from"./manual.services-A3PttgtW.js";import{u as Ze}from"./generic.services-iK8gJFXy.js";import{u as L}from"./useQuery-Q5uFjRao.js";import{u as oe}from"./useMutation-FykAeqRT.js";const xe={class:"confirmation-modal__title"},ea={class:"confirmation-modal__triggers"},aa={__name:"ConfirmationModal",props:{isOpen:Boolean},setup(m){return(a,n)=>(c(),p("div",{class:ie(`confirmation-modal ${m.isOpen?"is-active":""}`),onClick:n[3]||(n[3]=()=>a.$emit("onNotConfirmed"))},[i("div",{class:"confirmation-modal__overlay",onClick:n[2]||(n[2]=ne(()=>{},["stop"]))},[i("h4",xe,[Pe(a.$slots,"default",{},void 0,!0)]),i("div",ea,[i("button",{type:"button",class:"confirmation-modal__accepted",onClick:n[0]||(n[0]=()=>a.$emit("onConfirmed"))},d(a.$t("yesButton")),1),i("button",{type:"button",class:"confirmation-modal__refused",onClick:n[1]||(n[1]=()=>a.$emit("onNotConfirmed"))},d(a.$t("noButton")),1)])])],2))}},le=U(aa,[["__scopeId","data-v-6efdbb0d"]]),sa=m=>(Fe("data-v-3126a839"),m=m(),Ne(),m),ta={class:"histories"},oa={class:"histories__label"},la={class:"histories__list"},na={class:"histories__head"},ia={class:"histories__name"},ua=sa(()=>i("div",{class:"histories__divider"}," - ",-1)),da={class:"histories__status"},ca={class:"histories__date"},ra={class:"histories__comment"},pa={__name:"Histories",props:{histories:Array},setup(m){const a=r(()=>n=>{let v=new Date(n),s=v.toISOString().split("T")[0],B=v.toISOString().split("T")[1].split(".")[0];return`${s} ${B}`});return(n,v)=>(c(),p("div",ta,[i("div",oa,d(n.$t("historiesLabel")),1),i("ul",la,[(c(!0),p(R,null,ue(m.histories,s=>(c(),p("li",{key:s.id,class:"histories__item"},[i("div",{class:ie(`histories__box ${(s==null?void 0:s.statusId)===1?"created":(s==null?void 0:s.statusId)===7?"accepted":(s==null?void 0:s.statusId)===20?"expected":(s==null?void 0:s.statusId)===15?"refused":""}`)},[i("div",na,[i("div",ia,d(s==null?void 0:s.userName),1),ua,i("div",da,d(s==null?void 0:s.status),1)]),i("div",ca,d(a.value(s==null?void 0:s.createdDate)),1),i("div",ra,d(s==null?void 0:s.comment),1)],2)]))),128))])]))}},ma=U(pa,[["__scopeId","data-v-3126a839"]]),va={key:0,class:"manage section-height shadowed"},ba={class:"manage__inner section-padding"},_a={class:"manage__overlay"},Ia={class:"manage__textareas"},ga={key:0,class:"manage__triggers"},fa={__name:"view",async setup(m){let a,n;const v=Ze(),s=He(),B=Re(),E=Ve(),{t:Q}=je(),C=b(B.params.id),de=qe(),{user:u}=Ke(de),$=r(()=>{var e,o;return(o=(e=u==null?void 0:u.value.user)==null?void 0:e.modules)==null?void 0:o.includes(D.APPLICATION.READ)}),P=b(!1),F=b(!1),ce=b([{id:1,label:"appFloor",width:20},{id:2,label:"appMaterial",width:30},{id:3,label:"appCount",width:20},{id:4,label:"appPrice",width:30}]),t=b({id:"",deadline:"",buildingObjectId:[],buildingBlockId:[],applicationTables:[],details:"",comment:"",statusId:"",hasPermission:[],histories:[]}),{data:re,isSuccess:pe,isLoading:me}=([a,n]=O(()=>L({queryKey:["objectsList",{organizationId:u.value.user.organizationId,name:u.value.user.fullName}],queryFn:()=>Ge(),enabled:$})),a=await a,n(),a),N=r(()=>t.value.buildingObjectId[0]),ve=r(()=>!!N.value),{data:be,isSuccess:_e,isLoading:Ie}=([a,n]=O(()=>L({queryKey:["blocksList",{blockId:N,organizationId:u.value.user.organizationId,name:u.value.user.fullName}],queryFn:()=>We(N.value),enabled:ve})),a=await a,n(),a),V=r(()=>t.value.buildingBlockId[0]),ge=r(()=>!!V.value),{data:fe,isSuccess:ka,isLoading:Ca}=([a,n]=O(()=>L({queryKey:["floorsList",{floorId:V,organizationId:u.value.user.organizationId,name:u.value.user.fullName}],queryFn:()=>Je(V.value),enabled:ge})),a=await a,n(),a),{data:ke,isSuccess:ha,isLoading:Oa}=([a,n]=O(()=>L({queryKey:["costsList",{organizationId:u.value.user.organizationId,name:u.value.user.fullName}],queryFn:()=>Xe(),enabled:$})),a=await a,n(),a),{data:Ce,isSuccess:Sa,isLoading:La}=([a,n]=O(()=>L({queryKey:["materialsList",{organizationId:u.value.user.organizationId,name:u.value.user.fullName}],queryFn:()=>Ye(),enabled:$})),a=await a,n(),a),he=b([{id:1,model:"deadline",label:"dateAppLabel",placeholder:"dateAppPlaceholder",icon:"date",errorKey:"deadline",type:"date"},{id:2,model:"buildingObjectId",label:"objectAppLabel",placeholder:"objectAppPlaceholder",errorKey:"buildingObjectId",options:re,success:pe,loading:me,select:!0},{id:3,model:"buildingBlockId",label:"blockAppLabel",placeholder:"blockAppPlaceholder",errorKey:"buildingBlockId",options:be,success:_e,loading:Ie,select:!0}]),{isError:Oe}=([a,n]=O(()=>L({queryKey:["applicationsById",C,u.value.user.fullName],queryFn:()=>Ue("application",C.value),select:e=>{t.value.id=e.id,t.value.deadline=e.deadline,t.value.buildingObjectId=[e.buildingObjectId],t.value.buildingBlockId=[e.buildingBlockId],t.value.applicationTables=[...e.applicationTables],t.value.details=e.details,t.value.statusId=e.statusId,t.value.hasPermission=e.hasPermission,t.value.histories=e.applicationHistories},enabled:$})),a=await a,n(),a),G=r(()=>H(fe.value||[])),W=r(()=>H(ke.value||[])),J=r(()=>H(Ce.value||[])),Se=e=>{var o;return(o=G.value[e.floorId])==null?void 0:o.name},Le=e=>{var o;return(o=W.value[e.costId])==null?void 0:o.name},$e=e=>{var o;return(o=J.value[e==null?void 0:e.constructionMaterialId])==null?void 0:o.name},X=b(!1),Y=b(!0);ze(()=>{var M,T,w;const e=(M=Object.keys(G.value))==null?void 0:M.length,o=(T=Object.keys(W.value))==null?void 0:T.length,j=(w=Object.keys(J.value))==null?void 0:w.length,q=t.value.applicationTables.length;e&&o&&j&&q&&(t.value.applicationTables=t.value.applicationTables.map(h=>({...h,floorValue:Se(h),costValue:Le(h),constructionMaterialValue:$e(h)})),X.value=!0,Y.value=!1)}),De(Oe,e=>{e&&s.push(A.APPLICATION.path)});const{mutate:we,status:ye}=oe({mutationFn:e=>Ee("application",e,{comment:t.value.comment}),onSuccess:e=>{e!=null&&e.success&&(v.invalidateQueries({queryKey:["applications"]}),v.invalidateQueries({queryKey:["applicationsById",C]}),s.push(A.APPLICATION.path),setTimeout(()=>E.success(Q("cancelToast")),150))}}),{mutate:Me,status:Te}=oe({mutationFn:e=>Qe("application",e,{comment:t.value.comment}),onSuccess:e=>{e!=null&&e.success&&(v.invalidateQueries({queryKey:["applications"]}),v.invalidateQueries({queryKey:["applicationsById",C]}),s.push(A.APPLICATION.path),setTimeout(()=>E.success(Q("acceptToast")),150))}}),Ae=()=>{we(C.value)},Be=()=>{Me(C.value)};return(e,o)=>{var K,Z,x,ee,ae,se;const j=S("ManageHead"),q=S("FormInput"),M=S("FormSelect"),T=S("SubTable"),w=S("MyButton"),h=S("Spinner");return $.value?(c(),p("section",va,[i("div",ba,[f(j,{title:"addNewApplicationTitle",to:k(A).APPLICATION.path},null,8,["to"]),X.value?(c(),p("form",{key:0,class:"manage__form",onSubmit:o[4]||(o[4]=ne(()=>{},["prevent"]))},[i("div",_a,[(c(!0),p(R,null,ue(he.value,l=>(c(),p(R,{key:l.id},[l!=null&&l.select?I("",!0):(c(),y(q,{key:0,modelValue:t.value[l.model],"onUpdate:modelValue":z=>t.value[l.model]=z,width:500,placeholder:e.$t(l.placeholder),name:l.icon,type:l==null?void 0:l.type,isDisabled:!0},{default:_(()=>[g(d(e.$t(l.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","name","type"])),l!=null&&l.select?(c(),y(M,{key:1,modelValue:t.value[l.model],"onUpdate:modelValue":z=>t.value[l.model]=z,modelModifiers:{trim:!0},width:500,options:l.options,placeholder:l==null?void 0:l.placeholder,success:l.success,loading:l.loading,isDisabled:!0},{default:_(()=>[g(d(e.$t(l.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","options","placeholder","success","loading"])):I("",!0)],64))),128))]),f(T,{headers:ce.value,table:t.value.applicationTables},null,8,["headers","table"]),i("div",Ia,[f(te,{modelValue:t.value.details,"onUpdate:modelValue":o[0]||(o[0]=l=>t.value.details=l),modelModifiers:{trim:!0},width:500,placeholder:e.$t("appDetailsPlaceholder"),isDisabled:!0},{default:_(()=>[g(d(e.$t("appDetailsLabel")),1)]),_:1},8,["modelValue","placeholder"]),f(te,{modelValue:t.value.comment,"onUpdate:modelValue":o[1]||(o[1]=l=>t.value.comment=l),modelModifiers:{trim:!0},width:500,placeholder:e.$t("appCommentPlaceholder"),isDisabled:!t.value.hasPermission},{default:_(()=>[g(d(e.$t("appCommentLabel")),1)]),_:1},8,["modelValue","placeholder","isDisabled"])]),t.value.hasPermission?(c(),p("div",ga,[(x=(Z=(K=k(u))==null?void 0:K.user)==null?void 0:Z.modules)!=null&&x.includes(k(D).APPLICATION.CONFIRM)?(c(),y(w,{key:0,icon:"approve",type:"submit",color:"green",width:180,onClick:o[2]||(o[2]=()=>P.value=!0),disabled:k(Te)==="pending"},{default:_(()=>[g(d(e.$t("acceptButton")),1)]),_:1},8,["disabled"])):I("",!0),(se=(ae=(ee=k(u))==null?void 0:ee.user)==null?void 0:ae.modules)!=null&&se.includes(k(D).APPLICATION.REFUSAL)?(c(),y(w,{key:1,icon:"refusal",type:"submit",color:"red",width:180,onClick:o[3]||(o[3]=()=>F.value=!0),disabled:k(ye)==="pending"},{default:_(()=>[g(d(e.$t("cancelButton")),1)]),_:1},8,["disabled"])):I("",!0)])):I("",!0),f(ma,{histories:t.value.histories},null,8,["histories"])],32)):I("",!0),Y.value?(c(),y(h,{key:1})):I("",!0)]),f(le,{isOpen:P.value,onOnConfirmed:Be,onOnNotConfirmed:o[5]||(o[5]=()=>P.value=!1)},{default:_(()=>[g(d(e.$t("sureConfirm")),1)]),_:1},8,["isOpen"]),f(le,{isOpen:F.value,onOnConfirmed:Ae,onOnNotConfirmed:o[6]||(o[6]=()=>F.value=!1)},{default:_(()=>[g(d(e.$t("sureRefused")),1)]),_:1},8,["isOpen"])])):I("",!0)}}},Ba=U(fa,[["__scopeId","data-v-acc49568"]]);export{Ba as default};
