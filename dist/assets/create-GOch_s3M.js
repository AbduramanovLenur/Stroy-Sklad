import{_ as Qe,u as Re,a as Je,b as We,y as Xe,c as u,r as v,z as S,B as Ye,d as m,e as T,k as me,h as l,w as Ze,F as x,C as z,D as M,t as b,i as c,A as g,l as ea,m as h,o as r,s as be,f as w,I as aa,H as ta,J as q,E as oa}from"./index-zkjpq5my.js";import{E as sa}from"./EstimateForm-T-gNWdIe.js";import{u as la,r as L}from"./i18n-validators-UGKONhRL.js";import{a as ra,u as na}from"./generic.services-wx_DtCHh.js";import{u as C}from"./useQuery-copJlXh0.js";import{c as ia}from"./crud.services-8TgOaY3n.js";import{f as ua,g as da,h as ca,i as ma,j as ba}from"./manual.services-LRvKoYix.js";import{v as pa}from"./v4-yQnnJER4.js";const va={key:0,class:"manage section-height shadowed"},ga={class:"manage__inner section-padding"},ha={class:"manage__overlay"},_a={key:0,class:"manage__title"},fa={key:1,class:"manage__blocks"},Ia=["onClick"],ya={key:4,class:"error"},ka={__name:"create",async setup(Ea){let o,d;const pe=ra(),ve=ea();Re(),Je();const ge=We(),{user:_}=Xe(ge),A=u(()=>{var e,t;return!!((t=(e=_==null?void 0:_.value.user)==null?void 0:e.modules)!=null&&t.includes(ta.ESTIMATE.CREATE))}),he=v([{id:1,label:"estimateBlock",width:15},{id:2,label:"estimateFloor",width:20},{id:3,label:"estimateMaterial",width:25},{id:4,label:"estimateBudget",width:20},{id:5,label:"estimateCost",width:20}]),s=v({fullname:"",buildingObjectId:[],price:"",tables:[],details:""}),U=v(!1),i=v(""),_e=u(()=>s.value.tables.filter(e=>+e.buildingBlockId==+i.value)),fe=u(()=>({fullname:{required:L},buildingObjectId:{required:L},price:{required:L},tables:{required:L},details:{required:L}})),n=la(fe,s),{data:Ie,isSuccess:ye,isLoading:ke}=([o,d]=S(()=>C({queryKey:["objectsList",{organizationId:_.value.user.organizationId}],queryFn:()=>ua(),enabled:A})),o=await o,d(),o),F=u(()=>s.value.buildingObjectId),Ee=u(()=>!!F.value.length);Ye(F,()=>{U.value||(s.value.tables=[],i.value="")},{immediate:!0});const{data:B,isSuccess:D,isLoading:Ve}=([o,d]=S(()=>C({queryKey:["blocksList",{blockId:F}],queryFn:()=>ma(F.value[0]),enabled:Ee})),o=await o,d(),o),O=u(()=>i.value),K=u(()=>!!O.value),{data:H,isSuccess:$e,isLoading:Se}=([o,d]=S(()=>C({queryKey:["floorsList",{floorId:O}],queryFn:()=>ba(O.value),enabled:K})),o=await o,d(),o),{data:N,isSuccess:Me,isLoading:we}=([o,d]=S(()=>C({queryKey:["costsList",{organizationId:_.value.user.organizationId}],queryFn:()=>da(),enabled:K})),o=await o,d(),o),{data:G,isSuccess:Le,isLoading:Ce}=([o,d]=S(()=>C({queryKey:["materialsList",{organizationId:_.value.user.organizationId}],queryFn:()=>ca(),enabled:K})),o=await o,d(),o),Fe=v([{id:1,model:"fullname",label:"nameEstimateLabel",placeholder:"nameEstimatePlaceholder",icon:"input-company",errorKey:"fullname"}]),Be=v([{id:1,model:"buildingObjectId",label:"objectEstimateLabel",placeholder:"objectEstimatePlaceholder",errorKey:"buildingObjectId",options:Ie,success:ye,loading:ke}]),Te=v([{id:1,model:"floorId",label:"floorsEstimateLabel",placeholder:"floorsEstimatePlaceholder",options:H,success:$e,loading:Se},{id:2,model:"costId",label:"costEstimateLabel",placeholder:"costEstimatePlaceholder",options:N,success:Me,loading:we},{id:3,model:"constructionMaterailIds",label:"materialsEstimateLabel",placeholder:"materialsEstimatePlaceholder",options:G,success:Le,loading:Ce,multiple:!0}]),qe=u(()=>q(B.value||[])),Oe=u(()=>q(H.value||[])),Ke=u(()=>q(N.value||[])),je=u(()=>q(G.value||[])),Pe=e=>{var t;return(t=qe.value[e.buildingBlockId])==null?void 0:t.name},xe=e=>{var t;return(t=Oe.value[e.floorId])==null?void 0:t.name},ze=e=>{var t;return(t=Ke.value[e.costId])==null?void 0:t.name},Ae=e=>{var t;return(t=e.constructionMaterailIds)==null?void 0:t.map((p,f)=>{var I;return{id:f+1,name:((I=je.value[p])==null?void 0:I.name)||"Unknown Material"}})},Ue=e=>{s.value.tables.push({...e,delId:pa(),blockValue:Pe(e),floorValue:xe(e),costValue:ze(e),constructionMaterialIdsValue:Ae(e)}),s.value.price+=parseInt(e.price,10)},De=e=>{s.value.tables=s.value.tables.filter(t=>{const p=t.delId!==e;return p||(s.value.price-=parseInt(t.price,10)),p})},{mutate:He}=na({onMutate:e=>{U.value=!0,e.tables=e.tables.map(t=>{const{delId:p,blockValue:f,floorValue:I,costValue:Q,constructionMaterialIdsValue:R,...j}=t;return j}),e.buildingObjectId=e.buildingObjectId[0]},mutationFn:e=>ia("budget",e),onSuccess:e=>{s.value=oa(s.value),pe.invalidateQueries({queryKey:["budgets"]}),ve.push(be.ESTIMATE.path)}}),Ne=()=>{if(n.value.$validate(),n.value.$errors.length)return;const e={...s.value};He(e),n.value.$reset()};return(e,t)=>{var J,W,X,Y,Z,ee,ae,te,oe,se,le,re,ne,ie,ue,de,ce;const p=h("ManageHead"),f=h("FormInput"),I=h("FormSelect"),Q=h("Spinner"),R=h("SubTable"),j=h("FormTextarea"),Ge=h("CustomButton");return A.value?(r(),m("section",va,[T("div",ga,[me(p,{title:"addNewEstimateTitle",to:l(be).ESTIMATE.path},null,8,["to"]),T("form",{class:"manage__form",onSubmit:Ze(Ne,["prevent"])},[T("div",ha,[(r(!0),m(x,null,z(Fe.value,a=>{var y,k,E,V,$;return r(),g(f,{key:a.id,modelValue:s.value[a.model],"onUpdate:modelValue":P=>s.value[a.model]=P,width:500,placeholder:e.$t(a.placeholder),name:a.icon,error:(k=(y=l(n))==null?void 0:y[a.errorKey])==null?void 0:k.$error,textError:($=(V=(E=l(n))==null?void 0:E[a.errorKey])==null?void 0:V.$errors[0])==null?void 0:$.$message},{default:M(()=>[w(b(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","name","error","textError"])}),128)),(r(!0),m(x,null,z(Be.value,a=>{var y,k,E,V,$;return r(),g(I,{key:a.id,modelValue:s.value[a.model],"onUpdate:modelValue":P=>s.value[a.model]=P,modelModifiers:{trim:!0},width:500,options:a.options,error:(k=(y=l(n))==null?void 0:y[a==null?void 0:a.errorKey])==null?void 0:k.$error,placeholder:a==null?void 0:a.placeholder,textError:($=(V=(E=l(n))==null?void 0:E[a==null?void 0:a.errorKey])==null?void 0:V.$errors[0])==null?void 0:$.$message,success:a.success,loading:a.loading},{default:M(()=>[w(b(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","options","error","placeholder","textError","success","loading"])}),128)),me(f,{modelValue:s.value.price,"onUpdate:modelValue":t[0]||(t[0]=a=>s.value.price=a),width:500,placeholder:e.$t("estimatePricePlaceholder"),name:"money",error:(W=(J=l(n))==null?void 0:J.price)==null?void 0:W.$error,textError:(Z=(Y=(X=l(n))==null?void 0:X.price)==null?void 0:Y.$errors[0])==null?void 0:Z.$message,isDisabled:!0},{default:M(()=>[w(b(e.$t("estimatePriceLabel")),1)]),_:1},8,["modelValue","placeholder","error","textError"])]),l(D)&&((ee=l(B))!=null&&ee.length)?(r(),m("h3",_a,b(e.$t("blockEstimateLabel")),1)):c("",!0),l(D)&&((ae=l(B))!=null&&ae.length)?(r(),m("ul",fa,[(r(!0),m(x,null,z(l(B),a=>(r(),m("li",{key:a.id,class:"manage__block",onClick:()=>i.value=a.id},[T("div",{class:aa(`manage__block-box ${i.value===a.id?"is-active":""}`)},b(a.name),3)],8,Ia))),128))])):c("",!0),l(Ve)?(r(),g(Q,{key:2})):c("",!0),i.value?(r(),g(sa,{key:3,selects:Te.value,blockId:i.value,onOnAddTable:Ue,onOnChangeBlock:t[1]||(t[1]=a=>i.value=a)},null,8,["selects","blockId"])):c("",!0),(oe=(te=l(n))==null?void 0:te.tables)!=null&&oe.$error?(r(),m("span",ya,b((re=(le=(se=l(n))==null?void 0:se.tables)==null?void 0:le.$errors[0])==null?void 0:re.$message),1)):c("",!0),i.value?(r(),g(R,{key:5,headers:he.value,table:_e.value,onOnActionDelete:De,isShowDelete:!0},null,8,["headers","table"])):c("",!0),i.value?(r(),g(j,{key:6,modelValue:s.value.details,"onUpdate:modelValue":t[2]||(t[2]=a=>s.value.details=a),modelModifiers:{trim:!0},width:500,placeholder:e.$t("estimateCommentPlaceholder"),error:(ie=(ne=l(n))==null?void 0:ne.details)==null?void 0:ie.$error,textError:(ce=(de=(ue=l(n))==null?void 0:ue.details)==null?void 0:de.$errors[0])==null?void 0:ce.$message},{default:M(()=>[w(b(e.$t("estimateCommentLabel")),1)]),_:1},8,["modelValue","placeholder","error","textError"])):c("",!0),i.value?(r(),g(Ge,{key:7,className:"manage__submit"},{default:M(()=>[w(b(e.$t("formButton")),1)]),_:1})):c("",!0)],32)])])):c("",!0)}}},Ba=Qe(ka,[["__scopeId","data-v-3adbad20"]]);export{Ba as default};
