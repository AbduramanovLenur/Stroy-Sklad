import{_ as oa,u as ra,a as ua,b as na,y as ia,c as i,r as b,z as p,B as K,d as v,e as L,k as ca,h as o,w as da,F as N,C as Me,t as h,i as m,A as I,D as F,l as ma,G as ba,m as y,o as r,s as z,f as w,I as ga,H as va,J as C,E as pa}from"./index-pfgEwabb.js";import{E as ha}from"./EstimateForm-GRXgKSEB.js";import{u as Ia,r as _}from"./i18n-validators-vl7r2d_M.js";import{a as ya,u as _a}from"./generic.services-pFsvETxq.js";import{u as k}from"./useQuery-MTkSqSbf.js";import{a as ka,u as Ea}from"./crud.services-dRS2qKm6.js";import{f as Sa,g as Ta,h as Va,i as Ma,j as La,b as Fa}from"./manual.services-HMyLT33c.js";import{v as Le}from"./v4-yQnnJER4.js";const wa={key:0,class:"manage section-height shadowed"},Ca={class:"manage__inner section-padding"},$a={class:"manage__overlay"},fa={key:0,class:"manage__title"},Ba={key:1,class:"manage__blocks"},ja=["onClick"],Oa={key:3,class:"error"},qa={__name:"update",async setup(Ka){let l,u;const P=ya(),A=ma(),Fe=ba(),we=ra(),{t:Ce}=ua(),$e=na(),{user:n}=ia($e),S=i(()=>{var e,t;return!!((t=(e=n==null?void 0:n.value.user)==null?void 0:e.modules)!=null&&t.includes(va.ESTIMATE.CREATE))}),$=b(Fe.params.id),fe=b([{id:1,label:"estimateBlock",width:15},{id:2,label:"estimateFloor",width:20},{id:3,label:"estimateMaterial",width:25},{id:4,label:"estimateBudget",width:20},{id:5,label:"estimateCost",width:20}]),s=b({id:"",fullname:"",buildingObjectId:[],price:"",budgetTables:[],details:"",stateId:[]}),D=b(!1),f=b(!1),c=b(""),Be=i(()=>s.value.budgetTables.filter(e=>+e.buildingBlockId==+c.value)),je=i(()=>({id:{required:_},fullname:{required:_},buildingObjectId:{required:_},price:{required:_},budgetTables:{required:_},details:{required:_},stateId:{required:_}})),d=Ia(je,s),{data:Oe,isSuccess:qe,isLoading:Ke}=([l,u]=p(()=>k({queryKey:["objectsList",{organizationId:n.value.user.organizationId,name:n.value.user.fullName}],queryFn:()=>Sa(),enabled:S})),l=await l,u(),l),T=i(()=>s.value.buildingObjectId[0]),Ne=i(()=>!!T.value);K(T,()=>{!f.value&&!D.value&&(s.value.budgetTables=[],c.value=""),f.value=!1},{immediate:!0});const{data:V,isSuccess:x,isLoading:ze}=([l,u]=p(()=>k({queryKey:["blocksList",{objectId:T,organizationId:n.value.user.organizationId,name:n.value.user.fullName}],queryFn:()=>Ta(T.value),enabled:Ne})),l=await l,u(),l),B=i(()=>c.value),j=i(()=>!!B.value),{data:U,isSuccess:Pe,isLoading:Ae}=([l,u]=p(()=>k({queryKey:["floorsList",{blockId:B,organizationId:n.value.user.organizationId,name:n.value.user.fullName}],queryFn:()=>Va(B.value),enabled:j})),l=await l,u(),l),{data:G,isSuccess:De,isLoading:xe}=([l,u]=p(()=>k({queryKey:["costsList",{organizationId:n.value.user.organizationId,name:n.value.user.fullName}],queryFn:()=>Ma(),enabled:j})),l=await l,u(),l),{data:H,isSuccess:Ue,isLoading:Ge}=([l,u]=p(()=>k({queryKey:["materialsList",{organizationId:n.value.user.organizationId,name:n.value.user.fullName}],queryFn:()=>La(),enabled:j})),l=await l,u(),l),{data:He,isSuccess:Re,isLoading:Qe}=([l,u]=p(()=>k({queryKey:["states"],queryFn:()=>Fa(),enabled:S})),l=await l,u(),l),Je=b([{id:1,model:"fullname",label:"nameEstimateLabel",placeholder:"nameEstimatePlaceholder",icon:"input-company",errorKey:"fullname"},{id:2,model:"buildingObjectId",label:"objectEstimateLabel",placeholder:"objectEstimatePlaceholder",errorKey:"buildingObjectId",options:Oe,success:qe,loading:Ke,select:!0},{id:3,model:"price",label:"estimatePriceLabel",placeholder:"estimatePricePlaceholder",icon:"money",errorKey:"price",isDisabled:!0},{id:4,model:"stateId",label:"estimateStateLabel",placeholder:"estimateStatePlaceholder",errorKey:"stateId",options:He,success:Re,loading:Qe,select:!0}]),We=b([{id:1,model:"floorId",label:"floorsEstimateLabel",placeholder:"floorsEstimatePlaceholder",options:U,success:Pe,loading:Ae,select:!0},{id:2,model:"costId",label:"costEstimateLabel",placeholder:"costEstimatePlaceholder",options:G,success:De,loading:xe,select:!0},{id:3,model:"constructionMaterailIds",label:"materialsEstimateLabel",placeholder:"materialsEstimatePlaceholder",options:H,success:Ue,loading:Ge,multiple:!0,select:!0},{id:4,model:"price",label:"priceEstimateLabel",placeholder:"priceEstimatePlaceholder",icon:"money"}]),R=i(()=>C(V.value||[])),Q=i(()=>C(U.value||[])),J=i(()=>C(G.value||[])),W=i(()=>C(H.value||[])),X=e=>{var t;return(t=R.value[e.buildingBlockId])==null?void 0:t.name},Y=e=>{var t;return(t=Q.value[e.floorId])==null?void 0:t.name},Z=e=>{var t;return(t=J.value[e.costId])==null?void 0:t.name},ee=e=>{var t;return(t=e.constructionMaterailIds)==null?void 0:t.map((g,M)=>{var E;return{id:M+1,name:((E=W.value[g])==null?void 0:E.name)||"Unknown Material"}})},Xe=i(()=>!!(s.value.budgetTables.length&&Object.keys(R.value).length&&Object.keys(Q.value).length&&Object.keys(J.value).length&&Object.keys(W.value).length)),ae=b(!0);K(Xe,e=>{e&&ae.value&&(s.value.budgetTables=s.value.budgetTables.map(t=>({...t,delId:Le(),blockValue:X(t),floorValue:Y(t),costValue:Z(t),constructionMaterialIdsValue:ee(t)})),ae.value=!1)},{immediate:!0});const Ye=e=>{s.value.budgetTables.push({...e,delId:Le(),blockValue:X(e),floorValue:Y(e),costValue:Z(e),constructionMaterialIdsValue:ee(e)}),s.value.price=+s.value.price+e.price},Ze=e=>{s.value.budgetTables=s.value.budgetTables.filter(t=>{const g=t.delId!==e;return g||(s.value.price-=t.price),g})},{isError:ea}=([l,u]=p(()=>k({queryKey:["budgetById",$,n.value.user.fullName],queryFn:()=>ka("budget",$.value),select:e=>{s.value.id=e.id,s.value.fullname=e.fullname,s.value.buildingObjectId=[e.buildingObjectId],s.value.price=e.price,s.value.budgetTables=[...e.budgetTables],s.value.details=e.details,s.value.stateId=[e.stateId],f.value=!0},enabled:S})),l=await l,u(),l);K(ea,e=>{e&&A.push(z.ESTIMATE.path)});const{mutate:aa,status:ta}=_a({onMutate:e=>{D.value=!0,e.budgetTables=e.budgetTables.map(t=>{const{delId:g,blockValue:M,floorValue:E,costValue:te,constructionMaterialIdsValue:se,...O}=t;return O}),e.buildingObjectId=e.buildingObjectId[0],e.stateId=e.stateId[0]},mutationFn:e=>Ea("budget",e),onSuccess:e=>{e!=null&&e.success&&(s.value=pa(s.value),P.invalidateQueries({queryKey:["budgets"]}),P.invalidateQueries({queryKey:["budgetById",$]}),A.push(z.ESTIMATE.path),setTimeout(()=>we.success(Ce("updateToast")),150))}}),sa=()=>{if(d.value.$validate(),d.value.$errors.length)return;const e={...s.value};aa(e),d.value.$reset()};return(e,t)=>{var le,oe,re,ue,ne,ie,ce,de,me,be,ge,ve;const g=y("ManageHead"),M=y("FormInput"),E=y("FormSelect"),te=y("SubTable"),se=y("FormTextarea"),O=y("CustomButton"),la=y("Spinner");return S.value?(r(),v("section",wa,[L("div",Ca,[ca(g,{title:"addNewEstimateTitle",to:o(z).ESTIMATE.path},null,8,["to"]),L("form",{class:"manage__form",onSubmit:da(sa,["prevent"])},[L("div",$a,[(r(!0),v(N,null,Me(Je.value,a=>{var pe,he,Ie,ye,_e,ke,Ee,Se,Te,Ve;return r(),v(N,{key:a.id},[a!=null&&a.select?m("",!0):(r(),I(M,{key:0,modelValue:s.value[a.model],"onUpdate:modelValue":q=>s.value[a.model]=q,width:500,placeholder:e.$t(a.placeholder),name:a.icon,error:(he=(pe=o(d))==null?void 0:pe[a.errorKey])==null?void 0:he.$error,textError:(_e=(ye=(Ie=o(d))==null?void 0:Ie[a.errorKey])==null?void 0:ye.$errors[0])==null?void 0:_e.$message,isDisabled:a==null?void 0:a.isDisabled},{default:F(()=>[w(h(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","name","error","textError","isDisabled"])),a!=null&&a.select?(r(),I(E,{key:1,modelValue:s.value[a.model],"onUpdate:modelValue":q=>s.value[a.model]=q,modelModifiers:{trim:!0},width:500,options:a.options,error:(Ee=(ke=o(d))==null?void 0:ke[a==null?void 0:a.errorKey])==null?void 0:Ee.$error,placeholder:a==null?void 0:a.placeholder,textError:(Ve=(Te=(Se=o(d))==null?void 0:Se[a==null?void 0:a.errorKey])==null?void 0:Te.$errors[0])==null?void 0:Ve.$message,success:a.success,loading:a.loading},{default:F(()=>[w(h(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","options","error","placeholder","textError","success","loading"])):m("",!0)],64)}),128))]),o(x)&&((le=o(V))!=null&&le.length)?(r(),v("h3",fa,h(e.$t("blockEstimateLabel")),1)):m("",!0),o(x)&&((oe=o(V))!=null&&oe.length)?(r(),v("ul",Ba,[(r(!0),v(N,null,Me(o(V),a=>(r(),v("li",{key:a.id,class:"manage__block",onClick:()=>c.value=a.id},[L("div",{class:ga(`manage__block-box ${c.value===a.id?"is-active":""}`)},h(a.name),3)],8,ja))),128))])):m("",!0),c.value?(r(),I(ha,{key:2,subFields:We.value,blockId:c.value,onOnAddTable:Ye,onOnChangeBlock:t[0]||(t[0]=a=>c.value=a)},null,8,["subFields","blockId"])):m("",!0),(ue=(re=o(d))==null?void 0:re.budgetTables)!=null&&ue.$error?(r(),v("span",Oa,h((ce=(ie=(ne=o(d))==null?void 0:ne.budgetTables)==null?void 0:ie.$errors[0])==null?void 0:ce.$message),1)):m("",!0),c.value?(r(),I(te,{key:4,headers:fe.value,table:Be.value,onOnActionDelete:Ze,isShowDelete:!0},null,8,["headers","table"])):m("",!0),c.value?(r(),I(se,{key:5,modelValue:s.value.details,"onUpdate:modelValue":t[1]||(t[1]=a=>s.value.details=a),modelModifiers:{trim:!0},width:500,placeholder:e.$t("estimateCommentPlaceholder"),error:(me=(de=o(d))==null?void 0:de.details)==null?void 0:me.$error,textError:(ve=(ge=(be=o(d))==null?void 0:be.details)==null?void 0:ge.$errors[0])==null?void 0:ve.$message},{default:F(()=>[w(h(e.$t("estimateCommentLabel")),1)]),_:1},8,["modelValue","placeholder","error","textError"])):m("",!0),c.value?(r(),I(O,{key:6,className:"manage__submit",disabled:o(ta)==="pending"},{default:F(()=>[w(h(e.$t("formButton")),1)]),_:1},8,["disabled"])):m("",!0)],32),o(ze)?(r(),I(la,{key:0})):m("",!0)])])):m("",!0)}}},Ha=oa(qa,[["__scopeId","data-v-cff66177"]]);export{Ha as default};
