import{_ as We,u as Xe,a as Ye,b as Ze,x as ea,c as i,r as v,y as V,B as aa,d as b,e as O,k as be,h as s,w as ta,F as x,C as A,D as $,t as p,i as m,z as g,l as oa,m as h,o as r,A as pe,f as S,H as la,G as sa,I as T}from"./index-KKCGiaOF.js";import{E as ra}from"./EstimateForm-plVuo6xM.js";import{u as na,r as M}from"./i18n-validators-TpKHFGOg.js";import{a as ia,u as ua}from"./generic.services-xhLq1RN3.js";import{u as L}from"./useQuery-W7o1xA7A.js";import{c as da}from"./crud.services-tsBZfuRX.js";import{f as ca,g as ma,h as ba,i as pa,j as va}from"./manual.services-1tbz_eEo.js";import{v as ga}from"./v4-yQnnJER4.js";const ha={key:0,class:"manage section-height shadowed"},_a={class:"manage__inner section-padding"},fa={class:"manage__overlay"},ya={key:0,class:"manage__title"},Ia={key:1,class:"manage__blocks"},ka=["onClick"],Ea={key:4,class:"error"},Va={__name:"create",async setup($a){let o,d;const ve=ia(),ge=oa(),he=Xe(),{t:_e}=Ye(),fe=Ze(),{user:_}=ea(fe),P=i(()=>{var e,t;return!!((t=(e=_==null?void 0:_.value.user)==null?void 0:e.modules)!=null&&t.includes(sa.ESTIMATE.CREATE))}),ye=v([{id:1,label:"estimateBlock",width:200},{id:2,label:"estimateFloor",width:200},{id:3,label:"estimateMaterial",width:260},{id:4,label:"estimateBudget",width:200},{id:5,label:"estimateCost"}]),l=v({fullname:"",buildingObjectId:[],price:"",tables:[],details:""}),z=v(!1),u=v(""),Ie=i(()=>l.value.tables.filter(e=>+e.buildingBlockId==+u.value)),ke=i(()=>({fullname:{required:M},buildingObjectId:{required:M},price:{required:M},tables:{required:M},details:{required:M}})),n=na(ke,l),{data:Ee,isSuccess:Ve,isLoading:$e}=([o,d]=V(()=>L({queryKey:["objectsList",{organizationId:_.value.user.organizationId}],queryFn:()=>ca(),enabled:P})),o=await o,d(),o),w=i(()=>l.value.buildingObjectId),Se=i(()=>!!w.value.length);aa(w,()=>{z.value||(l.value.tables=[],u.value="")},{immediate:!0});const{data:C,isSuccess:U,isLoading:Me}=([o,d]=V(()=>L({queryKey:["blocksList",{blockId:w}],queryFn:()=>pa(w.value[0]),enabled:Se})),o=await o,d(),o),j=i(()=>u.value),q=i(()=>!!j.value),{data:D,isSuccess:Le,isLoading:we}=([o,d]=V(()=>L({queryKey:["floorsList",{floorId:j}],queryFn:()=>va(j.value),enabled:q})),o=await o,d(),o),{data:N,isSuccess:Ce,isLoading:Fe}=([o,d]=V(()=>L({queryKey:["costsList",{organizationId:_.value.user.organizationId}],queryFn:()=>ma(),enabled:q})),o=await o,d(),o),{data:H,isSuccess:Be,isLoading:Oe}=([o,d]=V(()=>L({queryKey:["materialsList",{organizationId:_.value.user.organizationId}],queryFn:()=>ba(),enabled:q})),o=await o,d(),o),Te=v([{id:1,model:"fullname",label:"nameEstimateLabel",placeholder:"nameEstimatePlaceholder",icon:"input-company",errorKey:"fullname"}]),je=v([{id:1,model:"buildingObjectId",label:"objectEstimateLabel",placeholder:"objectEstimatePlaceholder",errorKey:"buildingObjectId",options:Ee,success:Ve,loading:$e}]),qe=v([{id:1,model:"floorId",label:"floorsEstimateLabel",placeholder:"floorsEstimatePlaceholder",options:D,success:Le,loading:we},{id:2,model:"costId",label:"costEstimateLabel",placeholder:"costEstimatePlaceholder",options:N,success:Ce,loading:Fe},{id:3,model:"constructionMaterailIds",label:"materialsEstimateLabel",placeholder:"materialsEstimatePlaceholder",options:H,success:Be,loading:Oe,multiple:!0}]),G=i(()=>T(C.value||[])),Q=i(()=>T(D.value||[])),R=i(()=>T(N.value||[])),J=i(()=>T(H.value||[])),Ke=e=>{var t;return(t=G.value[e.buildingBlockId])==null?void 0:t.name},xe=e=>{var t;return(t=Q.value[e.floorId])==null?void 0:t.name},Ae=e=>{var t;return(t=R.value[e.costId])==null?void 0:t.name},Pe=e=>{var t;return(t=e.constructionMaterailIds)==null?void 0:t.map((c,F)=>{var B;return{id:F+1,name:((B=J.value[c])==null?void 0:B.name)||"Unknown Material"}})},ze=i(()=>!!(Object.keys(G.value).length&&Object.keys(Q.value).length&&Object.keys(R.value).length&&Object.keys(J.value).length)),Ue=e=>{if(ze){l.value.tables.push({...e,delId:ga(),blockValue:Ke(e),floorValue:xe(e),costValue:Ae(e),constructionMaterialIdsValue:Pe(e)}),l.value.price=+l.value.price+ +e.price;return}he.error(_e("estimateEmptyData"))},De=e=>{l.value.tables=l.value.tables.filter(t=>t.delId!==e)},{mutate:Ne}=ua({onMutate:e=>{z.value=!0,e.tables=e.tables.map(t=>{let c={...t};return delete c.delId,delete c.blockValue,delete c.floorValue,delete c.costValue,delete c.constructionMaterialIdsValue,c}),e.buildingObjectId=e.buildingObjectId[0]},mutationFn:e=>da("budget",e),onSuccess:()=>{ve.invalidateQueries({queryKey:["budgets"]}),ge.push(pe.ESTIMATE.path)}}),He=()=>{n.value.$validate(),!n.value.$errors.length&&(Ne(l.value),n.value.$reset())};return(e,t)=>{var W,X,Y,Z,ee,ae,te,oe,le,se,re,ne,ie,ue,de,ce,me;const c=h("ManageHead"),F=h("FormInput"),B=h("FormSelect"),Ge=h("Spinner"),Qe=h("SubTable"),Re=h("FormTextarea"),Je=h("CustomButton");return P.value?(r(),b("section",ha,[O("div",_a,[be(c,{title:"addNewEstimateTitle",to:s(pe).ESTIMATE.path},null,8,["to"]),O("form",{class:"manage__form",onSubmit:ta(He,["prevent"])},[O("div",fa,[(r(!0),b(x,null,A(Te.value,a=>{var f,y,I,k,E;return r(),g(F,{key:a.id,modelValue:l.value[a.model],"onUpdate:modelValue":K=>l.value[a.model]=K,width:500,placeholder:e.$t(a.placeholder),name:a.icon,error:(y=(f=s(n))==null?void 0:f[a.errorKey])==null?void 0:y.$error,textError:(E=(k=(I=s(n))==null?void 0:I[a.errorKey])==null?void 0:k.$errors[0])==null?void 0:E.$message},{default:$(()=>[S(p(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","name","error","textError"])}),128)),(r(!0),b(x,null,A(je.value,a=>{var f,y,I,k,E;return r(),g(B,{key:a.id,modelValue:l.value[a.model],"onUpdate:modelValue":K=>l.value[a.model]=K,modelModifiers:{trim:!0},width:500,options:a.options,error:(y=(f=s(n))==null?void 0:f[a==null?void 0:a.errorKey])==null?void 0:y.$error,placeholder:a==null?void 0:a.placeholder,textError:(E=(k=(I=s(n))==null?void 0:I[a==null?void 0:a.errorKey])==null?void 0:k.$errors[0])==null?void 0:E.$message,success:a.success,loading:a.loading},{default:$(()=>[S(p(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","options","error","placeholder","textError","success","loading"])}),128)),be(F,{modelValue:l.value.price,"onUpdate:modelValue":t[0]||(t[0]=a=>l.value.price=a),width:500,placeholder:e.$t("estimatePricePlaceholder"),name:"money",error:(X=(W=s(n))==null?void 0:W.price)==null?void 0:X.$error,textError:(ee=(Z=(Y=s(n))==null?void 0:Y.price)==null?void 0:Z.$errors[0])==null?void 0:ee.$message,isDisabled:!0},{default:$(()=>[S(p(e.$t("estimatePriceLabel")),1)]),_:1},8,["modelValue","placeholder","error","textError"])]),s(U)&&((ae=s(C))!=null&&ae.length)?(r(),b("h3",ya,p(e.$t("blockEstimateLabel")),1)):m("",!0),s(U)&&((te=s(C))!=null&&te.length)?(r(),b("ul",Ia,[(r(!0),b(x,null,A(s(C),a=>(r(),b("li",{key:a.id,class:"manage__block",onClick:()=>u.value=a.id},[O("div",{class:la(`manage__block-box ${u.value===a.id?"is-active":""}`)},p(a.name),3)],8,ka))),128))])):m("",!0),s(Me)?(r(),g(Ge,{key:2})):m("",!0),u.value?(r(),g(ra,{key:3,selects:qe.value,blockId:u.value,onOnAddTable:Ue,onOnChangeBlock:t[1]||(t[1]=a=>u.value=a)},null,8,["selects","blockId"])):m("",!0),(le=(oe=s(n))==null?void 0:oe.tables)!=null&&le.$error?(r(),b("span",Ea,p((ne=(re=(se=s(n))==null?void 0:se.tables)==null?void 0:re.$errors[0])==null?void 0:ne.$message),1)):m("",!0),u.value?(r(),g(Qe,{key:5,headers:ye.value,table:Ie.value,onOnActionDelete:De,isShowDelete:!0},null,8,["headers","table"])):m("",!0),u.value?(r(),g(Re,{key:6,modelValue:l.value.details,"onUpdate:modelValue":t[2]||(t[2]=a=>l.value.details=a),modelModifiers:{trim:!0},width:500,placeholder:e.$t("estimateCommentPlaceholder"),error:(ue=(ie=s(n))==null?void 0:ie.details)==null?void 0:ue.$error,textError:(me=(ce=(de=s(n))==null?void 0:de.details)==null?void 0:ce.$errors[0])==null?void 0:me.$message},{default:$(()=>[S(p(e.$t("estimateCommentLabel")),1)]),_:1},8,["modelValue","placeholder","error","textError"])):m("",!0),u.value?(r(),g(Je,{key:7,className:"manage__submit"},{default:$(()=>[S(p(e.$t("formButton")),1)]),_:1})):m("",!0)],32)])])):m("",!0)}}},Ta=We(Va,[["__scopeId","data-v-76ecd5c7"]]);export{Ta as default};
//# sourceMappingURL=create-YveukwMW.js.map
