import{_ as ca,u as ma,a as ba,b as ga,x as va,c as i,r as m,y as k,B as D,d as b,e as j,k as H,h as o,w as pa,F as q,C as K,D as M,t as g,i as v,z as E,l as ha,E as Ia,m as V,o as r,A as N,f as L,H as ya,G as fa,I as x}from"./index-sKMtYVf1.js";import{E as _a}from"./EstimateForm-lBVBgS4D.js";import{u as ka,r as S}from"./i18n-validators-UluQ0_Lr.js";import{a as Ea,u as Va}from"./generic.services-Y9l1kbCB.js";import{u as T}from"./useQuery-oNoZrsai.js";import{a as Sa,u as Ta}from"./crud.services-OfzCCZDD.js";import{f as $a,g as Ma,h as La,i as wa,j as Ca,b as Fa}from"./manual.services-XDT6etPx.js";import{v as we}from"./v4-yQnnJER4.js";const Ba={key:0,class:"manage section-height shadowed"},Oa={class:"manage__inner section-padding"},ja={class:"manage__overlay"},qa={key:0,class:"manage__title"},Ka={key:1,class:"manage__blocks"},xa=["onClick"],Pa={key:4,class:"error"},Ua={__name:"update",async setup(Aa){let s,d;const G=Ea(),R=ha(),Ce=Ia(),Fe=ma(),{t:Be}=ba(),Oe=ga(),{user:$}=va(Oe),F=i(()=>{var e,t;return!!((t=(e=$==null?void 0:$.value.user)==null?void 0:e.modules)!=null&&t.includes(fa.ESTIMATE.CREATE))}),P=m(Ce.params.id),je=m([{id:1,label:"estimateBlock",width:200},{id:2,label:"estimateFloor",width:200},{id:3,label:"estimateMaterial",width:260},{id:4,label:"estimateBudget",width:200},{id:5,label:"estimateCost"}]),l=m({id:"",fullname:"",buildingObjectId:[],price:"",budgetTables:[],details:"",stateId:[]}),Q=m(!1),U=m(!1),n=m(""),qe=i(()=>l.value.budgetTables.filter(e=>+e.buildingBlockId==+n.value)),Ke=i(()=>({id:{required:S},fullname:{required:S},buildingObjectId:{required:S},price:{required:S},budgetTables:{required:S},details:{required:S},stateId:{required:S}})),u=ka(Ke,l),{data:xe,isSuccess:Pe,isLoading:Ue}=([s,d]=k(()=>T({queryKey:["objectsList",{organizationId:$.value.user.organizationId}],queryFn:()=>$a(),enabled:F})),s=await s,d(),s),B=i(()=>l.value.buildingObjectId),Ae=i(()=>!!B.value.length);D(B,()=>{!U.value&&!Q.value&&(l.value.budgetTables=[],n.value=""),U.value=!1},{immediate:!0});const{data:p,isSuccess:W,isLoading:ze}=([s,d]=k(()=>T({queryKey:["blocksList",{blockId:B}],queryFn:()=>wa(B.value[0]),enabled:Ae})),s=await s,d(),s),A=i(()=>n.value),z=i(()=>!!A.value),{data:J,isSuccess:De,isLoading:He}=([s,d]=k(()=>T({queryKey:["floorsList",{floorId:A}],queryFn:()=>Ca(A.value),enabled:z})),s=await s,d(),s),{data:X,isSuccess:Ne,isLoading:Ge}=([s,d]=k(()=>T({queryKey:["costsList",{organizationId:$.value.user.organizationId}],queryFn:()=>Ma(),enabled:z})),s=await s,d(),s),{data:Y,isSuccess:Re,isLoading:Qe}=([s,d]=k(()=>T({queryKey:["materialsList",{organizationId:$.value.user.organizationId}],queryFn:()=>La(),enabled:z})),s=await s,d(),s),{data:We,isSuccess:Je,isLoading:Xe}=([s,d]=k(()=>T({queryKey:["states"],queryFn:()=>Fa(),enabled:F})),s=await s,d(),s),Ye=m([{id:1,model:"fullname",label:"nameEstimateLabel",placeholder:"nameEstimatePlaceholder",icon:"input-company",errorKey:"fullname"}]),Ze=m([{id:1,model:"buildingObjectId",label:"objectEstimateLabel",placeholder:"objectEstimatePlaceholder",errorKey:"buildingObjectId",options:xe,success:Pe,loading:Ue}]),ea=m([{id:1,model:"floorId",label:"floorsEstimateLabel",placeholder:"floorsEstimatePlaceholder",options:J,success:De,loading:He},{id:2,model:"costId",label:"costEstimateLabel",placeholder:"costEstimatePlaceholder",options:X,success:Ne,loading:Ge},{id:3,model:"constructionMaterailIds",label:"materialsEstimateLabel",placeholder:"materialsEstimatePlaceholder",options:Y,success:Re,loading:Qe,multiple:!0}]),aa=m([{id:1,model:"details",label:"estimateCommentLabel",placeholder:"estimateCommentPlaceholder",errorKey:"details"}]),Z=i(()=>x(p.value||[])),ee=i(()=>x(J.value||[])),ae=i(()=>x(X.value||[])),te=i(()=>x(Y.value||[])),le=e=>{var t;return(t=Z.value[e.buildingBlockId])==null?void 0:t.name},se=e=>{var t;return(t=ee.value[e.floorId])==null?void 0:t.name},oe=e=>{var t;return(t=ae.value[e.costId])==null?void 0:t.name},re=e=>{var t;return(t=e.constructionMaterailIds)==null?void 0:t.map((c,O)=>{var w;return{id:O+1,name:((w=te.value[c])==null?void 0:w.name)||"Unknown Material"}})},ue=i(()=>l.value.budgetTables.length&&Object.keys(Z.value).length&&Object.keys(ee.value).length&&Object.keys(ae.value).length&&Object.keys(te.value).length),ta=e=>{if(ue){l.value.budgetTables.push({...e,delId:we(),blockValue:le(e),floorValue:se(e),costValue:oe(e),constructionMaterialIdsValue:re(e)}),l.value.price=+l.value.price+ +e.price;return}Fe.error(Be("estimateEmptyData"))},de=m(!0);D(ue,e=>{e&&de.value&&(l.value.budgetTables=l.value.budgetTables.map(t=>({...t,delId:we(),blockValue:le(t),floorValue:se(t),costValue:oe(t),constructionMaterialIdsValue:re(t)})),de.value=!1)},{immediate:!0});const la=e=>{l.value.budgetTables=l.value.budgetTables.filter(t=>t.delId!==e)},{isError:sa}=([s,d]=k(()=>T({queryKey:["budgetsById",P],queryFn:()=>Sa("budget",P.value),select:e=>{l.value.id=e.id,l.value.fullname=e.fullname,l.value.buildingObjectId=[e.buildingObjectId],l.value.price=e.price,l.value.budgetTables=[...e.budgetTables],l.value.details=e.details,l.value.stateId=[e.stateId],U.value=!0},enabled:F})),s=await s,d(),s);D(sa,e=>{e&&R.push(N.HOME.path)});const{mutate:oa}=Va({onMutate:e=>{Q.value=!0,e.budgetTables=e.budgetTables.map(t=>{let c={...t};return delete c.delId,delete c.blockValue,delete c.floorValue,delete c.costValue,delete c.constructionMaterialIdsValue,c}),e.buildingObjectId=e.buildingObjectId[0],e.stateId=e.stateId[0]},mutationFn:e=>Ta("budget",e),onSuccess:()=>{G.invalidateQueries({queryKey:["budgets"]}),G.invalidateQueries({queryKey:["budgetsById",P]}),R.push(N.ESTIMATE.path)}}),ra=()=>{u.value.$validate(),!u.value.$errors.length&&(oa(l.value),u.value.$reset())};return(e,t)=>{var ie,ne,ce,me,be,ge,ve,pe,he,Ie,ye,fe,_e,ke,Ee,Ve,Se,Te,$e,Me,Le;const c=V("ManageHead"),O=V("FormInput"),w=V("FormSelect"),ua=V("Spinner"),da=V("SubTable"),ia=V("FormTextarea"),na=V("CustomButton");return F.value?(r(),b("section",Ba,[j("div",Oa,[H(c,{title:"addNewEstimateTitle",to:o(N).ESTIMATE.path},null,8,["to"]),j("form",{class:"manage__form",onSubmit:pa(ra,["prevent"])},[j("div",ja,[(r(!0),b(q,null,K(Ye.value,a=>{var h,I,y,f,_;return r(),E(O,{key:a.id,modelValue:l.value[a.model],"onUpdate:modelValue":C=>l.value[a.model]=C,width:500,placeholder:e.$t(a.placeholder),name:a.icon,error:(I=(h=o(u))==null?void 0:h[a.errorKey])==null?void 0:I.$error,textError:(_=(f=(y=o(u))==null?void 0:y[a.errorKey])==null?void 0:f.$errors[0])==null?void 0:_.$message},{default:M(()=>[L(g(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","name","error","textError"])}),128)),(r(!0),b(q,null,K(Ze.value,a=>{var h,I,y,f,_;return r(),E(w,{key:a.id,modelValue:l.value[a.model],"onUpdate:modelValue":C=>l.value[a.model]=C,modelModifiers:{trim:!0},width:500,options:a.options,error:(I=(h=o(u))==null?void 0:h[a==null?void 0:a.errorKey])==null?void 0:I.$error,placeholder:a==null?void 0:a.placeholder,textError:(_=(f=(y=o(u))==null?void 0:y[a==null?void 0:a.errorKey])==null?void 0:f.$errors[0])==null?void 0:_.$message,success:a.success,loading:a.loading},{default:M(()=>[L(g(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","options","error","placeholder","textError","success","loading"])}),128)),H(O,{modelValue:l.value.price,"onUpdate:modelValue":t[0]||(t[0]=a=>l.value.price=a),width:500,placeholder:e.$t("estimatePricePlaceholder"),name:"money",error:(ne=(ie=o(u))==null?void 0:ie.price)==null?void 0:ne.$error,textError:(be=(me=(ce=o(u))==null?void 0:ce.price)==null?void 0:me.$errors[0])==null?void 0:be.$message,isDisabled:!0},{default:M(()=>[L(g(e.$t("estimatePriceLabel")),1)]),_:1},8,["modelValue","placeholder","error","textError"]),H(w,{modelValue:l.value.stateId,"onUpdate:modelValue":t[1]||(t[1]=a=>l.value.stateId=a),modelModifiers:{trim:!0},width:500,options:o(We),error:(ve=(ge=o(u))==null?void 0:ge.stateId)==null?void 0:ve.$error,placeholder:"estimateStatePlaceholder",textError:(Ie=(he=(pe=o(u))==null?void 0:pe.stateId)==null?void 0:he.$errors[0])==null?void 0:Ie.$message,success:o(Je),loading:o(Xe)},{default:M(()=>[L(g(e.$t("estimateStateLabel")),1)]),_:1},8,["modelValue","options","error","textError","success","loading"])]),o(W)&&((ye=o(p))!=null&&ye.length)?(r(),b("h3",qa,g(e.$t("blockEstimateLabel")),1)):v("",!0),o(W)&&((fe=o(p))!=null&&fe.length)?(r(),b("ul",Ka,[(r(!0),b(q,null,K(o(p),a=>(r(),b("li",{key:a.id,class:"manage__block",onClick:()=>n.value=a.id},[j("div",{class:ya(`manage__block-box ${n.value===a.id?"is-active":""}`)},g(a.name),3)],8,xa))),128))])):v("",!0),o(ze)?(r(),E(ua,{key:2})):v("",!0),n.value&&((_e=o(p))!=null&&_e.length)?(r(),E(_a,{key:3,selects:ea.value,blockId:n.value,onOnAddTable:ta,onOnChangeBlock:t[2]||(t[2]=a=>n.value=a)},null,8,["selects","blockId"])):v("",!0),(Ee=(ke=o(u))==null?void 0:ke.budgetTables)!=null&&Ee.$error?(r(),b("span",Pa,g((Te=(Se=(Ve=o(u))==null?void 0:Ve.budgetTables)==null?void 0:Se.$errors[0])==null?void 0:Te.$message),1)):v("",!0),n.value&&(($e=o(p))!=null&&$e.length)?(r(),E(da,{key:5,headers:je.value,table:qe.value,onOnActionDelete:la,isShowDelete:!0},null,8,["headers","table"])):v("",!0),n.value&&((Me=o(p))!=null&&Me.length)?(r(!0),b(q,{key:6},K(aa.value,a=>{var h,I,y,f,_;return r(),E(ia,{key:a.id,modelValue:l.value[a.model],"onUpdate:modelValue":C=>l.value[a.model]=C,modelModifiers:{trim:!0},width:500,placeholder:e.$t(a.placeholder),error:(I=(h=o(u))==null?void 0:h[a.errorKey])==null?void 0:I.$error,textError:(_=(f=(y=o(u))==null?void 0:y[a.errorKey])==null?void 0:f.$errors[0])==null?void 0:_.$message},{default:M(()=>[L(g(e.$t(a.label)),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","error","textError"])}),128)):v("",!0),n.value&&((Le=o(p))!=null&&Le.length)?(r(),E(na,{key:7,className:"manage__submit"},{default:M(()=>[L(g(e.$t("formButton")),1)]),_:1})):v("",!0)],32)])])):v("",!0)}}},Ja=ca(Ua,[["__scopeId","data-v-45212a77"]]);export{Ja as default};
//# sourceMappingURL=update-PRHRBHBz.js.map
